<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Lzh正在写代码</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="千里之行始于足下">
<meta property="og:type" content="website">
<meta property="og:title" content="Lzh正在写代码">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Lzh正在写代码">
<meta property="og:description" content="千里之行始于足下">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Lzh">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Lzh正在写代码" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
  
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.2.0/css/fork-awesome.min.css">

<meta name="generator" content="Hexo 7.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Lzh正在写代码</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"><span class="fa fa-bars"></span></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
        
          <a class="nav-icon" href="/atom.xml" title="RSS 订阅"><span class="fa fa-rss"></span></a>
        
        <a class="nav-icon nav-search-btn" title="搜索"><span class="fa fa-search"></span></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="搜索"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-WebSocket" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/03/28/WebSocket/" class="article-date">
  <time class="dt-published" datetime="2025-03-28T04:39:21.000Z" itemprop="datePublished">2025-03-28</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Web/">Web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/03/28/WebSocket/">WebSocket</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="一、-简介"><a href="#一、-简介" class="headerlink" title="一、  简介"></a>一、  简介</h3><h4 id="1-1-什么是WebSocket"><a href="#1-1-什么是WebSocket" class="headerlink" title="1.1 什么是WebSocket"></a>1.1 什么是WebSocket</h4><p>WebSocket是一种协议，用于在Web应用程序和服务器之间建立实时、<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=%E5%8F%8C%E5%90%91%E7%9A%84&spm=1001.2101.3001.7020">双向的</a>通信连接。它通过一个单一的TCP连接提供了持久化连接，这使得Web应用程序可以更加实时地传递数据。WebSocket协议最初由W3C开发，并于2011年成为标准。</p>
<h4 id="1-2-WebSocket的优势和劣势"><a href="#1-2-WebSocket的优势和劣势" class="headerlink" title="1.2 WebSocket的优势和劣势"></a>1.2 WebSocket的优势和劣势</h4><p><strong>WebSocket的优势包括：</strong></p>
<ul>
<li><strong>实时性：</strong> 由于WebSocket的持久化连接，它可以实现实时的数据传输，避免了Web应用程序需要不断地发送请求以获取最新数据的情况。</li>
<li><strong>双向通信：</strong> WebSocket协议支持双向通信，这意味着服务器可以主动向客户端发送数据，而不需要客户端发送请求。</li>
<li><strong>减少网络负载：</strong> 由于WebSocket的持久化连接，它可以减少HTTP请求的数量，从而减少了网络负载。</li>
</ul>
<p><strong>WebSocket的劣势包括：</strong></p>
<ul>
<li><strong>需要浏览器和服务器都支持：</strong> WebSocket是一种相对新的技术，需要浏览器和服务器都支持。一些旧的浏览器和服务器可能不支持WebSocket。</li>
<li><strong>需要额外的开销：</strong> WebSocket需要在服务器上维护长时间的连接，这需要额外的开销，包括内存和CPU。</li>
<li><strong>安全问题：</strong> 由于WebSocket允许服务器主动向客户端发送数据，可能会存在安全问题。服务器必须保证只向合法的客户端发送数据。</li>
</ul>
<h3 id="二、-WebSocket的基本概念"><a href="#二、-WebSocket的基本概念" class="headerlink" title="二、 WebSocket的基本概念"></a>二、 WebSocket的基本概念</h3><h4 id="2-1-WebSocket的协议"><a href="#2-1-WebSocket的协议" class="headerlink" title="2.1 WebSocket的协议"></a>2.1 WebSocket的协议</h4><p>[WebSocket 协议](<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=WebSocket">https://so.csdn.net/so/search?q=WebSocket</a> 协议&amp;spm&#x3D;1001.2101.3001.7020)是一种基于TCP的协议，用于在客户端和服务器之间建立持久连接，并且可以在这个连接上实时地交换数据。WebSocket协议有自己的握手协议，用于建立连接，也有自己的数据传输格式。</p>
<p>当客户端发送一个 WebSocket 请求时，服务器将发送一个协议响应以确认请求。在握手期间，客户端和服务器将协商使用的协议版本、支持的子协议、支持的扩展选项等。一旦握手完成，连接将保持打开状态，客户端和服务器就可以在连接上实时地传递数据。</p>
<p>WebSocket 协议使用的是双向数据传输，即客户端和服务器都可以在任意时间向对方发送数据，而不需要等待对方的请求。它支持二进制数据和文本数据，可以自由地在它们之间进行转换。</p>
<p>总之，WebSocket协议是一种可靠的、高效的、双向的、持久的通信协议，它适用于需要实时通信的Web应用程序，如在线游戏、实时聊天等。</p>
<h4 id="2-2-WebSocket的生命周期"><a href="#2-2-WebSocket的生命周期" class="headerlink" title="2.2 WebSocket的生命周期"></a>2.2 WebSocket的生命周期</h4><p>WebSocket 生命周期描述了 WebSocket 连接从创建到关闭的过程。一个 WebSocket 连接包含以下四个主要阶段：</p>
<ul>
<li><strong>连接建立阶段（Connection Establishment）：</strong> 在这个阶段，客户端和服务器之间的 WebSocket 连接被建立。客户端发送一个 WebSocket 握手请求，服务器响应一个握手响应，然后连接就被建立了。</li>
<li><strong>连接开放阶段（Connection Open）：</strong> 在这个阶段，WebSocket 连接已经建立并开放，客户端和服务器可以在连接上互相发送数据。</li>
<li><strong>连接关闭阶段（Connection Closing）：</strong> 在这个阶段，一个 WebSocket 连接即将被关闭。它可以被客户端或服务器发起，通过发送一个关闭帧来关闭连接。</li>
<li><strong>连接关闭完成阶段（Connection Closed）：</strong> 在这个阶段，WebSocket 连接已经完全关闭。客户端和服务器之间的任何交互都将无效。</li>
</ul>
<blockquote>
<p>“</p>
<p>需要注意的是，WebSocket 连接在任何时候都可能关闭，例如网络故障、服务器崩溃等情况都可能导致连接关闭。因此，需要及时处理 WebSocket 连接关闭的事件，以确保应用程序的可靠性和稳定性。</p>
</blockquote>
<p>下面是一个简单的 WebSocket 生命周期示意图：</p>
<p><img src="https://i-blog.csdnimg.cn/blog_migrate/52fc058e72b460c21aaabee1551d0a97.jpeg" alt="图片"></p>
<p>图片</p>
<p>在这个示意图中，客户端向服务器发送一个 WebSocket 握手请求，服务器响应一个握手响应，连接就被建立了。一旦连接建立，客户端和服务器就可以在连接上互相发送数据，直到其中一方发送一个关闭帧来关闭连接。在关闭帧被接收后，连接就会被关闭，WebSocket 连接关闭完成。</p>
<h4 id="2-3-WebSocket的消息格式"><a href="#2-3-WebSocket的消息格式" class="headerlink" title="2.3 WebSocket的消息格式"></a>2.3 WebSocket的消息格式</h4><p>WebSocket 的消息格式与 HTTP 请求和响应的消息格式有所不同。WebSocket 的消息格式可以是文本或二进制数据，并且 WebSocket 消息的传输是在一个已经建立的连接上进行的，因此不需要再进行 HTTP 请求和响应的握手操作。</p>
<p>WebSocket 消息格式由两个部分组成：消息头和消息体。</p>
<p>消息头包含以下信息：</p>
<ul>
<li><strong>FIN：</strong> 表示这是一条完整的消息，一般情况下都是1。</li>
<li><strong>RSV1、RSV2、RSV3：</strong> 暂时没有使用，一般都是0。</li>
<li><strong>Opcode：</strong> 表示消息的类型，包括文本消息、二进制消息等。</li>
<li><strong>Mask：</strong> 表示消息是否加密。</li>
<li><strong>Payload length：</strong> 表示消息体的长度。</li>
<li><strong>Masking key：</strong> 仅在消息需要加密时出现，用于对消息进行解密。</li>
</ul>
<p>消息体就是实际传输的数据，可以是文本或二进制数据。</p>
<h4 id="2-4-WebSocket的API"><a href="#2-4-WebSocket的API" class="headerlink" title="2.4 WebSocket的API"></a>2.4 WebSocket的API</h4><p>WebSocket API 是用于在 Web 应用程序中创建和管理 WebSocket 连接的接口集合。WebSocket API 由浏览器原生支持，无需使用额外的 JavaScript 库或框架，可以直接在 JavaScript 中使用。</p>
<p>下面是一些常用的 WebSocket API：</p>
<p><strong>WebSocket 构造函数：</strong> WebSocket 构造函数用于创建 WebSocket 对象。它接受一个 URL 作为参数，表示要连接的 WebSocket 服务器的地址。例如：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">&#x27;ws://example.com/ws&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p><strong>WebSocket.send() 方法：</strong> <code>WebSocket.send()</code> 方法用于向服务器发送数据。它接受一个参数，表示要发送的数据。数据可以是字符串、Blob 对象或 ArrayBuffer 对象。例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ws.send(&#x27;Hello, server!&#x27;);</span><br></pre></td></tr></table></figure>

<p><strong>WebSocket.onopen 事件：</strong> <code>WebSocket.onopen</code> 事件在 WebSocket 连接成功建立时触发。例如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ws.<span class="property">onopen</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;WebSocket 连接已经建立。&#x27;</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>WebSocket.onmessage 事件：</strong> <code>WebSocket.onmessage</code> 事件在接收到服务器发送的消息时触发。它的 event 对象包含一个 data 属性，表示接收到的数据。例如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ws.<span class="property">onmessage</span> = <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;收到服务器消息：&#x27;</span>, event.<span class="property">data</span>);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>WebSocket.onerror 事件：</strong> <code>WebSocket.onerror</code> 事件在 WebSocket 连接出现错误时触发。例如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ws.<span class="property">onerror</span> = <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;WebSocket 连接出现错误：&#x27;</span>, event);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><strong>WebSocket.onclose 事件：</strong> <code>WebSocket.onclose</code> 事件在 WebSocket 连接被关闭时触发。例如：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ws.onclose = function() &#123;</span><br><span class="line">  console.log(&#x27;WebSocket 连接已经关闭。&#x27;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>以上是一些常用的 WebSocket API。</p>
<h3 id="三、-在Java中使用WebSocket"><a href="#三、-在Java中使用WebSocket" class="headerlink" title="三、 在Java中使用WebSocket"></a>三、 在Java中使用WebSocket</h3><p>依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.websocket<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javax.websocket-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="3-1-使用Java-WebSocket-API编写WebSocket服务端"><a href="#3-1-使用Java-WebSocket-API编写WebSocket服务端" class="headerlink" title="3.1 使用Java WebSocket API编写WebSocket服务端"></a>3.1 使用Java WebSocket API编写WebSocket服务端</h4><p>下面是一个使用 Java WebSocket API 编写 WebSocket 服务端的示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.websocket.*;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerEndpoint;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ServerEndpoint(&quot;/echo&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EchoServer</span> &#123;</span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;WebSocket 连接已经建立。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, Session session)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;收到客户端消息：&quot;</span> + message);</span><br><span class="line">        session.getBasicRemote().sendText(<span class="string">&quot;服务器收到消息：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;WebSocket 连接已经关闭。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@OnError</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable t)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;WebSocket 连接出现错误：&quot;</span> + t.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个示例代码定义了一个名为 “echo” 的 WebSocket 端点，它会监听客户端发来的消息，并将收到的消息返回给客户端。具体来说，它使用了 <code>@ServerEndpoint</code> 注解来指定 WebSocket 端点的 URL，使用了 <code>@OnOpen</code>、<code>@OnMessage</code>、<code>@OnClose</code> 和 <code>@OnError</code> 注解来定义 WebSocket 事件处理器。</p>
<p>要使用这个 WebSocket 服务端，我们需要部署它到一个支持 WebSocket 的 Web 容器中。例如，我们可以使用 Tomcat 8 或以上版本来运行它。在部署完成后，我们可以使用任何支持 WebSocket 的客户端来连接这个服务端，发送消息并接收服务器的响应。</p>
<p>例如，下面是一个简单的 HTML&#x2F;JavaScript 客户端代码：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>WebSocket Demo<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">        <span class="keyword">var</span> ws = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(<span class="string">&#x27;ws://localhost:8080/echo&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        ws.<span class="property">onopen</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;WebSocket 连接已经建立。&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">            ws.<span class="title function_">send</span>(<span class="string">&#x27;Hello, server!&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;;</span></span><br><span class="line"><span class="language-javascript">        ws.<span class="property">onmessage</span> = <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;收到服务器消息：&#x27;</span>, event.<span class="property">data</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;;</span></span><br><span class="line"><span class="language-javascript">        ws.<span class="property">onerror</span> = <span class="keyword">function</span>(<span class="params">event</span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">error</span>(<span class="string">&#x27;WebSocket 连接出现错误：&#x27;</span>, event);</span></span><br><span class="line"><span class="language-javascript">        &#125;;</span></span><br><span class="line"><span class="language-javascript">        ws.<span class="property">onclose</span> = <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;WebSocket 连接已经关闭。&#x27;</span>);</span></span><br><span class="line"><span class="language-javascript">        &#125;;</span></span><br><span class="line"><span class="language-javascript">    </span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h1</span>&gt;</span>WebSocket Demo<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这个客户端使用了 WebSocket 构造函数来创建一个 WebSocket 对象，并指定连接的 URL 为我们之前部署的服务端的 URL。它使用了 WebSocket 的事件处理器来处理 WebSocket 事件，例如当 WebSocket 连接成功建立时，它会向服务器发送一条消息，并在收到服务器的响应时打印出消息内容。</p>
<h4 id="3-2-使用Java-WebSocket-API编写WebSocket客户端"><a href="#3-2-使用Java-WebSocket-API编写WebSocket客户端" class="headerlink" title="3.2 使用Java WebSocket API编写WebSocket客户端"></a>3.2 使用Java WebSocket API编写WebSocket客户端</h4><p>下面是一个使用 Java WebSocket API 编写 WebSocket 客户端的示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.websocket.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.URI;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ClientEndpoint</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EchoClient</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Session session;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;WebSocket 连接已经建立。&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.session = session;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, Session session)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;收到服务器消息：&quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;WebSocket 连接已经关闭。&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnError</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Throwable t)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;WebSocket 连接出现错误：&quot;</span> + t.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">connect</span><span class="params">(String url)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">WebSocketContainer</span> <span class="variable">container</span> <span class="operator">=</span> ContainerProvider.getWebSocketContainer();</span><br><span class="line">        container.connectToServer(<span class="built_in">this</span>, <span class="keyword">new</span> <span class="title class_">URI</span>(url));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">send</span><span class="params">(String message)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        session.getBasicRemote().sendText(message);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        session.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-3-使用Spring-Boot编写WebSocket服务端"><a href="#3-3-使用Spring-Boot编写WebSocket服务端" class="headerlink" title="3.3 使用Spring Boot编写WebSocket服务端"></a>3.3 使用Spring Boot编写WebSocket服务端</h4><h5 id="创建Spring-Boot项目"><a href="#创建Spring-Boot项目" class="headerlink" title="创建Spring Boot项目"></a>创建Spring Boot项目</h5><p>首先，您需要创建一个新的Spring Boot项目。可以使用Spring Initializr创建一个新项目，添加依赖项。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-websocket<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h5 id="配置WebSocket"><a href="#配置WebSocket" class="headerlink" title="配置WebSocket"></a>配置WebSocket</h5><p>应用程序中，需要配置WebSocket。创建一个新的Java类，并添加注释<code>@ServerEndpoint(&quot;/websocket&quot;)</code>。这将指定WebSocket服务端的端点。</p>
<p>在此类中，需要实现几个方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.websocket.OnClose;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.OnMessage;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.OnOpen;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.Session;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ServerEndpoint(&quot;/websocket&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> &#123;</span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Connection opened: &quot;</span> + session.getId());</span><br><span class="line">        sessions.add(session);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Session session, String message)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Received message: &quot;</span> + message);</span><br><span class="line">        session.getBasicRemote().sendText(<span class="string">&quot;Server received: &quot;</span> + message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">(Session session)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Connection closed: &quot;</span> + session.getId());</span><br><span class="line">        sessions.remove(session);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Set&lt;Session&gt; sessions = Collections.synchronizedSet(<span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;Session&gt;());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="处理WebSocket消息"><a href="#处理WebSocket消息" class="headerlink" title="处理WebSocket消息"></a>处理WebSocket消息</h5><p>在<code>@OnMessage</code>方法中，可以处理WebSocket客户端发送的消息，并向客户端发送响应。下面是一个简单的示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnMessage</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(Session session, String message)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Received message: &quot;</span> + message);</span><br><span class="line">    session.getBasicRemote().sendText(<span class="string">&quot;Server received: &quot;</span> + message);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在此代码中，我们简单地打印出收到的消息，并向客户端发送响应。</p>
<h5 id="关闭WebSocket连接"><a href="#关闭WebSocket连接" class="headerlink" title="关闭WebSocket连接"></a>关闭WebSocket连接</h5><p>在<code>@OnClose</code>方法中，可以删除连接并做一些清理工作。下面是一个示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnClose</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">(Session session)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Connection closed: &quot;</span> + session.getId());</span><br><span class="line">    sessions.remove(session);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在此代码中，我们从连接池中删除连接，并打印出连接已关闭的消息。</p>
<h5 id="配置WebSocket支持"><a href="#配置WebSocket支持" class="headerlink" title="配置WebSocket支持"></a>配置WebSocket支持</h5><p>最后，需要配置Spring Boot以支持WebSocket。创建一个新的Java类，并添加注释<code>@Configuration</code>和<code>@EnableWebSocket</code>。然后，需要覆盖方法<code>registerWebSocketHandlers()</code>，并指定WebSocket处理程序。下面是一个示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.config.annotation.EnableWebSocket;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.config.annotation.WebSocketConfigurer;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.config.annotation.WebSocketHandlerRegistry;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSocket</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketConfig</span> <span class="keyword">implements</span> <span class="title class_">WebSocketConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerWebSocketHandlers</span><span class="params">(WebSocketHandlerRegistry registry)</span> &#123;</span><br><span class="line">        registry.addHandler(<span class="keyword">new</span> <span class="title class_">WebSocketServer</span>(), <span class="string">&quot;/websocket&quot;</span>).setAllowedOrigins(<span class="string">&quot;*&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在此代码中，我们创建了一个新的<code>WebSocketServer</code>对象，并将其添加到WebSocket处理程序中。我们还指定了WebSocket端点（<code>/websocket</code>）和允许的来源（<code>*</code>）。</p>
<h3 id="四、-WebSocket的消息格式"><a href="#四、-WebSocket的消息格式" class="headerlink" title="四、 WebSocket的消息格式"></a>四、 WebSocket的消息格式</h3><h4 id="4-1-文本消息和二进制消息"><a href="#4-1-文本消息和二进制消息" class="headerlink" title="4.1 文本消息和二进制消息"></a>4.1 文本消息和二进制消息</h4><p>文本消息是普通的Unicode文本字符串。当WebSocket连接建立时，客户端和服务器可以通过发送文本消息来互相交换信息。服务器可以使用Session对象的<code>getBasicRemote()</code>方法来向客户端发送文本消息，客户端可以使用WebSocket的<code>send()</code>方法来向服务器发送文本消息。</p>
<p>下面是向客户端发送文本消息的示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.getBasicRemote().sendText(<span class="string">&quot;Hello, client!&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>二进制消息可以是任意类型的数据，包括图像、音频、视频等。要向客户端发送二进制消息，服务器可以使用Session对象的<code>getBasicRemote()</code>方法，将消息作为ByteBuffer对象发送。客户端可以使用WebSocket的send()方法来向服务器发送二进制消息。</p>
<p>下面是向客户端发送二进制消息的示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">byte</span>[] data = <span class="comment">// binary data</span></span><br><span class="line"><span class="type">ByteBuffer</span> <span class="variable">buffer</span> <span class="operator">=</span> ByteBuffer.wrap(data);</span><br><span class="line">session.getBasicRemote().sendBinary(buffer);</span><br></pre></td></tr></table></figure>

<p>请注意，尽管文本消息和二进制消息在格式上有所不同，但它们都是通过WebSocket发送的消息类型，因此客户端和服务器都需要能够处理这两种类型的消息。</p>
<h4 id="4-2-Ping和Pong消息"><a href="#4-2-Ping和Pong消息" class="headerlink" title="4.2 Ping和Pong消息"></a>4.2 Ping和Pong消息</h4><p>WebSocket还支持Ping和Pong消息类型，用于检测WebSocket连接是否仍然处于活动状态。Ping消息由客户端发送到服务器，Pong消息由服务器发送回客户端作为响应。如果客户端在一段时间内没有收到Pong消息，则它可以假定WebSocket连接已断开，并关闭连接。</p>
<p>要发送Ping消息，请使用Session对象的<code>getBasicRemote()</code>方法，并将Ping消息作为ByteBuffer对象发送。客户端可以使用WebSocket的<code>sendPing()</code>方法来向服务器发送Ping消息。</p>
<p>下面是向客户端发送Ping消息的示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ByteBuffer</span> <span class="variable">pingMessage</span> <span class="operator">=</span> ByteBuffer.wrap(<span class="keyword">new</span> <span class="title class_">byte</span>[] &#123; <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span> &#125;);</span><br><span class="line">session.getBasicRemote().sendPing(pingMessage);</span><br></pre></td></tr></table></figure>

<p>要接收Pong消息，请在您的WebSocket处理程序中实现<code>onPong()</code>方法。当您的WebSocket服务器接收到Pong消息时，它将自动调用此方法，并将接收到的Pong消息作为ByteBuffer对象传递给它。</p>
<p>下面是实现onPong()方法的示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnMessage</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPong</span><span class="params">(Session session, ByteBuffer pongMessage)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Received Pong message: &quot;</span> + pongMessage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请注意，Ping和Pong消息通常用于WebSocket连接的健康检查。如果您希望在WebSocket连接中使用此功能，则应定期发送Ping消息并等待Pong消息的响应。</p>
<h4 id="4-3-关闭消息"><a href="#4-3-关闭消息" class="headerlink" title="4.3 关闭消息"></a>4.3 关闭消息</h4><p>WebSocket还支持关闭消息类型，用于关闭WebSocket连接。关闭消息可以由客户端或服务器发起，并且可以携带一个可选的状态码和关闭原因。当WebSocket连接关闭时，客户端和服务器都应该发送一个关闭消息以结束连接。</p>
<p>要发送关闭消息，请使用Session对象的<code>getBasicRemote()</code>方法，并调用它的<code>sendClose()</code>方法。关闭消息可以携带一个可选的状态码和关闭原因。如果您不希望发送状态码或关闭原因，则可以将它们设置为0和null。</p>
<p>下面是向客户端发送关闭消息的示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">session.close(<span class="keyword">new</span> <span class="title class_">CloseReason</span>(CloseReason.CloseCodes.NORMAL_CLOSURE, <span class="string">&quot;Closing from client.&quot;</span>));</span><br></pre></td></tr></table></figure>

<p>要处理接收到的关闭消息，请在您的WebSocket处理程序中实现<code>onClose()</code>方法。当您的WebSocket服务器接收到关闭消息时，它将自动调用此方法，并将接收到的状态码和关闭原因传递给它。</p>
<p>下面是实现<code>onClose()</code>方法的示例代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnClose</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">(Session session, CloseReason closeReason)</span> &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;Connection closed: &quot;</span> + closeReason.getCloseCode() + <span class="string">&quot; - &quot;</span> + closeReason.getReasonPhrase());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>请注意，客户端和服务器都应该发送关闭消息以结束WebSocket连接。如果只有一方发送了关闭消息，则另一方可能无法正确地关闭连接，并且可能需要等待超时才能释放资源。建议客户端和服务器在关闭连接时都发送关闭消息，以确保连接正确地关闭。</p>
<h3 id="五、-WebSocket的性能"><a href="#五、-WebSocket的性能" class="headerlink" title="五、 WebSocket的性能"></a>五、 WebSocket的性能</h3><h4 id="5-1-与传统的HTTP请求-响应模型比较"><a href="#5-1-与传统的HTTP请求-响应模型比较" class="headerlink" title="5.1 与传统的HTTP请求&#x2F;响应模型比较"></a>5.1 与传统的HTTP请求&#x2F;响应模型比较</h4><ul>
<li><strong>双向通信性能更好：</strong> WebSocket协议使用单一的TCP连接，允许客户端和服务器在同一个连接上进行双向通信。这种实时的双向通信可以更快地传输数据，而不需要建立多个HTTP请求&#x2F;响应连接。</li>
<li><strong>更小的网络流量：</strong> 与HTTP相比，WebSocket协议需要更少的网络流量来维护连接，因为它不需要在每个请求&#x2F;响应交换中发送头部信息。</li>
<li><strong>更低的延迟：</strong> WebSocket协议允许服务器主动向客户端推送消息，而不需要客户端先发送请求。这种实时通信可以减少响应延迟，并提高应用程序的性能。</li>
<li><strong>更好的服务器资源管理：</strong> 由于WebSocket连接可以保持活动状态，服务器可以更好地管理客户端连接，减少服务器开销和处理时间。</li>
</ul>
<p>WebSocket协议的性能比传统的HTTP请求&#x2F;响应模型更好，特别是在实时通信和低延迟方面。WebSocket协议适用于需要实时通信和实时数据更新的应用程序，如在线聊天、多人游戏、实时监控等。</p>
<h4 id="5-2-优化WebSocket的性能"><a href="#5-2-优化WebSocket的性能" class="headerlink" title="5.2 优化WebSocket的性能"></a>5.2 优化WebSocket的性能</h4><ul>
<li><strong>减少消息大小：</strong> WebSocket 传输的数据大小对性能有很大影响。尽量减少消息的大小，可以降低网络带宽和服务器负载。例如，可以使用二进制传输协议来代替文本传输，或使用压缩算法对消息进行压缩。</li>
<li><strong>使用CDN加速：</strong> 使用 CDN（内容分发网络）可以将静态资源缓存到离用户更近的节点上，提高传输速度和性能。CDN 可以缓存 Websocket 的初始握手请求，避免不必要的网络延迟。</li>
<li><strong>使用负载均衡：</strong> WebSocket 服务可以使用负载均衡来分配并平衡多个服务器的负载。负载均衡可以避免单个服务器被过载，并提高整个服务的可伸缩性。</li>
<li><strong>优化服务端代码：</strong> WebSocket 服务端代码的性能也是关键因素。使用高效的框架和算法，避免使用过多的内存和 CPU 资源，可以提高服务端的性能和响应速度。</li>
<li><strong>避免网络阻塞：</strong> WebSocket 的性能也会受到网络阻塞的影响。当有太多的连接同时请求数据时，服务器的性能会下降。使用合适的线程池和异步 IO 操作可以避免网络阻塞，提高 WebSocket 服务的并发性能。</li>
</ul>
<h3 id="六、-WebSocket的扩展应用和未来发展方向"><a href="#六、-WebSocket的扩展应用和未来发展方向" class="headerlink" title="六、 WebSocket的扩展应用和未来发展方向"></a>六、 WebSocket的扩展应用和未来发展方向</h3><ul>
<li><strong>更加完善的标准规范：</strong> WebSocket 标准规范还有很多可以优化的地方，未来可能会继续完善 WebSocket 的标准规范，以适应更加复杂的应用场景。</li>
<li><strong>更加安全的通信方式：</strong> 由于 WebSocket 的开放性，使得它可能会受到一些安全威胁，未来可能会通过加密、身份验证等方式来增强 WebSocket 的安全性。</li>
<li><strong>更好的兼容性：</strong> WebSocket 协议需要在 HTTP 协议的基础上建立连接，因此可能会遇到兼容性问题，未来可能会通过技术手段来解决这些问题。</li>
<li><strong>更好的性能和可伸缩性：</strong> WebSocket 协议的性能和可伸缩性对于复杂的应用场景非常关键，未来可能会通过技术手段来进一步提高 WebSocket 的性能和可伸缩性。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/03/28/WebSocket/" data-id="cm8sja97v003z8ktbew81e05p" data-title="WebSocket" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Web/" rel="tag">Web</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Docker安装" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/03/15/Docker%E5%AE%89%E8%A3%85/" class="article-date">
  <time class="dt-published" datetime="2025-03-15T13:44:11.000Z" itemprop="datePublished">2025-03-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Docker/">Docker</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/03/15/Docker%E5%AE%89%E8%A3%85/">Docker安装</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ol>
<li><h2 id="附录：Docker安装"><a href="#附录：Docker安装" class="headerlink" title="附录：Docker安装"></a>附录：Docker安装</h2></li>
<li><h3 id="卸载旧版"><a href="#卸载旧版" class="headerlink" title="卸载旧版"></a>卸载旧版</h3></li>
</ol>
<p>首先如果系统中已经存在旧的Docker，则先卸载：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">yum remove docker \</span><br><span class="line">    docker-client \</span><br><span class="line">    docker-client-latest \</span><br><span class="line">    docker-common \</span><br><span class="line">    docker-latest \</span><br><span class="line">    docker-latest-logrotate \</span><br><span class="line">    docker-logrotate \</span><br><span class="line">    docker-engine \</span><br><span class="line">    docker-selinux </span><br></pre></td></tr></table></figure>

<ol>
<li><h3 id="配置Docker的yum库"><a href="#配置Docker的yum库" class="headerlink" title="配置Docker的yum库"></a>配置Docker的yum库</h3></li>
</ol>
<p>首先要安装一个yum工具</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum install -y yum-utils device-mapper-persistent-data lvm2</span><br></pre></td></tr></table></figure>

<p>安装成功后，执行命令，配置Docker的yum源（已更新为阿里云源）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> sed -i <span class="string">&#x27;s+download.docker.com+mirrors.aliyun.com/docker-ce+&#x27;</span> /etc/yum.repos.d/docker-ce.repo</span><br></pre></td></tr></table></figure>

<p>更新yum，建立缓存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum makecache fast</span><br></pre></td></tr></table></figure>

<ol>
<li><h3 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h3></li>
</ol>
<p>最后，执行命令，安装Docker</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br></pre></td></tr></table></figure>

<ol>
<li><h3 id="启动和校验"><a href="#启动和校验" class="headerlink" title="启动和校验"></a>启动和校验</h3></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动Docker</span></span><br><span class="line">systemctl start docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止Docker</span></span><br><span class="line">systemctl stop docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启</span></span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置开机自启</span></span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行docker ps命令，如果不报错，说明安装启动成功</span></span><br><span class="line">docker ps</span><br></pre></td></tr></table></figure>

<ol>
<li><h3 id="配置镜像加速"><a href="#配置镜像加速" class="headerlink" title="配置镜像加速"></a>配置镜像加速</h3></li>
</ol>
<p>镜像地址可能会变更，如果失效可以百度找最新的docker镜像。</p>
<p>配置镜像步骤如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line"><span class="built_in">rm</span> -f /etc/docker/daemon.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制内容</span></span><br><span class="line"><span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;http://hub-mirror.c.163.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://mirrors.tuna.tsinghua.edu.cn&quot;</span>,</span><br><span class="line">        <span class="string">&quot;http://mirrors.sohu.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://ustc-edu-cn.mirror.aliyuncs.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://ccr.ccs.tencentyun.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.awsl9527.cn&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新加载配置</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启Docker</span></span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/03/15/Docker%E5%AE%89%E8%A3%85/" data-id="cm8sja97100018ktb7cbydxlr" data-title="Docker安装" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Docker项目部署" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/03/15/Docker%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2/" class="article-date">
  <time class="dt-published" datetime="2025-03-15T13:44:04.000Z" itemprop="datePublished">2025-03-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Docker/">Docker</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/03/15/Docker%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2/">Docker项目部署</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ol>
<li><h2 id="项目部署"><a href="#项目部署" class="headerlink" title="项目部署"></a>项目部署</h2></li>
<li><h3 id="部署服务端"><a href="#部署服务端" class="headerlink" title="部署服务端"></a>部署服务端</h3></li>
</ol>
<ul>
<li>需求：将我们开发的 tlias-web-management 项目打包为镜像，并部署。</li>
<li>步骤：<ul>
<li>修改项目的配置文件，修改数据库服务地址（打包package）。</li>
<li>编写Dockerfile文件（AI辅助）。</li>
<li>构建Docker镜像，部署Docker容器，运行测试。</li>
</ul>
</li>
</ul>
<p><strong>1). 修改项目的配置文件，修改数据库服务地址（打包package）。</strong></p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=ZDNlYmE3MWVhOTY3Y2IyYmZjMGFkODVlZjM2MWVhOGZfaUlsY1NGNHZ1Z29XdWhjUjNaaVJmSEN5dHJxRG1WcVBfVG9rZW46Q3RSUWJYalFwb3Zxdlp4V0p1c2M1d0ptbnNQXzE3NDIwNDY1NzA6MTc0MjA1MDE3MF9WNA" alt="img"></p>
<p>然后，执行maven中的package生命周期，进行打包(<strong>跳过测试</strong>)，并将打包后的jar包命名为 tlias.jar 。</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=M2JhNDMyMWJiY2Q4MTczNWJhNzA1YTA1YjkwNDhiNmFfVWFOeG9keXVPS05sYXlJd053eTV1MTZITU9FMFZFV3BfVG9rZW46VzlScmJJU1pYb25nZm94QTJ0TGMzWHZmbmZRXzE3NDIwNDY1NzA6MTc0MjA1MDE3MF9WNA" alt="img"></p>
<p><strong>2). 编写Dockerfile文件<strong><strong>（AI辅助）</strong></strong>。</strong></p>
<p>文件名 Dockerfile: </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 CentOS 7 作为基础镜像</span></span><br><span class="line">FROM centos:<span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加 JDK 到镜像中</span></span><br><span class="line"><span class="built_in">COPY</span> jdk17.tar.gz /usr/local/</span><br><span class="line">RUN tar <span class="literal">-xzf</span> /usr/local/jdk17.tar.gz <span class="literal">-C</span> /usr/local/ &amp;&amp;  <span class="built_in">rm</span> /usr/local/jdk17.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line">ENV JAVA_HOME=/usr/local/jdk<span class="literal">-17</span>.<span class="number">0.10</span></span><br><span class="line">ENV PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 阿里云OSS环境变量</span></span><br><span class="line">ENV OSS_ACCESS_KEY_ID=******</span><br><span class="line">ENV OSS_ACCESS_KEY_SECRET=******</span><br><span class="line"></span><br><span class="line"><span class="comment">#统一编码</span></span><br><span class="line">ENV LANG=en_US.UTF<span class="literal">-8</span></span><br><span class="line">ENV LANGUAGE=en_US:en</span><br><span class="line">ENV LC_ALL=en_US.UTF<span class="literal">-8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建应用目录</span></span><br><span class="line">RUN mkdir <span class="literal">-p</span> /tlias</span><br><span class="line">WORKDIR /tlias</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制应用 JAR 文件到容器</span></span><br><span class="line"><span class="built_in">COPY</span>  tlias.jar  tlias.jar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露端口</span></span><br><span class="line">EXPOSE <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行命令</span></span><br><span class="line">ENTRYPOINT [<span class="string">&quot;java&quot;</span>,<span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;/tlias/tlias.jar&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>由于项目要运行，需要依赖jdk的环境，所以这里我们需要将tlias.jar，jdk17.tar.gz，Dockerfile三个文件，上传到Linux服务器的 &#x2F;root&#x2F;tlias 目录下（如果没有这个目录，提前创建好）。</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjlhNTVkYTUzYjRiMWQ5ZmUxMjZlYWVhZDBlZTg0NTZfSzNUVzhiWkJ6M1BkUGxjekFhNVBMeHR5MTk4Y0ZnOEJfVG9rZW46U1lXVGJwd0RTbzhEbm54aUNrd2NFQzZ5bkVmXzE3NDIwNDY1NzA6MTc0MjA1MDE3MF9WNA" alt="img"></p>
<p><strong>3). 构建Docker镜像，部署Docker容器，运行测试。</strong></p>
<ul>
<li>构建Docker镜像</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build <span class="literal">-t</span> tlias:<span class="number">1.0</span> .</span><br></pre></td></tr></table></figure>

<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTUzMzQ2YjcwMDViNGI0ZDZkZWFmZWZiOWQ1OWQ4MGVfYWVsTmtta0RndHMxZVhwVHdlZ1FOQThleEpqTkZvREVfVG9rZW46SzR2RGJUWHFGb2RRMkh4Qnl0QWMzZTRCbk1jXzE3NDIwNDY1NzA6MTc0MjA1MDE3MF9WNA" alt="img"></p>
<ul>
<li>部署Docker容器</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> <span class="literal">--name</span> tlias<span class="literal">-server</span> <span class="literal">--network</span> itheima <span class="literal">-p</span> <span class="number">8080</span>:<span class="number">8080</span>  tlias:<span class="number">1.0</span></span><br></pre></td></tr></table></figure>

<p>–network  itheima ：将创建的容器，加入到itheima网络，就可以和itheima网络中的容器通信了。</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=NDU1MTg0YTNlOTllMjA4NjE0YjA1NzZmNDJjMmRhNmVfZE50TlE1ekVaSzBpQ1J4dkEzM2Ixb054ZnJYS2NBV2ZfVG9rZW46RnpJQmJGYVlSb3FYV3J4VkpYQmNFdWR1blJlXzE3NDIwNDY1NzA6MTc0MjA1MDE3MF9WNA" alt="img"></p>
<p>通过 <code>docker logs -f 容器名</code>，就可以查看容器的运行日志。</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=NzU4NjE4YTY3ZTMxMWFjMzk4ZjEwYTAwNjJhOWY0YTlfOEY2cDNrMlVUaTdYTEZ5cXRwSDBoSlBTcDJ0YkZ4ekJfVG9rZW46SnZCZGJNTTlSb05pY3B4NEh4eGN2M1Vkbk5mXzE3NDIwNDY1NzA6MTc0MjA1MDE3MF9WNA" alt="img"></p>
<p>这样后端服务，就已经启动起来了。</p>
<ol>
<li><h3 id="部署前端"><a href="#部署前端" class="headerlink" title="部署前端"></a>部署前端</h3></li>
</ol>
<ul>
<li>需求：创建一个新的nginx容器，将资料中提供的前端项目的静态资源部署到nginx中。</li>
<li>步骤：<ul>
<li>在宿主机上准备静态文件及配置文件存放目录(在 <code>/usr/local</code> 目录下创建 <code>tlias-web</code> 目录)。<ul>
<li><p><code>-v /usr/local/tlias-web/html:/usr/share/nginx/html</code> </p>
</li>
<li><p><code>-v /usr/local/tlias-web/conf/nginx.conf:/etc/nginx/nginx.conf</code></p>
</li>
</ul>
</li>
<li>部署nginx容器</li>
</ul>
</li>
</ul>
<p><strong>1). 部署nginx容器（设置目录映射）。</strong></p>
<ul>
<li>将资 <strong>资料&#x2F;04. 项目部署&#x2F;前端项目</strong> 中的 目录<code>html</code>和 配置文件存放目录 <code>conf</code>，上传至服务器端的 <code>/usr/local/tlias-web</code>目录下。</li>
</ul>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=MjcyMTcxMTc0ZmE4ZmQwYWRlMWZmY2MxNmQzOWY0NzlfUGNVM1VieVlhVGQ0dUhLOENmbU5TVTFLcHN5QWwyT09fVG9rZW46QXVaV2JSU2ZMb1c2dXB4REJwN2NjTkdtbmFoXzE3NDIwNDY1NzA6MTc0MjA1MDE3MF9WNA" alt="img"></p>
<ul>
<li>执行如下命令，部署nginx容器</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line"><span class="literal">--name</span> nginx<span class="literal">-tlias</span> \</span><br><span class="line"><span class="literal">-v</span> /usr/local/tlias<span class="literal">-web</span>/html:/usr/share/nginx/html \</span><br><span class="line"><span class="literal">-v</span> /usr/local/tlias<span class="literal">-web</span>/conf/nginx.conf:/etc/nginx/nginx.conf \</span><br><span class="line"><span class="literal">--network</span> itheima \</span><br><span class="line"><span class="literal">-p</span> <span class="number">80</span>:<span class="number">80</span> \</span><br><span class="line">nginx:<span class="number">1.20</span>.<span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>前后端都部署完毕后，就可以打开浏览器，来测试一下。访问前端的nginx服务器 。</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=ZjUzNGE3MGExZjYzY2YwYzE3OWFkZjg2NGQxNzlhYTZfRVFxSHNiUXlrUFRqRlgwN0d0M1kxbmlEQ2JQTFVsSWhfVG9rZW46SUpyYWJTN1Nyb0laNGp4dTlzZ2NPNXRUbkVmXzE3NDIwNDY1NzA6MTc0MjA1MDE3MF9WNA" alt="img"></p>
<ol>
<li><h3 id="DockerCompose"><a href="#DockerCompose" class="headerlink" title="DockerCompose"></a>DockerCompose</h3></li>
</ol>
<p>大家可以看到，我们部署一个简单的java项目，其中包含3个容器：</p>
<ul>
<li>MySQL</li>
<li>Nginx</li>
<li>Java项目</li>
</ul>
<p>而稍微复杂的项目，其中还会有各种各样的其它中间件，需要部署的东西远不止3个。如果还像之前那样手动的逐一部署，就太麻烦了。</p>
<p>而Docker Compose就可以帮助我们实现<strong>多个相互关联的Docker容器的快速部署</strong>。它允许用户通过一个单独的 docker-compose.yml 模板文件（YAML 格式）来定义一组相关联的应用容器。</p>
<ol>
<li><h4 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h4></li>
</ol>
<p>docker-compose文件中可以定义多个相互关联的应用容器，每一个应用容器被称为一个服务（service）。由于service就是在定义某个应用的运行时参数，因此与<code>docker run</code>参数非常相似。</p>
<p>举例来说，用docker run部署MySQL的命令如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line"><span class="literal">--name</span> nginx<span class="literal">-tlias</span> \</span><br><span class="line"><span class="literal">-p</span> <span class="number">80</span>:<span class="number">80</span> \</span><br><span class="line"><span class="literal">-v</span> /usr/local/app/html:/usr/share/nginx/html \</span><br><span class="line"><span class="literal">-v</span> /usr/local/app/conf/nginx.conf:/etc/nginx/nginx.conf \  </span><br><span class="line"><span class="literal">--network</span> itheima \</span><br><span class="line">nginx:<span class="number">1.20</span>.<span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>如果用<code>docker-compose.yml</code>文件来定义，就是这样：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;nginx:1.20.2&quot;</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx-tlias</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/html:/usr/share/nginx/html&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/conf/nginx.conf:/etc/nginx/nginx.conf&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">itheima</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">itheima:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">itheima</span></span><br></pre></td></tr></table></figure>

<p>对比如下：</p>
<table>
<thead>
<tr>
<th align="left"><strong>docker run 参数</strong></th>
<th align="left"><strong>docker compose 指令</strong></th>
<th align="left"><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">–name</td>
<td align="left">container_name</td>
<td align="left">容器名称</td>
</tr>
<tr>
<td align="left">-p</td>
<td align="left">ports</td>
<td align="left">端口映射</td>
</tr>
<tr>
<td align="left">-e</td>
<td align="left">environment</td>
<td align="left">环境变量</td>
</tr>
<tr>
<td align="left">-v</td>
<td align="left">volumes</td>
<td align="left">数据卷配置</td>
</tr>
<tr>
<td align="left">–network</td>
<td align="left">networks</td>
<td align="left">网络</td>
</tr>
</tbody></table>
<p>明白了其中的对应关系，相信编写<code>docker-compose</code>文件应该难不倒大家。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3307:3306&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="number">123</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/mysql/conf:/etc/mysql/conf.d&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/mysql/data:/var/lib/mysql&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/mysql/init:/docker-entrypoint-initdb.d&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tlias-net</span></span><br><span class="line">  <span class="attr">tlias:</span></span><br><span class="line">    <span class="attr">build:</span> </span><br><span class="line">      <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">tlias-server</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tlias-net</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.20.2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/nginx/conf/nginx.conf:/etc/nginx/nginx.conf&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/nginx/html:/usr/share/nginx/html&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tlias</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tlias-net</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">tlias-net:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">itheima</span></span><br></pre></td></tr></table></figure>

<ol>
<li><h4 id="基础命令"><a href="#基础命令" class="headerlink" title="基础命令"></a>基础命令</h4></li>
</ol>
<p>编写好docker-compose.yml文件，就可以部署项目了。语法如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">docker</span> <span class="string">compose</span> [<span class="string">OPTIONS</span>] [<span class="string">COMMAND</span>]</span><br></pre></td></tr></table></figure>

<p>其中，OPTIONS和COMMAND都是可选参数，比较常见的有：</p>
<table>
<thead>
<tr>
<th align="left"><strong>类型</strong></th>
<th align="left"><strong>参数或指令</strong></th>
<th align="left"><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">Options</td>
<td align="left">-f</td>
<td align="left">指定compose文件的路径和名称</td>
</tr>
<tr>
<td align="left">-p</td>
<td align="left">指定project名称。project就是当前compose文件中设置的多个service的集合，是逻辑概念</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Commands</td>
<td align="left">up</td>
<td align="left">创建并启动所有service容器</td>
</tr>
<tr>
<td align="left">down</td>
<td align="left">停止并移除所有容器、网络</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">ps</td>
<td align="left">列出所有启动的容器</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">logs</td>
<td align="left">查看指定容器的日志</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">stop</td>
<td align="left">停止容器</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">start</td>
<td align="left">启动容器</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">restart</td>
<td align="left">重启容器</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">top</td>
<td align="left">查看运行的进程</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">exec</td>
<td align="left">在指定的运行中容器中执行命令</td>
<td align="left"></td>
</tr>
</tbody></table>
<ol>
<li><h4 id="操作演示"><a href="#操作演示" class="headerlink" title="操作演示"></a>操作演示</h4></li>
</ol>
<p>1). 在 Linux 服务器的 <code>/usr/local</code> 目录下创建目录 app，并切换到 <code>/usr/local/app</code> 目录。</p>
<p>2). 上传资料中提供的 “资料&#x2F;05. Docker Compose” 中的文件及文件夹到 <code>/usr/local/app</code> 目录中，如下所示：</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=Yzg5Y2NhMTVlM2VkNWYzMTBkNjdiMmUyOTI0NzdiODJfYnQxODdRQ2QxSjZvWm1OWkZCalpNUDkzT203empnTWdfVG9rZW46T2VFMWJ3bmtEb3d0eld4RVBGTWN3NmhJbjRnXzE3NDIwNDY1NzA6MTc0MjA1MDE3MF9WNA" alt="img"></p>
<p>注意，资料中提供的Dockerfile文件中的阿里云OSS的 AccessKeyId，AccessKeySecret需要替换成自己的。</p>
<p>3). 执行如下指令，基于DockerCompose部署项目。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">docker</span> <span class="string">compose</span> <span class="string">up</span> <span class="string">-d</span></span><br></pre></td></tr></table></figure>

<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=ODk5NDg3Y2NmN2FhMTZlOTYyN2RmODhjMTg1OWI1MTlfbGIxQnpoVFhqYXVQeG1SQ2hxUDZTQnFMTWFhVHdiOElfVG9rZW46Tm45ZmJHUVB6b0xiR2N4MWRvOGMyblU4bnViXzE3NDIwNDY1NzA6MTc0MjA1MDE3MF9WNA" alt="img"></p>
<p>项目启动完毕之后，就可以启动服务器测试喽 。</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=OTI4ZDUyNWUwMjFiMTAzY2EzMzZjMDY4NGJhYzQ0YTlfMXFzQmVNcE5KVzhqQ2RMQTNGNU10alRGRFdkRXh5MWJfVG9rZW46WTFQamJpdVo2b2RjMmN4eW15UWNGMUE1bkNlXzE3NDIwNDY1NzA6MTc0MjA1MDE3MF9WNA" alt="img"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/03/15/Docker%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2/" data-id="cm8sja97400058ktbbog439vm" data-title="Docker项目部署" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Docker基础" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/03/15/Docker%E5%9F%BA%E7%A1%80/" class="article-date">
  <time class="dt-published" datetime="2025-03-15T13:43:57.000Z" itemprop="datePublished">2025-03-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Docker/">Docker</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/03/15/Docker%E5%9F%BA%E7%A1%80/">Docker基础</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ol>
<li><h2 id="Docker基础"><a href="#Docker基础" class="headerlink" title="Docker基础"></a>Docker基础</h2></li>
</ol>
<p>接下来，我们一起来学习Docker使用的一些基础知识，为将来部署项目打下基础。</p>
<ol>
<li><h3 id="常见命令"><a href="#常见命令" class="headerlink" title="常见命令"></a>常见命令</h3></li>
<li><h4 id="命令介绍"><a href="#命令介绍" class="headerlink" title="命令介绍"></a>命令介绍</h4></li>
</ol>
<p>其中，比较常见的命令有：</p>
<table>
<thead>
<tr>
<th align="left"><strong>命令</strong></th>
<th align="left"><strong>说明</strong></th>
<th align="left"><strong>文档地址</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">docker pull</td>
<td align="left">拉取镜像</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/pull/">docker pull</a></td>
</tr>
<tr>
<td align="left">docker push</td>
<td align="left">推送镜像到DockerRegistry</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/push/">docker push</a></td>
</tr>
<tr>
<td align="left">docker images</td>
<td align="left">查看本地镜像</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/images/">docker images</a></td>
</tr>
<tr>
<td align="left">docker rmi</td>
<td align="left">删除本地镜像</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/rmi/">docker rmi</a></td>
</tr>
<tr>
<td align="left">docker run</td>
<td align="left">创建并运行容器（不能重复创建）</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/run/">docker run</a></td>
</tr>
<tr>
<td align="left">docker stop</td>
<td align="left">停止指定容器</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/stop/">docker stop</a></td>
</tr>
<tr>
<td align="left">docker start</td>
<td align="left">启动指定容器</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/start/">docker start</a></td>
</tr>
<tr>
<td align="left">docker restart</td>
<td align="left">重新启动容器</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/restart/">docker restart</a></td>
</tr>
<tr>
<td align="left">docker rm</td>
<td align="left">删除指定容器</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/rm/">docs.docker.com</a></td>
</tr>
<tr>
<td align="left">docker ps</td>
<td align="left">查看容器</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/ps/">docker ps</a></td>
</tr>
<tr>
<td align="left">docker logs</td>
<td align="left">查看容器运行日志</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/logs/">docker logs</a></td>
</tr>
<tr>
<td align="left">docker exec</td>
<td align="left">进入容器</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/exec/">docker exec</a></td>
</tr>
<tr>
<td align="left">docker save</td>
<td align="left">保存镜像到本地压缩文件</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/save/">docker save</a></td>
</tr>
<tr>
<td align="left">docker load</td>
<td align="left">加载本地压缩文件到镜像</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/load/">docker load</a></td>
</tr>
<tr>
<td align="left">docker inspect</td>
<td align="left">查看容器详细信息</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/inspect/">docker inspect</a></td>
</tr>
</tbody></table>
<p>用一副图来表示这些命令的关系：</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=MDJkMDE2M2Q3ZjU5ODU3NDA2ZWE1ZTM1ODQwNTBmODBfQWhxTHBPMzltcnBQOURmYnJLemNNRWdwVXlqRWhqVjZfVG9rZW46UGxsRmJqbURLb0RuZnZ4YXc1emNxT2ZUbmJmXzE3NDIwNDY1MDA6MTc0MjA1MDEwMF9WNA" alt="img"></p>
<p><strong>补充：</strong></p>
<p>默认情况下，每次重启虚拟机我们都需要手动启动Docker和Docker中的容器。通过命令可以实现开机自启：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Docker开机自启</span></span><br><span class="line">systemctl enable docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># Docker容器开机自启</span></span><br><span class="line">docker update <span class="literal">--restart</span>=always [容器名/容器<span class="type">id</span>]</span><br></pre></td></tr></table></figure>

<ol>
<li><h4 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h4></li>
</ol>
<p>我们以Nginx为例给大家演示上述命令。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第1步，去DockerHub查看nginx镜像仓库及相关信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第2步，拉取Nginx镜像 (比较耗时)</span></span><br><span class="line">docker pull nginx:<span class="number">1.20</span>.<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第3步，查看镜像</span></span><br><span class="line">docker images</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第4步，创建并允许Nginx容器</span></span><br><span class="line">docker run <span class="literal">-d</span> <span class="literal">--name</span> nginx <span class="literal">-p</span> <span class="number">80</span>:<span class="number">80</span> nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第5步，查看运行中容器</span></span><br><span class="line">docker <span class="built_in">ps</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以加格式化方式访问，格式会更加清爽</span></span><br><span class="line">docker <span class="built_in">ps</span> <span class="literal">--format</span> <span class="string">&quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Image&#125;&#125;\t&#123;&#123;.Ports&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.Names&#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第6步，访问网页，地址：http://虚拟机地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第7步，停止容器</span></span><br><span class="line">docker stop nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第8步，查看所有容器</span></span><br><span class="line">docker <span class="built_in">ps</span> <span class="literal">-a</span> <span class="literal">--format</span> <span class="string">&quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Image&#125;&#125;\t&#123;&#123;.Ports&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.Names&#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第9步，再次启动nginx容器</span></span><br><span class="line">docker <span class="built_in">start</span> nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第10步，再次查看容器</span></span><br><span class="line">docker <span class="built_in">ps</span> <span class="literal">--format</span> <span class="string">&quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Image&#125;&#125;\t&#123;&#123;.Ports&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.Names&#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第11步，查看容器详细信息</span></span><br><span class="line">docker inspect nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第12步，进入容器,查看容器内目录</span></span><br><span class="line">docker exec <span class="literal">-it</span> nginx bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者，可以进入MySQL</span></span><br><span class="line">docker exec <span class="literal">-it</span> mysql mysql <span class="literal">-uroot</span> <span class="literal">-p</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第13步，删除容器</span></span><br><span class="line">docker <span class="built_in">rm</span> nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发现无法删除，因为容器运行中，强制删除容器</span></span><br><span class="line">docker <span class="built_in">rm</span> <span class="operator">-f</span> nginx</span><br></pre></td></tr></table></figure>

<ol>
<li><h3 id="数据卷"><a href="#数据卷" class="headerlink" title="数据卷"></a>数据卷</h3></li>
</ol>
<p>容器是隔离环境，容器内程序的文件、配置、运行时产生的容器都在容器内部，我们要读写容器内的文件非常不方便。大家思考几个问题：</p>
<ul>
<li>如果要升级MySQL版本，需要销毁旧容器，那么数据岂不是跟着被销毁了？</li>
<li>MySQL、Nginx容器运行后，如果我要修改其中的某些配置该怎么办？</li>
<li>我想要让Nginx代理我的静态资源怎么办？</li>
</ul>
<p>因此，容器提供程序的运行环境，但是 <strong>程序运行产生的数据、程序运行依赖的配置都应该与容器解耦</strong>。</p>
<ol>
<li><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4></li>
</ol>
<p><strong>数据卷（volume）</strong>是一个虚拟目录，是<strong>容器内目录</strong>与<strong>宿主机目录</strong>之间映射的桥梁。</p>
<p>以Nginx为例，我们知道Nginx中有两个关键的目录：</p>
<ul>
<li><code>html</code>：放置一些静态资源</li>
<li><code>conf</code>：放置配置文件</li>
</ul>
<p>如果我们要让Nginx代理我们的静态资源，最好是放到<code>html</code>目录；如果我们要修改Nginx的配置，最好是找到<code>conf</code>下的<code>nginx.conf</code>文件。</p>
<p>但遗憾的是，容器运行的Nginx所有的文件都在容器内部。所以我们必须利用数据卷将两个目录与宿主机目录关联，方便我们操作。</p>
<p><strong>如图：</strong></p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=MWNmY2Y2OTdjMTE5ODM0MjEyNTA2NzVjNjEwYjRkYjNfUk9HU2o1QXVEcWtIQk5VOGI2YlJDakNleWZrR05Md0dfVG9rZW46WVo2bWJzbHVVbzlNR0x4azBpN2NoNlY1blFiXzE3NDIwNDY1MDA6MTc0MjA1MDEwMF9WNA" alt="img"></p>
<p>在上图中：</p>
<ul>
<li>我们创建了两个数据卷：<code>conf</code>、<code>html</code></li>
<li>Nginx容器内部的<code>conf</code>目录和<code>html</code>目录分别与两个数据卷关联。</li>
<li>而数据卷conf和html分别指向了宿主机的<code>/var/lib/docker/volumes/conf/_data</code>目录和<code>/var/lib/docker/volumes/html/_data</code>目录</li>
</ul>
<p>这样以来，容器内的<code>conf</code>和<code>html</code>目录就 与宿主机的<code>conf</code>和<code>html</code>目录关联起来，我们称为<strong>挂载</strong>。</p>
<p>此时，我们操作宿主机的<code>/var/lib/docker/volumes/html/_data</code>就是在操作容器内的<code>/usr/share/nginx/html/_data</code>目录。只要我们将静态资源放入宿主机对应目录，就可以被Nginx代理了。</p>
<p><strong>小提示</strong>：</p>
<p><code>/var/lib/docker/volumes</code>这个目录就是默认的存放所有容器数据卷的目录，其下再根据数据卷名称创建新目录，格式为<code>/数据卷名/_data</code>。</p>
<p><strong>为什么不让容器目录直接指向宿主机目录呢</strong>？</p>
<ul>
<li>因为直接指向宿主机目录就与宿主机强耦合了，如果切换了环境，宿主机目录就可能发生改变了。由于容器一旦创建，目录挂载就无法修改，这样容器就无法正常工作了。</li>
<li>但是容器指向数据卷，一个逻辑名称，而数据卷再指向宿主机目录，就不存在强耦合。如果宿主机目录发生改变，只要改变数据卷与宿主机目录之间的映射关系即可。</li>
</ul>
<p>不过，我们通过由于数据卷目录比较深，不好寻找，通常我们也<strong>允许让容器直接与宿主机目录挂载而不使用数据卷</strong>，具体参考2.2.3小节。</p>
<ol>
<li><h4 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h4></li>
</ol>
<p>数据卷的相关命令有：</p>
<table>
<thead>
<tr>
<th align="left"><strong>命令</strong></th>
<th align="left"><strong>说明</strong></th>
<th align="left"><strong>文档地址</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">docker volume create</td>
<td align="left">创建数据卷</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/volume_create/">docker volume create</a></td>
</tr>
<tr>
<td align="left">docker volume ls</td>
<td align="left">查看所有数据卷</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/volume_ls/">docs.docker.com</a></td>
</tr>
<tr>
<td align="left">docker volume rm</td>
<td align="left">删除指定数据卷</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/volume_prune/">docs.docker.com</a></td>
</tr>
<tr>
<td align="left">docker volume inspect</td>
<td align="left">查看某个数据卷的详情</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/volume_inspect/">docs.docker.com</a></td>
</tr>
<tr>
<td align="left">docker volume prune</td>
<td align="left">清除数据卷</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/volume_prune/">docker volume prune</a></td>
</tr>
</tbody></table>
<p>注意：容器与数据卷的挂载要在创建容器时配置，对于创建好的容器，是不能设置数据卷的。而且<strong>创建容器的过程中，数据卷会自动创建</strong>。</p>
<p>教学<strong>演示环节</strong>：演示一下nginx的html目录挂载</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.首先创建容器并指定数据卷，注意通过 -v 参数来指定数据卷</span></span><br><span class="line">docker run <span class="literal">-d</span> <span class="literal">--name</span> nginx <span class="literal">-p</span> <span class="number">80</span>:<span class="number">80</span> <span class="literal">-v</span> html:/usr/share/nginx/html nginx:<span class="number">1.20</span>.<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.然后查看数据卷</span></span><br><span class="line">docker volume <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.查看数据卷详情</span></span><br><span class="line">docker volume inspect html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.查看/var/lib/docker/volumes/html/_data目录</span></span><br><span class="line">ll /var/lib/docker/volumes/html/_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.进入该目录，并随意修改index.html内容</span></span><br><span class="line"><span class="built_in">cd</span> /var/lib/docker/volumes/html/_data</span><br><span class="line">vi index.html</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.打开页面，查看效果</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 7.进入容器内部，查看/usr/share/nginx/html目录内的文件是否变化</span></span><br><span class="line">docker exec <span class="literal">-it</span> nginx bash</span><br></pre></td></tr></table></figure>

<p>教学<strong>演示环节</strong>：演示一下MySQL的匿名数据卷</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.查看MySQL容器详细信息</span></span><br><span class="line">docker inspect mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关注其中.Config.Volumes部分和.Mounts部分</span></span><br></pre></td></tr></table></figure>

<p>我们关注两部分内容，第一是<code>.Config.Volumes</code>部分：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;Config&quot;</span>: &#123;</span><br><span class="line">    // ... 略</span><br><span class="line">    <span class="string">&quot;Volumes&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;/var/lib/mysql&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // ... 略</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现这个容器声明了一个本地目录，需要挂载数据卷，但是<strong>数据卷未定义</strong>。这就是匿名卷。</p>
<p>然后，我们再看结果中的<code>.Mounts</code>部分：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;Mounts&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;volume&quot;</span>,</span><br><span class="line">      <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;29524ff09715d3688eae3f99803a2796558dbd00ca584a25a4bbc193ca82459f&quot;</span>,</span><br><span class="line">      <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/29524ff09715d3688eae3f99803a2796558dbd00ca584a25a4bbc193ca82459f/_data&quot;</span>,</span><br><span class="line">      <span class="string">&quot;Destination&quot;</span>: <span class="string">&quot;/var/lib/mysql&quot;</span>,</span><br><span class="line">      <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现，其中有几个关键属性：</p>
<ul>
<li>Name：数据卷名称。由于定义容器未设置容器名，这里的就是匿名卷自动生成的名字，一串hash值。</li>
<li>Source：宿主机目录</li>
<li>Destination : 容器内的目录</li>
</ul>
<p>上述配置是将容器内的<code>/var/lib/mysql</code>这个目录，与数据卷<code>29524ff09715d3688eae3f99803a2796558dbd00ca584a25a4bbc193ca82459f</code>挂载。于是在宿主机中就有了<code>/var/lib/docker/volumes/29524ff09715d3688eae3f99803a2796558dbd00ca584a25a4bbc193ca82459f/_data</code>这个目录。这就是匿名数据卷对应的目录，其使用方式与普通数据卷没有差别。</p>
<p>接下来，可以查看该目录下的MySQL的data文件：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> <span class="literal">-l</span> /var/lib/docker/volumes/<span class="number">29524</span>ff09715d3688eae3f99803a2796558dbd00ca584a25a4bbc193ca82459f/_data</span><br></pre></td></tr></table></figure>

<p>注意：每一个不同的镜像，将来创建容器后内部有哪些目录可以挂载，可以参考DockerHub对应的页面 。</p>
<ol>
<li><h4 id="挂载本地目录或文件"><a href="#挂载本地目录或文件" class="headerlink" title="挂载本地目录或文件"></a>挂载本地目录或文件</h4></li>
</ol>
<p>可以发现，数据卷的目录结构较深，如果我们去操作数据卷目录会不太方便。在很多情况下，我们会直接将容器目录与宿主机指定目录挂载。挂载语法与数据卷类似：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 挂载本地目录</span></span><br><span class="line"><span class="literal">-v</span> 本地目录:容器内目录</span><br><span class="line"></span><br><span class="line"><span class="comment"># 挂载本地文件</span></span><br><span class="line"><span class="literal">-v</span> 本地文件:容器内文件</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：本地目录或文件必须以 <code>/</code> 或 <code>./</code>开头，如果直接以名字开头，会被识别为数据卷名而非本地目录名。</p>
<p><strong>例如：</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">-v</span> mysql:/var/lib/mysql <span class="comment"># 会被识别为一个数据卷叫mysql，运行时会自动创建这个数据卷</span></span><br><span class="line"></span><br><span class="line"><span class="literal">-v</span> ./mysql:/var/lib/mysql <span class="comment"># 会被识别为当前目录下的mysql目录，运行时如果不存在会创建目录</span></span><br></pre></td></tr></table></figure>

<p><strong>教学演示</strong>，删除并重新创建mysql容器，并完成本地目录挂载：</p>
<ul>
<li>挂载<code>/root/mysql/data</code>到容器内的<code>/var/lib/mysql</code>目录</li>
<li>挂载<code>/root/mysql/init</code>到容器内的<code>/docker-entrypoint-initdb.d</code>目录（初始化的SQL脚本目录）</li>
<li>挂载<code>/root/mysql/conf</code>到容器内的<code>/etc/mysql/conf.d</code>目录（这个是MySQL配置文件目录）</li>
</ul>
<p>在课前资料中已经准备好了mysql 的<code>init</code>目录、<code>conf</code>目录、<code>data</code>目录，可以直接将其上传到Linux服务器中的 &#x2F;root&#x2F;mysql 目录下。</p>
<p>最终执行的指令如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line"><span class="literal">--name</span> mysql \</span><br><span class="line"><span class="literal">-p</span> <span class="number">3307</span>:<span class="number">3306</span> \</span><br><span class="line"><span class="literal">-e</span> MYSQL_ROOT_PASSWORD=<span class="number">123</span> \</span><br><span class="line"><span class="literal">-e</span> TZ=Asia/Shanghai \</span><br><span class="line"><span class="literal">-v</span> /root/mysql/<span class="keyword">data</span>:/var/lib/mysql \</span><br><span class="line"><span class="literal">-v</span> /root/mysql/init:/docker<span class="literal">-entrypoint-initdb</span>.d \</span><br><span class="line"><span class="literal">-v</span> /root/mysql/conf:/etc/mysql/conf.d \</span><br><span class="line">mysql:<span class="number">8</span></span><br></pre></td></tr></table></figure>

<ol>
<li><h3 id="自定义镜像"><a href="#自定义镜像" class="headerlink" title="自定义镜像"></a>自定义镜像</h3></li>
</ol>
<p>前面我们一直在使用别人准备好的镜像，那如果我要部署一个Java项目，把它打包为一个镜像该怎么做呢？ 那接下来，我们就来介绍一下如何自定义镜像。</p>
<ol>
<li><h4 id="镜像结构"><a href="#镜像结构" class="headerlink" title="镜像结构"></a>镜像结构</h4></li>
</ol>
<p>要想自己构建镜像，必须先了解镜像的结构。</p>
<p>之前我们说过，镜像之所以能让我们快速跨操作系统部署应用而忽略其运行环境、配置，就是因为镜像中包含了程序运行需要的系统函数库、环境、配置、依赖。</p>
<p>因此，自定义镜像本质就是依次准备好程序运行的基础环境、依赖、应用本身、运行配置等文件，并且打包而成。</p>
<p>举个例子，我们要从0部署一个Java应用，大概流程是这样：</p>
<ul>
<li>准备一个linux服务（CentOS或者Ubuntu均可）</li>
<li>安装并配置JDK</li>
<li>上传Jar包</li>
<li>运行jar包</li>
</ul>
<p>那因此，我们打包镜像也是分成这么几步：</p>
<ul>
<li>准备Linux运行环境（java项目并不需要完整的操作系统，仅仅是基础运行环境即可）</li>
<li>安装并配置JDK</li>
<li>拷贝jar包</li>
<li>配置启动脚本</li>
</ul>
<p>上述步骤中的每一次操作其实都是在生产一些文件（系统运行环境、函数库、配置最终都是磁盘文件），所以<strong>镜像就是一堆文件的集合</strong>。</p>
<p>但需要注意的是，镜像文件不是随意堆放的，而是按照操作的步骤分层叠加而成，每一层形成的文件都会单独打包并标记一个唯一id，称为<strong>Layer</strong>（<strong>层</strong>）。这样，如果我们构建时用到的某些层其他人已经制作过，就可以直接拷贝使用这些层，而不用重复制作。</p>
<p>例如，第一步中需要的Linux运行环境，通用性就很强，所以Docker官方就制作了这样的只包含Linux运行环境的镜像。我们在制作java镜像时，就无需重复制作，直接使用Docker官方提供的CentOS或Ubuntu镜像作为基础镜像。然后再搭建其它层即可，这样逐层搭建，最终整个Java项目的镜像结构如图所示：</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=MzY2NzBjNTU5MGFmMTYxNjQ3ZTg2YTBjMmI3NTZmODBfUU1UeGFiWVJEbDdNUXF0SmF6RFpqMzlsTENLeXY4ZjZfVG9rZW46RkRzUWJNOFJHb3cwU2x4U01ic2M4VEZDblRnXzE3NDIwNDY1MDA6MTc0MjA1MDEwMF9WNA" alt="img"></p>
<ol>
<li><h4 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h4></li>
</ol>
<p>由于制作镜像的过程中，需要逐层处理和打包，比较复杂，所以Docker就提供了自动打包镜像的功能。我们只需要将打包的过程，每一层要做的事情用固定的语法写下来，交给Docker去执行即可。而这种记录镜像结构的文件就称为<strong>Dockerfile。</strong></p>
<p>其中的语法比较多，比较常用的有：</p>
<table>
<thead>
<tr>
<th align="left"><strong>指令</strong></th>
<th align="left"><strong>说明</strong></th>
<th align="left"><strong>示例</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>FROM</strong></td>
<td align="left">指定基础镜像</td>
<td align="left"><code>FROM centos:7</code></td>
</tr>
<tr>
<td align="left"><strong>ENV</strong></td>
<td align="left">设置环境变量，可在后面指令使用</td>
<td align="left"><code>ENV key value</code></td>
</tr>
<tr>
<td align="left"><strong>COPY</strong></td>
<td align="left">拷贝本地文件到镜像的指定目录</td>
<td align="left"><code>COPY ./xx.jar /tmp/app.jar</code></td>
</tr>
<tr>
<td align="left"><strong>RUN</strong></td>
<td align="left">执行Linux的shell命令，一般是安装过程的命令</td>
<td align="left"><code>RUN yum install gcc</code></td>
</tr>
<tr>
<td align="left"><strong>EXPOSE</strong></td>
<td align="left">指定容器运行时监听的端口，是给镜像使用者看的</td>
<td align="left">EXPOSE 8080</td>
</tr>
<tr>
<td align="left"><strong>ENTRYPOINT</strong></td>
<td align="left">镜像中应用的启动命令，容器运行时调用</td>
<td align="left">ENTRYPOINT java -jar xx.jar</td>
</tr>
</tbody></table>
<p>例如，要基于 centos:7 镜像来构建一个Java应用，其Dockerfile内容如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 CentOS 7 作为基础镜像</span></span><br><span class="line">FROM centos:<span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加 JDK 到镜像中</span></span><br><span class="line"><span class="built_in">COPY</span> jdk17.tar.gz /usr/local/</span><br><span class="line">RUN tar <span class="literal">-xzf</span> /usr/local/jdk17.tar.gz <span class="literal">-C</span> /usr/local/ &amp;&amp;  <span class="built_in">rm</span> /usr/local/jdk17.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line">ENV JAVA_HOME=/usr/local/jdk<span class="literal">-17</span>.<span class="number">0.10</span></span><br><span class="line">ENV PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建应用目录</span></span><br><span class="line">RUN mkdir <span class="literal">-p</span> /app</span><br><span class="line">WORKDIR /app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制应用 JAR 文件到容器</span></span><br><span class="line"><span class="built_in">COPY</span> app.jar app.jar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露端口</span></span><br><span class="line">EXPOSE <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行命令</span></span><br><span class="line">ENTRYPOINT [<span class="string">&quot;java&quot;</span>,<span class="string">&quot;-Djava.security.egd=file:/dev/./urandom&quot;</span>,<span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;/app/app.jar&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>Dockerfile文件编写好了之后，就可以使用如下命令来构建镜像了。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build <span class="literal">-t</span> 镜像名 .</span><br></pre></td></tr></table></figure>

<ul>
<li>-t ：是给镜像起名，格式依然是repository:tag的格式，不指定tag时，默认为latest</li>
<li>.  ：是指定Dockerfile所在目录，如果就在当前目录，则指定为”.”</li>
</ul>
<p><strong>演示:</strong></p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=MjI3ODNkNjc0NjE5YjVmNTkxZDY2YzQxMjNhYzhkMTNfV3IyblNuWmcwQldFTzh0RTBBRWR4QlFFUTZWWFJQbFlfVG9rZW46TkJ4TGI0VE8zb2Z3Zmh4UWs4dWNrWXdyblBoXzE3NDIwNDY1MDA6MTc0MjA1MDEwMF9WNA" alt="img"></p>
<ol>
<li><h3 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h3></li>
</ol>
<p>上节课我们创建了一个Java项目的容器，而Java项目往往需要访问其它各种中间件，例如MySQL、Redis等。现在，我们的容器之间能否互相访问呢？我们来测试一下</p>
<p>首先，我们查看下MySQL容器的详细信息，重点关注其中的网络IP地址：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.用基本命令，寻找Networks.bridge.IPAddress属性</span></span><br><span class="line">docker inspect mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以使用format过滤结果</span></span><br><span class="line">docker inspect <span class="literal">--format</span>=<span class="string">&#x27;&#123;&#123;range .NetworkSettings.Networks&#125;&#125;&#123;&#123;println .IPAddress&#125;&#125;&#123;&#123;end&#125;&#125;&#x27;</span> mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 得到IP地址如下：</span></span><br><span class="line"><span class="number">172.17</span>.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.然后通过命令进入dd容器</span></span><br><span class="line">docker exec <span class="literal">-it</span> dd bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.在容器内，通过ping命令测试网络</span></span><br><span class="line">ping <span class="number">172.17</span>.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果</span></span><br><span class="line">PING <span class="number">172.17</span>.<span class="number">0.2</span> (<span class="number">172.17</span>.<span class="number">0.2</span>) <span class="number">56</span>(<span class="number">84</span>) bytes of <span class="keyword">data</span>.</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">172.17</span>.<span class="number">0.2</span>: icmp_seq=<span class="number">1</span> ttl=<span class="number">64</span> time=<span class="number">0.053</span> ms</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">172.17</span>.<span class="number">0.2</span>: icmp_seq=<span class="number">2</span> ttl=<span class="number">64</span> time=<span class="number">0.059</span> ms</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">172.17</span>.<span class="number">0.2</span>: icmp_seq=<span class="number">3</span> ttl=<span class="number">64</span> time=<span class="number">0.058</span> ms</span><br></pre></td></tr></table></figure>

<p>发现可以互联，没有问题。</p>
<p>但是，容器的网络IP其实是一个虚拟的IP，其值并不固定与某一个容器绑定，如果我们在开发时写死某个IP，而在部署时很可能MySQL容器的IP会发生变化，连接会失败。</p>
<p>常见命令有：</p>
<table>
<thead>
<tr>
<th align="left"><strong>命令</strong></th>
<th align="left"><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">docker network create</td>
<td align="left">创建一个网络</td>
</tr>
<tr>
<td align="left">docker network ls</td>
<td align="left">查看所有网络</td>
</tr>
<tr>
<td align="left">docker network rm</td>
<td align="left">删除指定网络</td>
</tr>
<tr>
<td align="left">docker network prune</td>
<td align="left">清除未使用的网络</td>
</tr>
<tr>
<td align="left">docker network connect</td>
<td align="left">使指定容器连接加入某网络</td>
</tr>
<tr>
<td align="left">docker network disconnect</td>
<td align="left">使指定容器连接离开某网络</td>
</tr>
<tr>
<td align="left">docker network inspect</td>
<td align="left">查看网络详细信息</td>
</tr>
</tbody></table>
<p><strong>教学演示：自定义网络</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.首先通过命令创建一个网络</span></span><br><span class="line">docker network create itheima</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.然后查看网络</span></span><br><span class="line">docker network <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果：</span></span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line"><span class="number">639</span>bc44d0a87   bridge    bridge    local</span><br><span class="line"><span class="number">403</span>f16ec62a2   itheima     bridge    local</span><br><span class="line"><span class="number">0</span>dc0f72a0fbb   host      host      local</span><br><span class="line">cd8d3e8df47b   none      null      local</span><br><span class="line"><span class="comment"># 其中，除了itheima以外，其它都是默认的网络</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.让 myapp 和 mysql 都加入该网络</span></span><br><span class="line"><span class="comment"># 3.1.mysql容器，加入 itheima 网络</span></span><br><span class="line">docker network connect itheima mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.2.myapp容器，也就是我们的java项目, 加入 itheima 网络</span></span><br><span class="line">docker network connect itheima myapp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.进入dd容器，尝试利用别名访问db</span></span><br><span class="line"><span class="comment"># 4.1.进入容器</span></span><br><span class="line">docker exec <span class="literal">-it</span> myapp bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.2.用容器名访问</span></span><br><span class="line">ping mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果：</span></span><br><span class="line">PING mysql (<span class="number">172.18</span>.<span class="number">0.2</span>) <span class="number">56</span>(<span class="number">84</span>) bytes of <span class="keyword">data</span>.</span><br><span class="line"><span class="number">64</span> bytes from mysql.itheima (<span class="number">172.18</span>.<span class="number">0.2</span>): icmp_seq=<span class="number">1</span> ttl=<span class="number">64</span> time=<span class="number">0.044</span> ms</span><br><span class="line"><span class="number">64</span> bytes from mysql.itheima (<span class="number">172.18</span>.<span class="number">0.2</span>): icmp_seq=<span class="number">2</span> ttl=<span class="number">64</span> time=<span class="number">0.054</span> ms</span><br></pre></td></tr></table></figure>

<p>OK，现在无需记住IP地址也可以实现容器互联了。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/03/15/Docker%E5%9F%BA%E7%A1%80/" data-id="cm8sja96z00008ktb03j5bg1k" data-title="Docker基础" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Docker快速入门" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/03/15/Docker%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" class="article-date">
  <time class="dt-published" datetime="2025-03-15T13:43:44.000Z" itemprop="datePublished">2025-03-15</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Docker/">Docker</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/03/15/Docker%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/">Docker快速入门</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <ol>
<li><h2 id="快速入门"><a href="#快速入门" class="headerlink" title="快速入门"></a>快速入门</h2></li>
</ol>
<p>要想让Docker帮我们安装和部署软件，肯定要保证你的机器上有Docker。由于大家的操作系统各不相同，安装方式也不同。为了便于大家学习，我们统一在之前提供给大家的CentOS的虚拟机中<strong>已经安装了Docker</strong>，统一学习环境。</p>
<p>如果大家需要自己在别的机器上安装Docker环境，可以参照最后的 <strong>附录中的：Docker安装文档</strong></p>
<ol>
<li><h3 id="部署MySQL"><a href="#部署MySQL" class="headerlink" title="部署MySQL"></a>部署MySQL</h3></li>
</ol>
<p>首先，我们利用Docker来安装一个MySQL软件，大家可以对比一下之前传统的安装方式，看看哪个效率更高一些。</p>
<p>如果是利用传统方式部署MySQL，大概的步骤有：</p>
<ul>
<li>搜索并下载MySQL安装包</li>
<li>上传至Linux环境</li>
<li>解压和配置环境</li>
<li>安装</li>
<li>初始化和配置</li>
</ul>
<p>而使用Docker安装，仅仅需要一步即可，在命令行输入下面的命令（建议采用CV大法）：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line">  <span class="literal">--name</span> mysql \</span><br><span class="line">  <span class="literal">-p</span> <span class="number">3307</span>:<span class="number">3306</span> \</span><br><span class="line">  <span class="literal">-e</span> TZ=Asia/Shanghai \</span><br><span class="line">  <span class="literal">-e</span> MYSQL_ROOT_PASSWORD=<span class="number">123</span> \</span><br><span class="line">  mysql:<span class="number">8</span></span><br></pre></td></tr></table></figure>

<p>运行效果如图（在给大家提供的资料中，已经下载好了mysql 8版本的镜像）：</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=YzY0MjRlYjZjZTE4MGYzNGY1MGIzZWM0MGMzODJiMDZfZVhiS2F6cFNEQjVJNFE0akxEaFJ2N1RiVjFIY29RWktfVG9rZW46UjNZdWJuZ3Byb0xjYTB4T2JPdmM1ZHFrbjllXzE3NDIwNDYzNTc6MTc0MjA0OTk1N19WNA" alt="img"></p>
<p>MySQL安装完毕！通过任意客户端工具即可连接到MySQL。</p>
<p><strong>说明：</strong></p>
<p>其实，当我们执行命令后，Docker做的第一件事情，是去自动搜索并下载了MySQL，然后会自动运行MySQL，我们完全不用插手，是非常方便的 。</p>
<p>而且，这种安装方式你完全不用考虑运行的操作系统环境，它不仅仅在CentOS系统是这样，在Ubuntu系统、macOS系统、甚至是装了WSL的Windows下，都可以使用这条命令来安装MySQL 。</p>
<p>要知道，不同操作系统下其安装包、运行环境是都不相同的！如果是手动安装，必须手动解决安装包不同、环境不同的、配置不同的问题！</p>
<p>而使用Docker，这些完全不用考虑。就是因为Docker会自动搜索并下载MySQL。</p>
<p><strong>注意：</strong></p>
<p>这里下载的不是安装包，而是<strong>镜像。</strong>镜像中不仅包含了MySQL本身，还包含了其运行所需要的环境、配置、系统级函数库。因此它在运行时就有自己独立的环境，就可以跨系统运行，也不需要手动再次配置环境了。这套独立运行的隔离环境我们称为<strong>容器</strong>。</p>
<p>说明：</p>
<ul>
<li>镜像：英文是image</li>
<li>容器：英文是container</li>
</ul>
<blockquote>
<p>因此，Docker安装软件的过程，就是自动搜索下载镜像，然后创建并运行容器的过程。</p>
</blockquote>
<p>Docker会根据命令中的镜像名称自动搜索并下载镜像，那么问题来了，它是去哪里搜索和下载镜像的呢？这些镜像又是谁制作的呢？</p>
<p>Docker官方提供了一个专门管理、存储镜像的网站，并对外开放了镜像上传、下载的权利。Docker官方提供了一些基础镜像，然后各大软件公司又在基础镜像基础上，制作了自家软件的镜像，全部都存放在这个网站。这个网站就成了Docker镜像交流的社区：<a target="_blank" rel="noopener" href="https://hub.docker.com/">https://hub.docker.com</a></p>
<p>基本上我们常用的各种软件都能在这个网站上找到，我们甚至可以自己制作镜像上传上去。【<strong>但是该网站，目前国内上不去了</strong>】</p>
<p>像这种提供存储、管理Docker镜像的服务器，被称为DockerRegistry，可以翻译为<strong>镜像仓库</strong>。DockerHub网站是官方仓库，阿里云、华为云会提供一些第三方仓库，我们也可以自己搭建私有的镜像仓库。</p>
<p>官方仓库在国外，下载速度较慢，一般我们都会使用第三方仓库提供的镜像加速功能，提高下载速度。而企业内部的机密项目，往往会采用私有镜像仓库。</p>
<p>总之，镜像的来源有两种：</p>
<ul>
<li>基于官方基础镜像自己制作</li>
<li>直接去DockerRegistry下载</li>
</ul>
<p><strong>总结一下</strong>：</p>
<p>Docker本身包含一个后台服务，我们可以利用Docker命令告诉Docker服务，帮助我们快速部署指定的应用。Docker服务部署应用时，首先要去搜索并下载应用对应的镜像，然后根据镜像创建并允许容器，应用就部署完成了。</p>
<p>用一幅图表示如下：</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=YTNiZjRmODFjNGQzMjgyNDhiZDA2YTJkNDE2MjNkYTFfMWV2bldsaTAyT3lHd29GcDJDQ1RNQzV6eWJ6S0kzdWZfVG9rZW46SkxGQWJwSElyb1ZxaHZ4UmJzRmNhS0o3bjZkXzE3NDIwNDYzNTc6MTc0MjA0OTk1N19WNA" alt="img"></p>
<ol>
<li><h3 id="命令解读"><a href="#命令解读" class="headerlink" title="命令解读"></a>命令解读</h3></li>
</ol>
<p>利用Docker快速的安装了MySQL，非常的方便，不过我们执行的命令到底是什么意思呢？</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line">  <span class="literal">--name</span> mysql \</span><br><span class="line">  <span class="literal">-p</span> <span class="number">3307</span>:<span class="number">3306</span> \</span><br><span class="line">  <span class="literal">-e</span> TZ=Asia/Shanghai \</span><br><span class="line">  <span class="literal">-e</span> MYSQL_ROOT_PASSWORD=<span class="number">123</span> \</span><br><span class="line">  mysql:<span class="number">8</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>解读：</strong></p>
<ul>
<li><p><code>docker run -d</code> ：创建并运行一个容器，<code>-d</code>则是让容器以后台进程运行</p>
</li>
<li><p><code>--name mysql </code> : 给容器起个名字叫<code>mysql</code>，你可以叫别的</p>
</li>
<li><h2 id="p-3307-3306-设置端口映射。-容器是隔离环境，外界不可访问。但是可以将宿主机端口映射容器内到端口，当访问宿主机指定端口时，就是在访问容器内的端口了。-容器内端口往往是由容器内的进程决定，例如MySQL进程默认端口是3306，因此容器内端口一定是3306；而宿主机端口则可以任意指定，一般与容器内保持一致。-格式：-p-宿主机端口-容器内端口，示例中就是将宿主机的3307映射到容器内的3306端口"><a href="#p-3307-3306-设置端口映射。-容器是隔离环境，外界不可访问。但是可以将宿主机端口映射容器内到端口，当访问宿主机指定端口时，就是在访问容器内的端口了。-容器内端口往往是由容器内的进程决定，例如MySQL进程默认端口是3306，因此容器内端口一定是3306；而宿主机端口则可以任意指定，一般与容器内保持一致。-格式：-p-宿主机端口-容器内端口，示例中就是将宿主机的3307映射到容器内的3306端口" class="headerlink" title="-p 3307:3306 : 设置端口映射。- 容器是隔离环境，外界不可访问。但是可以将宿主机端口映射容器内到端口，当访问宿主机指定端口时，就是在访问容器内的端口了。- 容器内端口往往是由容器内的进程决定，例如MySQL进程默认端口是3306，因此容器内端口一定是3306；而宿主机端口则可以任意指定，一般与容器内保持一致。- 格式： -p 宿主机端口:容器内端口，示例中就是将宿主机的3307映射到容器内的3306端口"></a><code>-p 3307:3306</code> : 设置端口映射。<br>- <strong>容器是隔离环境</strong>，外界不可访问。但是可以<strong>将宿主机端口映射容器内到端口</strong>，当访问宿主机指定端口时，就是在访问容器内的端口了。<br>- 容器内端口往往是由容器内的进程决定，例如MySQL进程默认端口是3306，因此容器内端口一定是3306；而宿主机端口则可以任意指定，一般与容器内保持一致。<br>- 格式： <code>-p 宿主机端口:容器内端口</code>，示例中就是将宿主机的3307映射到容器内的3306端口</h2></li>
<li><h2 id="e-TZ-Asia-Shanghai-配置容器内进程运行时的一些参数-格式：-e-KEY-VALUE，KEY和VALUE都由容器内进程决定-案例中，TZ-Asia-Shanghai是设置时区；MYSQL-ROOT-PASSWORD-123是设置MySQL默认密码"><a href="#e-TZ-Asia-Shanghai-配置容器内进程运行时的一些参数-格式：-e-KEY-VALUE，KEY和VALUE都由容器内进程决定-案例中，TZ-Asia-Shanghai是设置时区；MYSQL-ROOT-PASSWORD-123是设置MySQL默认密码" class="headerlink" title="-e TZ=Asia/Shanghai : 配置容器内进程运行时的一些参数- 格式：-e KEY=VALUE，KEY和VALUE都由容器内进程决定- 案例中，TZ=Asia/Shanghai是设置时区；MYSQL_ROOT_PASSWORD=123是设置MySQL默认密码"></a><code>-e TZ=Asia/Shanghai</code> : 配置容器内进程运行时的一些参数<br>- 格式：<code>-e KEY=VALUE</code>，KEY和VALUE都由容器内进程决定<br>- 案例中，<code>TZ=Asia/Shanghai</code>是设置时区；<code>MYSQL_ROOT_PASSWORD=123</code>是设置MySQL默认密码</h2></li>
<li><p><code>mysql:8</code> : 设置<strong>镜像</strong>名称，Docker会根据这个名字搜索并下载镜像</p>
<ul>
<li>格式：<code>REPOSITORY:TAG</code>，例如<code>mysql:8.0</code>，其中<code>REPOSITORY</code>可以理解为镜像名，<code>TAG</code>是版本号</li>
<li>在未指定<code>TAG</code>的情况下，默认是最新版本，也就是<code>mysql:latest</code></li>
</ul>
</li>
</ul>
</blockquote>
<p>镜像的名称不是随意的，而是要到DockerRegistry中寻找，镜像运行时的配置也不是随意的，要参考镜像的帮助文档，这些在DockerHub网站或者软件的官方网站中都能找到。</p>
<p>如果我们要安装其它软件，也可以到DockerRegistry中寻找对应的镜像名称和版本，阅读相关配置即可。</p>
<ol>
<li><h2 id="Docker基础"><a href="#Docker基础" class="headerlink" title="Docker基础"></a>Docker基础</h2></li>
</ol>
<p>接下来，我们一起来学习Docker使用的一些基础知识，为将来部署项目打下基础。</p>
<ol>
<li><h3 id="常见命令"><a href="#常见命令" class="headerlink" title="常见命令"></a>常见命令</h3></li>
<li><h4 id="命令介绍"><a href="#命令介绍" class="headerlink" title="命令介绍"></a>命令介绍</h4></li>
</ol>
<p>其中，比较常见的命令有：</p>
<table>
<thead>
<tr>
<th align="left"><strong>命令</strong></th>
<th align="left"><strong>说明</strong></th>
<th align="left"><strong>文档地址</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">docker pull</td>
<td align="left">拉取镜像</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/pull/">docker pull</a></td>
</tr>
<tr>
<td align="left">docker push</td>
<td align="left">推送镜像到DockerRegistry</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/push/">docker push</a></td>
</tr>
<tr>
<td align="left">docker images</td>
<td align="left">查看本地镜像</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/images/">docker images</a></td>
</tr>
<tr>
<td align="left">docker rmi</td>
<td align="left">删除本地镜像</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/rmi/">docker rmi</a></td>
</tr>
<tr>
<td align="left">docker run</td>
<td align="left">创建并运行容器（不能重复创建）</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/run/">docker run</a></td>
</tr>
<tr>
<td align="left">docker stop</td>
<td align="left">停止指定容器</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/stop/">docker stop</a></td>
</tr>
<tr>
<td align="left">docker start</td>
<td align="left">启动指定容器</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/start/">docker start</a></td>
</tr>
<tr>
<td align="left">docker restart</td>
<td align="left">重新启动容器</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/restart/">docker restart</a></td>
</tr>
<tr>
<td align="left">docker rm</td>
<td align="left">删除指定容器</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/rm/">docs.docker.com</a></td>
</tr>
<tr>
<td align="left">docker ps</td>
<td align="left">查看容器</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/ps/">docker ps</a></td>
</tr>
<tr>
<td align="left">docker logs</td>
<td align="left">查看容器运行日志</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/logs/">docker logs</a></td>
</tr>
<tr>
<td align="left">docker exec</td>
<td align="left">进入容器</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/exec/">docker exec</a></td>
</tr>
<tr>
<td align="left">docker save</td>
<td align="left">保存镜像到本地压缩文件</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/save/">docker save</a></td>
</tr>
<tr>
<td align="left">docker load</td>
<td align="left">加载本地压缩文件到镜像</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/load/">docker load</a></td>
</tr>
<tr>
<td align="left">docker inspect</td>
<td align="left">查看容器详细信息</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/inspect/">docker inspect</a></td>
</tr>
</tbody></table>
<p>用一副图来表示这些命令的关系：</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=MmQ5MGYzMTMwN2QxY2NmNjY3NThlMzA5NTQxNDY1ZjFfekFaMERiWGk1eHRRUmVyNENIa3daSElHMFdTTHQ0Z0hfVG9rZW46UGxsRmJqbURLb0RuZnZ4YXc1emNxT2ZUbmJmXzE3NDIwNDYzNTc6MTc0MjA0OTk1N19WNA" alt="img"></p>
<p><strong>补充：</strong></p>
<p>默认情况下，每次重启虚拟机我们都需要手动启动Docker和Docker中的容器。通过命令可以实现开机自启：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Docker开机自启</span></span><br><span class="line">systemctl enable docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># Docker容器开机自启</span></span><br><span class="line">docker update <span class="literal">--restart</span>=always [容器名/容器<span class="type">id</span>]</span><br></pre></td></tr></table></figure>

<ol>
<li><h4 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h4></li>
</ol>
<p>我们以Nginx为例给大家演示上述命令。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第1步，去DockerHub查看nginx镜像仓库及相关信息</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第2步，拉取Nginx镜像 (比较耗时)</span></span><br><span class="line">docker pull nginx:<span class="number">1.20</span>.<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第3步，查看镜像</span></span><br><span class="line">docker images</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第4步，创建并允许Nginx容器</span></span><br><span class="line">docker run <span class="literal">-d</span> <span class="literal">--name</span> nginx <span class="literal">-p</span> <span class="number">80</span>:<span class="number">80</span> nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第5步，查看运行中容器</span></span><br><span class="line">docker <span class="built_in">ps</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以加格式化方式访问，格式会更加清爽</span></span><br><span class="line">docker <span class="built_in">ps</span> <span class="literal">--format</span> <span class="string">&quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Image&#125;&#125;\t&#123;&#123;.Ports&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.Names&#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第6步，访问网页，地址：http://虚拟机地址</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第7步，停止容器</span></span><br><span class="line">docker stop nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第8步，查看所有容器</span></span><br><span class="line">docker <span class="built_in">ps</span> <span class="literal">-a</span> <span class="literal">--format</span> <span class="string">&quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Image&#125;&#125;\t&#123;&#123;.Ports&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.Names&#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第9步，再次启动nginx容器</span></span><br><span class="line">docker <span class="built_in">start</span> nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第10步，再次查看容器</span></span><br><span class="line">docker <span class="built_in">ps</span> <span class="literal">--format</span> <span class="string">&quot;table &#123;&#123;.ID&#125;&#125;\t&#123;&#123;.Image&#125;&#125;\t&#123;&#123;.Ports&#125;&#125;\t&#123;&#123;.Status&#125;&#125;\t&#123;&#123;.Names&#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第11步，查看容器详细信息</span></span><br><span class="line">docker inspect nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 第12步，进入容器,查看容器内目录</span></span><br><span class="line">docker exec <span class="literal">-it</span> nginx bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 或者，可以进入MySQL</span></span><br><span class="line">docker exec <span class="literal">-it</span> mysql mysql <span class="literal">-uroot</span> <span class="literal">-p</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 第13步，删除容器</span></span><br><span class="line">docker <span class="built_in">rm</span> nginx</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发现无法删除，因为容器运行中，强制删除容器</span></span><br><span class="line">docker <span class="built_in">rm</span> <span class="operator">-f</span> nginx</span><br></pre></td></tr></table></figure>

<ol>
<li><h3 id="数据卷"><a href="#数据卷" class="headerlink" title="数据卷"></a>数据卷</h3></li>
</ol>
<p>容器是隔离环境，容器内程序的文件、配置、运行时产生的容器都在容器内部，我们要读写容器内的文件非常不方便。大家思考几个问题：</p>
<ul>
<li>如果要升级MySQL版本，需要销毁旧容器，那么数据岂不是跟着被销毁了？</li>
<li>MySQL、Nginx容器运行后，如果我要修改其中的某些配置该怎么办？</li>
<li>我想要让Nginx代理我的静态资源怎么办？</li>
</ul>
<p>因此，容器提供程序的运行环境，但是 <strong>程序运行产生的数据、程序运行依赖的配置都应该与容器解耦</strong>。</p>
<ol>
<li><h4 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h4></li>
</ol>
<p><strong>数据卷（volume）</strong>是一个虚拟目录，是<strong>容器内目录</strong>与<strong>宿主机目录</strong>之间映射的桥梁。</p>
<p>以Nginx为例，我们知道Nginx中有两个关键的目录：</p>
<ul>
<li><code>html</code>：放置一些静态资源</li>
<li><code>conf</code>：放置配置文件</li>
</ul>
<p>如果我们要让Nginx代理我们的静态资源，最好是放到<code>html</code>目录；如果我们要修改Nginx的配置，最好是找到<code>conf</code>下的<code>nginx.conf</code>文件。</p>
<p>但遗憾的是，容器运行的Nginx所有的文件都在容器内部。所以我们必须利用数据卷将两个目录与宿主机目录关联，方便我们操作。</p>
<p><strong>如图：</strong></p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=OGRkNDM4ODQ0ZTg3YjhkNzI5ODE5M2RkMDQ1MmM2NDVfMFBSZVZ2YzcwaFllT3NRejBOcXkxM0pLTUlEOTdUa1BfVG9rZW46WVo2bWJzbHVVbzlNR0x4azBpN2NoNlY1blFiXzE3NDIwNDYzNTc6MTc0MjA0OTk1N19WNA" alt="img"></p>
<p>在上图中：</p>
<ul>
<li>我们创建了两个数据卷：<code>conf</code>、<code>html</code></li>
<li>Nginx容器内部的<code>conf</code>目录和<code>html</code>目录分别与两个数据卷关联。</li>
<li>而数据卷conf和html分别指向了宿主机的<code>/var/lib/docker/volumes/conf/_data</code>目录和<code>/var/lib/docker/volumes/html/_data</code>目录</li>
</ul>
<p>这样以来，容器内的<code>conf</code>和<code>html</code>目录就 与宿主机的<code>conf</code>和<code>html</code>目录关联起来，我们称为<strong>挂载</strong>。</p>
<p>此时，我们操作宿主机的<code>/var/lib/docker/volumes/html/_data</code>就是在操作容器内的<code>/usr/share/nginx/html/_data</code>目录。只要我们将静态资源放入宿主机对应目录，就可以被Nginx代理了。</p>
<p><strong>小提示</strong>：</p>
<p><code>/var/lib/docker/volumes</code>这个目录就是默认的存放所有容器数据卷的目录，其下再根据数据卷名称创建新目录，格式为<code>/数据卷名/_data</code>。</p>
<p><strong>为什么不让容器目录直接指向宿主机目录呢</strong>？</p>
<ul>
<li>因为直接指向宿主机目录就与宿主机强耦合了，如果切换了环境，宿主机目录就可能发生改变了。由于容器一旦创建，目录挂载就无法修改，这样容器就无法正常工作了。</li>
<li>但是容器指向数据卷，一个逻辑名称，而数据卷再指向宿主机目录，就不存在强耦合。如果宿主机目录发生改变，只要改变数据卷与宿主机目录之间的映射关系即可。</li>
</ul>
<p>不过，我们通过由于数据卷目录比较深，不好寻找，通常我们也<strong>允许让容器直接与宿主机目录挂载而不使用数据卷</strong>，具体参考2.2.3小节。</p>
<ol>
<li><h4 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h4></li>
</ol>
<p>数据卷的相关命令有：</p>
<table>
<thead>
<tr>
<th align="left"><strong>命令</strong></th>
<th align="left"><strong>说明</strong></th>
<th align="left"><strong>文档地址</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">docker volume create</td>
<td align="left">创建数据卷</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/volume_create/">docker volume create</a></td>
</tr>
<tr>
<td align="left">docker volume ls</td>
<td align="left">查看所有数据卷</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/volume_ls/">docs.docker.com</a></td>
</tr>
<tr>
<td align="left">docker volume rm</td>
<td align="left">删除指定数据卷</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/volume_prune/">docs.docker.com</a></td>
</tr>
<tr>
<td align="left">docker volume inspect</td>
<td align="left">查看某个数据卷的详情</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/volume_inspect/">docs.docker.com</a></td>
</tr>
<tr>
<td align="left">docker volume prune</td>
<td align="left">清除数据卷</td>
<td align="left"><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/reference/commandline/volume_prune/">docker volume prune</a></td>
</tr>
</tbody></table>
<p>注意：容器与数据卷的挂载要在创建容器时配置，对于创建好的容器，是不能设置数据卷的。而且<strong>创建容器的过程中，数据卷会自动创建</strong>。</p>
<p>教学<strong>演示环节</strong>：演示一下nginx的html目录挂载</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.首先创建容器并指定数据卷，注意通过 -v 参数来指定数据卷</span></span><br><span class="line">docker run <span class="literal">-d</span> <span class="literal">--name</span> nginx <span class="literal">-p</span> <span class="number">80</span>:<span class="number">80</span> <span class="literal">-v</span> html:/usr/share/nginx/html nginx:<span class="number">1.20</span>.<span class="number">2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.然后查看数据卷</span></span><br><span class="line">docker volume <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.查看数据卷详情</span></span><br><span class="line">docker volume inspect html</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.查看/var/lib/docker/volumes/html/_data目录</span></span><br><span class="line">ll /var/lib/docker/volumes/html/_data</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 5.进入该目录，并随意修改index.html内容</span></span><br><span class="line"><span class="built_in">cd</span> /var/lib/docker/volumes/html/_data</span><br><span class="line">vi index.html</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6.打开页面，查看效果</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 7.进入容器内部，查看/usr/share/nginx/html目录内的文件是否变化</span></span><br><span class="line">docker exec <span class="literal">-it</span> nginx bash</span><br></pre></td></tr></table></figure>

<p>教学<strong>演示环节</strong>：演示一下MySQL的匿名数据卷</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.查看MySQL容器详细信息</span></span><br><span class="line">docker inspect mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关注其中.Config.Volumes部分和.Mounts部分</span></span><br></pre></td></tr></table></figure>

<p>我们关注两部分内容，第一是<code>.Config.Volumes</code>部分：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;Config&quot;</span>: &#123;</span><br><span class="line">    // ... 略</span><br><span class="line">    <span class="string">&quot;Volumes&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;/var/lib/mysql&quot;</span>: &#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line">    // ... 略</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现这个容器声明了一个本地目录，需要挂载数据卷，但是<strong>数据卷未定义</strong>。这就是匿名卷。</p>
<p>然后，我们再看结果中的<code>.Mounts</code>部分：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;Mounts&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;volume&quot;</span>,</span><br><span class="line">      <span class="string">&quot;Name&quot;</span>: <span class="string">&quot;29524ff09715d3688eae3f99803a2796558dbd00ca584a25a4bbc193ca82459f&quot;</span>,</span><br><span class="line">      <span class="string">&quot;Source&quot;</span>: <span class="string">&quot;/var/lib/docker/volumes/29524ff09715d3688eae3f99803a2796558dbd00ca584a25a4bbc193ca82459f/_data&quot;</span>,</span><br><span class="line">      <span class="string">&quot;Destination&quot;</span>: <span class="string">&quot;/var/lib/mysql&quot;</span>,</span><br><span class="line">      <span class="string">&quot;Driver&quot;</span>: <span class="string">&quot;local&quot;</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以发现，其中有几个关键属性：</p>
<ul>
<li>Name：数据卷名称。由于定义容器未设置容器名，这里的就是匿名卷自动生成的名字，一串hash值。</li>
<li>Source：宿主机目录</li>
<li>Destination : 容器内的目录</li>
</ul>
<p>上述配置是将容器内的<code>/var/lib/mysql</code>这个目录，与数据卷<code>29524ff09715d3688eae3f99803a2796558dbd00ca584a25a4bbc193ca82459f</code>挂载。于是在宿主机中就有了<code>/var/lib/docker/volumes/29524ff09715d3688eae3f99803a2796558dbd00ca584a25a4bbc193ca82459f/_data</code>这个目录。这就是匿名数据卷对应的目录，其使用方式与普通数据卷没有差别。</p>
<p>接下来，可以查看该目录下的MySQL的data文件：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">ls</span> <span class="literal">-l</span> /var/lib/docker/volumes/<span class="number">29524</span>ff09715d3688eae3f99803a2796558dbd00ca584a25a4bbc193ca82459f/_data</span><br></pre></td></tr></table></figure>

<p>注意：每一个不同的镜像，将来创建容器后内部有哪些目录可以挂载，可以参考DockerHub对应的页面 。</p>
<ol>
<li><h4 id="挂载本地目录或文件"><a href="#挂载本地目录或文件" class="headerlink" title="挂载本地目录或文件"></a>挂载本地目录或文件</h4></li>
</ol>
<p>可以发现，数据卷的目录结构较深，如果我们去操作数据卷目录会不太方便。在很多情况下，我们会直接将容器目录与宿主机指定目录挂载。挂载语法与数据卷类似：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 挂载本地目录</span></span><br><span class="line"><span class="literal">-v</span> 本地目录:容器内目录</span><br><span class="line"></span><br><span class="line"><span class="comment"># 挂载本地文件</span></span><br><span class="line"><span class="literal">-v</span> 本地文件:容器内文件</span><br></pre></td></tr></table></figure>

<p><strong>注意</strong>：本地目录或文件必须以 <code>/</code> 或 <code>./</code>开头，如果直接以名字开头，会被识别为数据卷名而非本地目录名。</p>
<p><strong>例如：</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="literal">-v</span> mysql:/var/lib/mysql <span class="comment"># 会被识别为一个数据卷叫mysql，运行时会自动创建这个数据卷</span></span><br><span class="line"></span><br><span class="line"><span class="literal">-v</span> ./mysql:/var/lib/mysql <span class="comment"># 会被识别为当前目录下的mysql目录，运行时如果不存在会创建目录</span></span><br></pre></td></tr></table></figure>

<p><strong>教学演示</strong>，删除并重新创建mysql容器，并完成本地目录挂载：</p>
<ul>
<li>挂载<code>/root/mysql/data</code>到容器内的<code>/var/lib/mysql</code>目录</li>
<li>挂载<code>/root/mysql/init</code>到容器内的<code>/docker-entrypoint-initdb.d</code>目录（初始化的SQL脚本目录）</li>
<li>挂载<code>/root/mysql/conf</code>到容器内的<code>/etc/mysql/conf.d</code>目录（这个是MySQL配置文件目录）</li>
</ul>
<p>在课前资料中已经准备好了mysql 的<code>init</code>目录、<code>conf</code>目录、<code>data</code>目录，可以直接将其上传到Linux服务器中的 &#x2F;root&#x2F;mysql 目录下。</p>
<p>最终执行的指令如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line"><span class="literal">--name</span> mysql \</span><br><span class="line"><span class="literal">-p</span> <span class="number">3307</span>:<span class="number">3306</span> \</span><br><span class="line"><span class="literal">-e</span> MYSQL_ROOT_PASSWORD=<span class="number">123</span> \</span><br><span class="line"><span class="literal">-e</span> TZ=Asia/Shanghai \</span><br><span class="line"><span class="literal">-v</span> /root/mysql/<span class="keyword">data</span>:/var/lib/mysql \</span><br><span class="line"><span class="literal">-v</span> /root/mysql/init:/docker<span class="literal">-entrypoint-initdb</span>.d \</span><br><span class="line"><span class="literal">-v</span> /root/mysql/conf:/etc/mysql/conf.d \</span><br><span class="line">mysql:<span class="number">8</span></span><br></pre></td></tr></table></figure>

<ol>
<li><h3 id="自定义镜像"><a href="#自定义镜像" class="headerlink" title="自定义镜像"></a>自定义镜像</h3></li>
</ol>
<p>前面我们一直在使用别人准备好的镜像，那如果我要部署一个Java项目，把它打包为一个镜像该怎么做呢？ 那接下来，我们就来介绍一下如何自定义镜像。</p>
<ol>
<li><h4 id="镜像结构"><a href="#镜像结构" class="headerlink" title="镜像结构"></a>镜像结构</h4></li>
</ol>
<p>要想自己构建镜像，必须先了解镜像的结构。</p>
<p>之前我们说过，镜像之所以能让我们快速跨操作系统部署应用而忽略其运行环境、配置，就是因为镜像中包含了程序运行需要的系统函数库、环境、配置、依赖。</p>
<p>因此，自定义镜像本质就是依次准备好程序运行的基础环境、依赖、应用本身、运行配置等文件，并且打包而成。</p>
<p>举个例子，我们要从0部署一个Java应用，大概流程是这样：</p>
<ul>
<li>准备一个linux服务（CentOS或者Ubuntu均可）</li>
<li>安装并配置JDK</li>
<li>上传Jar包</li>
<li>运行jar包</li>
</ul>
<p>那因此，我们打包镜像也是分成这么几步：</p>
<ul>
<li>准备Linux运行环境（java项目并不需要完整的操作系统，仅仅是基础运行环境即可）</li>
<li>安装并配置JDK</li>
<li>拷贝jar包</li>
<li>配置启动脚本</li>
</ul>
<p>上述步骤中的每一次操作其实都是在生产一些文件（系统运行环境、函数库、配置最终都是磁盘文件），所以<strong>镜像就是一堆文件的集合</strong>。</p>
<p>但需要注意的是，镜像文件不是随意堆放的，而是按照操作的步骤分层叠加而成，每一层形成的文件都会单独打包并标记一个唯一id，称为<strong>Layer</strong>（<strong>层</strong>）。这样，如果我们构建时用到的某些层其他人已经制作过，就可以直接拷贝使用这些层，而不用重复制作。</p>
<p>例如，第一步中需要的Linux运行环境，通用性就很强，所以Docker官方就制作了这样的只包含Linux运行环境的镜像。我们在制作java镜像时，就无需重复制作，直接使用Docker官方提供的CentOS或Ubuntu镜像作为基础镜像。然后再搭建其它层即可，这样逐层搭建，最终整个Java项目的镜像结构如图所示：</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=YzFjMzhiZGI4NjQ4ZWM3ZDQ2ZGQxZTRjMTA4N2NjMzhfTmJySTVaU250MEp4eW1EMHpDVW1OVkRMSGhQZ1NUZkxfVG9rZW46RkRzUWJNOFJHb3cwU2x4U01ic2M4VEZDblRnXzE3NDIwNDYzNTc6MTc0MjA0OTk1N19WNA" alt="img"></p>
<ol>
<li><h4 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h4></li>
</ol>
<p>由于制作镜像的过程中，需要逐层处理和打包，比较复杂，所以Docker就提供了自动打包镜像的功能。我们只需要将打包的过程，每一层要做的事情用固定的语法写下来，交给Docker去执行即可。而这种记录镜像结构的文件就称为<strong>Dockerfile。</strong></p>
<p>其中的语法比较多，比较常用的有：</p>
<table>
<thead>
<tr>
<th align="left"><strong>指令</strong></th>
<th align="left"><strong>说明</strong></th>
<th align="left"><strong>示例</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left"><strong>FROM</strong></td>
<td align="left">指定基础镜像</td>
<td align="left"><code>FROM centos:7</code></td>
</tr>
<tr>
<td align="left"><strong>ENV</strong></td>
<td align="left">设置环境变量，可在后面指令使用</td>
<td align="left"><code>ENV key value</code></td>
</tr>
<tr>
<td align="left"><strong>COPY</strong></td>
<td align="left">拷贝本地文件到镜像的指定目录</td>
<td align="left"><code>COPY ./xx.jar /tmp/app.jar</code></td>
</tr>
<tr>
<td align="left"><strong>RUN</strong></td>
<td align="left">执行Linux的shell命令，一般是安装过程的命令</td>
<td align="left"><code>RUN yum install gcc</code></td>
</tr>
<tr>
<td align="left"><strong>EXPOSE</strong></td>
<td align="left">指定容器运行时监听的端口，是给镜像使用者看的</td>
<td align="left">EXPOSE 8080</td>
</tr>
<tr>
<td align="left"><strong>ENTRYPOINT</strong></td>
<td align="left">镜像中应用的启动命令，容器运行时调用</td>
<td align="left">ENTRYPOINT java -jar xx.jar</td>
</tr>
</tbody></table>
<p>例如，要基于 centos:7 镜像来构建一个Java应用，其Dockerfile内容如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 CentOS 7 作为基础镜像</span></span><br><span class="line">FROM centos:<span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加 JDK 到镜像中</span></span><br><span class="line"><span class="built_in">COPY</span> jdk17.tar.gz /usr/local/</span><br><span class="line">RUN tar <span class="literal">-xzf</span> /usr/local/jdk17.tar.gz <span class="literal">-C</span> /usr/local/ &amp;&amp;  <span class="built_in">rm</span> /usr/local/jdk17.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line">ENV JAVA_HOME=/usr/local/jdk<span class="literal">-17</span>.<span class="number">0.10</span></span><br><span class="line">ENV PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建应用目录</span></span><br><span class="line">RUN mkdir <span class="literal">-p</span> /app</span><br><span class="line">WORKDIR /app</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制应用 JAR 文件到容器</span></span><br><span class="line"><span class="built_in">COPY</span> app.jar app.jar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露端口</span></span><br><span class="line">EXPOSE <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行命令</span></span><br><span class="line">ENTRYPOINT [<span class="string">&quot;java&quot;</span>,<span class="string">&quot;-Djava.security.egd=file:/dev/./urandom&quot;</span>,<span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;/app/app.jar&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>Dockerfile文件编写好了之后，就可以使用如下命令来构建镜像了。</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build <span class="literal">-t</span> 镜像名 .</span><br></pre></td></tr></table></figure>

<ul>
<li>-t ：是给镜像起名，格式依然是repository:tag的格式，不指定tag时，默认为latest</li>
<li>.  ：是指定Dockerfile所在目录，如果就在当前目录，则指定为”.”</li>
</ul>
<p><strong>演示:</strong></p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=MDBmNGE1MGZhNjAyNDgzNzQyYzIwZWIwNzY0M2MzOWRfQnpTVTBYSTNYTTVyYjRSWVBVSlZlOGM2THdpVUljZDhfVG9rZW46TkJ4TGI0VE8zb2Z3Zmh4UWs4dWNrWXdyblBoXzE3NDIwNDYzNTc6MTc0MjA0OTk1N19WNA" alt="img"></p>
<ol>
<li><h3 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h3></li>
</ol>
<p>上节课我们创建了一个Java项目的容器，而Java项目往往需要访问其它各种中间件，例如MySQL、Redis等。现在，我们的容器之间能否互相访问呢？我们来测试一下</p>
<p>首先，我们查看下MySQL容器的详细信息，重点关注其中的网络IP地址：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.用基本命令，寻找Networks.bridge.IPAddress属性</span></span><br><span class="line">docker inspect mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 也可以使用format过滤结果</span></span><br><span class="line">docker inspect <span class="literal">--format</span>=<span class="string">&#x27;&#123;&#123;range .NetworkSettings.Networks&#125;&#125;&#123;&#123;println .IPAddress&#125;&#125;&#123;&#123;end&#125;&#125;&#x27;</span> mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 得到IP地址如下：</span></span><br><span class="line"><span class="number">172.17</span>.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.然后通过命令进入dd容器</span></span><br><span class="line">docker exec <span class="literal">-it</span> dd bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.在容器内，通过ping命令测试网络</span></span><br><span class="line">ping <span class="number">172.17</span>.<span class="number">0.2</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果</span></span><br><span class="line">PING <span class="number">172.17</span>.<span class="number">0.2</span> (<span class="number">172.17</span>.<span class="number">0.2</span>) <span class="number">56</span>(<span class="number">84</span>) bytes of <span class="keyword">data</span>.</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">172.17</span>.<span class="number">0.2</span>: icmp_seq=<span class="number">1</span> ttl=<span class="number">64</span> time=<span class="number">0.053</span> ms</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">172.17</span>.<span class="number">0.2</span>: icmp_seq=<span class="number">2</span> ttl=<span class="number">64</span> time=<span class="number">0.059</span> ms</span><br><span class="line"><span class="number">64</span> bytes from <span class="number">172.17</span>.<span class="number">0.2</span>: icmp_seq=<span class="number">3</span> ttl=<span class="number">64</span> time=<span class="number">0.058</span> ms</span><br></pre></td></tr></table></figure>

<p>发现可以互联，没有问题。</p>
<p>但是，容器的网络IP其实是一个虚拟的IP，其值并不固定与某一个容器绑定，如果我们在开发时写死某个IP，而在部署时很可能MySQL容器的IP会发生变化，连接会失败。</p>
<p>常见命令有：</p>
<table>
<thead>
<tr>
<th align="left"><strong>命令</strong></th>
<th align="left"><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">docker network create</td>
<td align="left">创建一个网络</td>
</tr>
<tr>
<td align="left">docker network ls</td>
<td align="left">查看所有网络</td>
</tr>
<tr>
<td align="left">docker network rm</td>
<td align="left">删除指定网络</td>
</tr>
<tr>
<td align="left">docker network prune</td>
<td align="left">清除未使用的网络</td>
</tr>
<tr>
<td align="left">docker network connect</td>
<td align="left">使指定容器连接加入某网络</td>
</tr>
<tr>
<td align="left">docker network disconnect</td>
<td align="left">使指定容器连接离开某网络</td>
</tr>
<tr>
<td align="left">docker network inspect</td>
<td align="left">查看网络详细信息</td>
</tr>
</tbody></table>
<p><strong>教学演示：自定义网络</strong></p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.首先通过命令创建一个网络</span></span><br><span class="line">docker network create itheima</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.然后查看网络</span></span><br><span class="line">docker network <span class="built_in">ls</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果：</span></span><br><span class="line">NETWORK ID     NAME      DRIVER    SCOPE</span><br><span class="line"><span class="number">639</span>bc44d0a87   bridge    bridge    local</span><br><span class="line"><span class="number">403</span>f16ec62a2   itheima     bridge    local</span><br><span class="line"><span class="number">0</span>dc0f72a0fbb   host      host      local</span><br><span class="line">cd8d3e8df47b   none      null      local</span><br><span class="line"><span class="comment"># 其中，除了itheima以外，其它都是默认的网络</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.让 myapp 和 mysql 都加入该网络</span></span><br><span class="line"><span class="comment"># 3.1.mysql容器，加入 itheima 网络</span></span><br><span class="line">docker network connect itheima mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.2.myapp容器，也就是我们的java项目, 加入 itheima 网络</span></span><br><span class="line">docker network connect itheima myapp</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.进入dd容器，尝试利用别名访问db</span></span><br><span class="line"><span class="comment"># 4.1.进入容器</span></span><br><span class="line">docker exec <span class="literal">-it</span> myapp bash</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.2.用容器名访问</span></span><br><span class="line">ping mysql</span><br><span class="line"></span><br><span class="line"><span class="comment"># 结果：</span></span><br><span class="line">PING mysql (<span class="number">172.18</span>.<span class="number">0.2</span>) <span class="number">56</span>(<span class="number">84</span>) bytes of <span class="keyword">data</span>.</span><br><span class="line"><span class="number">64</span> bytes from mysql.itheima (<span class="number">172.18</span>.<span class="number">0.2</span>): icmp_seq=<span class="number">1</span> ttl=<span class="number">64</span> time=<span class="number">0.044</span> ms</span><br><span class="line"><span class="number">64</span> bytes from mysql.itheima (<span class="number">172.18</span>.<span class="number">0.2</span>): icmp_seq=<span class="number">2</span> ttl=<span class="number">64</span> time=<span class="number">0.054</span> ms</span><br></pre></td></tr></table></figure>

<p>OK，现在无需记住IP地址也可以实现容器互联了。</p>
<ol>
<li><h2 id="项目部署"><a href="#项目部署" class="headerlink" title="项目部署"></a>项目部署</h2></li>
<li><h3 id="部署服务端"><a href="#部署服务端" class="headerlink" title="部署服务端"></a>部署服务端</h3></li>
</ol>
<ul>
<li>需求：将我们开发的 tlias-web-management 项目打包为镜像，并部署。</li>
<li>步骤：<ul>
<li>修改项目的配置文件，修改数据库服务地址（打包package）。</li>
<li>编写Dockerfile文件（AI辅助）。</li>
<li>构建Docker镜像，部署Docker容器，运行测试。</li>
</ul>
</li>
</ul>
<p><strong>1). 修改项目的配置文件，修改数据库服务地址（打包package）。</strong></p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTJlZjUyYTZhZDY3YmM4NGYzODVjYmNlODIxZTU5MGFfdmNQNnNjOTdDUmQ5MnAzTVlOd1ViNEVvYmZXUEFveGxfVG9rZW46Q3RSUWJYalFwb3Zxdlp4V0p1c2M1d0ptbnNQXzE3NDIwNDYzNTc6MTc0MjA0OTk1N19WNA" alt="img"></p>
<p>然后，执行maven中的package生命周期，进行打包(<strong>跳过测试</strong>)，并将打包后的jar包命名为 tlias.jar 。</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=M2UzZDY1Zjk3NTg2YTQ5YmYyNmU4YjhkZTZkNDhjYTVfYXlkZnI1Rmxma1g3SHpKbjViNEt5dnpmdVJSWXhTTENfVG9rZW46VzlScmJJU1pYb25nZm94QTJ0TGMzWHZmbmZRXzE3NDIwNDYzNTc6MTc0MjA0OTk1N19WNA" alt="img"></p>
<p><strong>2). 编写Dockerfile文件<strong><strong>（AI辅助）</strong></strong>。</strong></p>
<p>文件名 Dockerfile: </p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 使用 CentOS 7 作为基础镜像</span></span><br><span class="line">FROM centos:<span class="number">7</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 添加 JDK 到镜像中</span></span><br><span class="line"><span class="built_in">COPY</span> jdk17.tar.gz /usr/local/</span><br><span class="line">RUN tar <span class="literal">-xzf</span> /usr/local/jdk17.tar.gz <span class="literal">-C</span> /usr/local/ &amp;&amp;  <span class="built_in">rm</span> /usr/local/jdk17.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置环境变量</span></span><br><span class="line">ENV JAVA_HOME=/usr/local/jdk<span class="literal">-17</span>.<span class="number">0.10</span></span><br><span class="line">ENV PATH=<span class="variable">$JAVA_HOME</span>/bin:<span class="variable">$PATH</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 阿里云OSS环境变量</span></span><br><span class="line">ENV OSS_ACCESS_KEY_ID=*****</span><br><span class="line">ENV OSS_ACCESS_KEY_SECRET=*****</span><br><span class="line"></span><br><span class="line"><span class="comment">#统一编码</span></span><br><span class="line">ENV LANG=en_US.UTF<span class="literal">-8</span></span><br><span class="line">ENV LANGUAGE=en_US:en</span><br><span class="line">ENV LC_ALL=en_US.UTF<span class="literal">-8</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建应用目录</span></span><br><span class="line">RUN mkdir <span class="literal">-p</span> /tlias</span><br><span class="line">WORKDIR /tlias</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制应用 JAR 文件到容器</span></span><br><span class="line"><span class="built_in">COPY</span>  tlias.jar  tlias.jar</span><br><span class="line"></span><br><span class="line"><span class="comment"># 暴露端口</span></span><br><span class="line">EXPOSE <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 运行命令</span></span><br><span class="line">ENTRYPOINT [<span class="string">&quot;java&quot;</span>,<span class="string">&quot;-jar&quot;</span>,<span class="string">&quot;/tlias/tlias.jar&quot;</span>]</span><br></pre></td></tr></table></figure>

<p>由于项目要运行，需要依赖jdk的环境，所以这里我们需要将tlias.jar，jdk17.tar.gz，Dockerfile三个文件，上传到Linux服务器的 &#x2F;root&#x2F;tlias 目录下（如果没有这个目录，提前创建好）。</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=ZmJkMDg1YjhhOTE4Nzk0OWM4NzVhNTBmYjNmNzlhMTRfM3I2UkJmUWt1NmFaTDRHd0hqN3dtWTdpaUFscTVNejRfVG9rZW46U1lXVGJwd0RTbzhEbm54aUNrd2NFQzZ5bkVmXzE3NDIwNDYzNTc6MTc0MjA0OTk1N19WNA" alt="img"></p>
<p><strong>3). 构建Docker镜像，部署Docker容器，运行测试。</strong></p>
<ul>
<li>构建Docker镜像</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build <span class="literal">-t</span> tlias:<span class="number">1.0</span> .</span><br></pre></td></tr></table></figure>

<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=Mjg3NGUxYTgwMTEwZGM2NDc2NTgyYzAzMTFlZWIwYTFfQ213VFZDT1hRQ0xwZHc0Y2tDemZtSjE4VjdYY3pXbE5fVG9rZW46SzR2RGJUWHFGb2RRMkh4Qnl0QWMzZTRCbk1jXzE3NDIwNDYzNTc6MTc0MjA0OTk1N19WNA" alt="img"></p>
<ul>
<li>部署Docker容器</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> <span class="literal">--name</span> tlias<span class="literal">-server</span> <span class="literal">--network</span> itheima <span class="literal">-p</span> <span class="number">8080</span>:<span class="number">8080</span>  tlias:<span class="number">1.0</span></span><br></pre></td></tr></table></figure>

<p>–network  itheima ：将创建的容器，加入到itheima网络，就可以和itheima网络中的容器通信了。</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=ZWFiYzE1MWFlYTg2ZGYxZTAwZjM3NjI2MGU1MGRmYjJfMW5QRVRVMjR6a3I1bzlJUkVjSlFBUG1lMHJRR1RCWk1fVG9rZW46RnpJQmJGYVlSb3FYV3J4VkpYQmNFdWR1blJlXzE3NDIwNDYzNTc6MTc0MjA0OTk1N19WNA" alt="img"></p>
<p>通过 <code>docker logs -f 容器名</code>，就可以查看容器的运行日志。</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=OWMwZDZjMDkyN2IzNzcxZGZhYmUzZGZlOTgyN2E4ZGVfNFNhWGphUkIyZ2wwcFMzTTA2TEpDTmJNWU1GRkFXcnRfVG9rZW46SnZCZGJNTTlSb05pY3B4NEh4eGN2M1Vkbk5mXzE3NDIwNDYzNTc6MTc0MjA0OTk1N19WNA" alt="img"></p>
<p>这样后端服务，就已经启动起来了。</p>
<ol>
<li><h3 id="部署前端"><a href="#部署前端" class="headerlink" title="部署前端"></a>部署前端</h3></li>
</ol>
<ul>
<li>需求：创建一个新的nginx容器，将资料中提供的前端项目的静态资源部署到nginx中。</li>
<li>步骤：<ul>
<li>在宿主机上准备静态文件及配置文件存放目录(在 <code>/usr/local</code> 目录下创建 <code>tlias-web</code> 目录)。<ul>
<li><p><code>-v /usr/local/tlias-web/html:/usr/share/nginx/html</code> </p>
</li>
<li><p><code>-v /usr/local/tlias-web/conf/nginx.conf:/etc/nginx/nginx.conf</code></p>
</li>
</ul>
</li>
<li>部署nginx容器</li>
</ul>
</li>
</ul>
<p><strong>1). 部署nginx容器（设置目录映射）。</strong></p>
<ul>
<li>将资 <strong>资料&#x2F;04. 项目部署&#x2F;前端项目</strong> 中的 目录<code>html</code>和 配置文件存放目录 <code>conf</code>，上传至服务器端的 <code>/usr/local/tlias-web</code>目录下。</li>
</ul>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=OWRhY2FlODdhODdjMzc3NWRiNTBhYjNiOTQ4MmVjNzVfZkpzWEdwVkZNN3czb0s5d09HYlJxYVBzSGUySmdacHBfVG9rZW46QXVaV2JSU2ZMb1c2dXB4REJwN2NjTkdtbmFoXzE3NDIwNDYzNTc6MTc0MjA0OTk1N19WNA" alt="img"></p>
<ul>
<li>执行如下命令，部署nginx容器</li>
</ul>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line"><span class="literal">--name</span> nginx<span class="literal">-tlias</span> \</span><br><span class="line"><span class="literal">-v</span> /usr/local/tlias<span class="literal">-web</span>/html:/usr/share/nginx/html \</span><br><span class="line"><span class="literal">-v</span> /usr/local/tlias<span class="literal">-web</span>/conf/nginx.conf:/etc/nginx/nginx.conf \</span><br><span class="line"><span class="literal">--network</span> itheima \</span><br><span class="line"><span class="literal">-p</span> <span class="number">80</span>:<span class="number">80</span> \</span><br><span class="line">nginx:<span class="number">1.20</span>.<span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>前后端都部署完毕后，就可以打开浏览器，来测试一下。访问前端的nginx服务器 。</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=MzVhZmJiYjUxM2Y2MmYwZDAzMmVlMjZhZGFiNTA5MThfT0VhSkhpMURoVXZzQll5alVOMjdXcHFKbEpIeThwQlJfVG9rZW46SUpyYWJTN1Nyb0laNGp4dTlzZ2NPNXRUbkVmXzE3NDIwNDYzNTc6MTc0MjA0OTk1N19WNA" alt="img"></p>
<ol>
<li><h3 id="DockerCompose"><a href="#DockerCompose" class="headerlink" title="DockerCompose"></a>DockerCompose</h3></li>
</ol>
<p>大家可以看到，我们部署一个简单的java项目，其中包含3个容器：</p>
<ul>
<li>MySQL</li>
<li>Nginx</li>
<li>Java项目</li>
</ul>
<p>而稍微复杂的项目，其中还会有各种各样的其它中间件，需要部署的东西远不止3个。如果还像之前那样手动的逐一部署，就太麻烦了。</p>
<p>而Docker Compose就可以帮助我们实现<strong>多个相互关联的Docker容器的快速部署</strong>。它允许用户通过一个单独的 docker-compose.yml 模板文件（YAML 格式）来定义一组相关联的应用容器。</p>
<ol>
<li><h4 id="基本语法"><a href="#基本语法" class="headerlink" title="基本语法"></a>基本语法</h4></li>
</ol>
<p>docker-compose文件中可以定义多个相互关联的应用容器，每一个应用容器被称为一个服务（service）。由于service就是在定义某个应用的运行时参数，因此与<code>docker run</code>参数非常相似。</p>
<p>举例来说，用docker run部署MySQL的命令如下：</p>
<figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">docker run <span class="literal">-d</span> \</span><br><span class="line"><span class="literal">--name</span> nginx<span class="literal">-tlias</span> \</span><br><span class="line"><span class="literal">-p</span> <span class="number">80</span>:<span class="number">80</span> \</span><br><span class="line"><span class="literal">-v</span> /usr/local/app/html:/usr/share/nginx/html \</span><br><span class="line"><span class="literal">-v</span> /usr/local/app/conf/nginx.conf:/etc/nginx/nginx.conf \  </span><br><span class="line"><span class="literal">--network</span> itheima \</span><br><span class="line">nginx:<span class="number">1.20</span>.<span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>如果用<code>docker-compose.yml</code>文件来定义，就是这样：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">&quot;nginx:1.20.2&quot;</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx-tlias</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/html:/usr/share/nginx/html&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/conf/nginx.conf:/etc/nginx/nginx.conf&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">itheima</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">itheima:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">itheima</span></span><br></pre></td></tr></table></figure>

<p>对比如下：</p>
<table>
<thead>
<tr>
<th align="left"><strong>docker run 参数</strong></th>
<th align="left"><strong>docker compose 指令</strong></th>
<th align="left"><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">–name</td>
<td align="left">container_name</td>
<td align="left">容器名称</td>
</tr>
<tr>
<td align="left">-p</td>
<td align="left">ports</td>
<td align="left">端口映射</td>
</tr>
<tr>
<td align="left">-e</td>
<td align="left">environment</td>
<td align="left">环境变量</td>
</tr>
<tr>
<td align="left">-v</td>
<td align="left">volumes</td>
<td align="left">数据卷配置</td>
</tr>
<tr>
<td align="left">–network</td>
<td align="left">networks</td>
<td align="left">网络</td>
</tr>
</tbody></table>
<p>明白了其中的对应关系，相信编写<code>docker-compose</code>文件应该难不倒大家。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">services:</span></span><br><span class="line">  <span class="attr">mysql:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">mysql:8</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">mysql</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;3307:3306&quot;</span></span><br><span class="line">    <span class="attr">environment:</span></span><br><span class="line">      <span class="attr">TZ:</span> <span class="string">Asia/Shanghai</span></span><br><span class="line">      <span class="attr">MYSQL_ROOT_PASSWORD:</span> <span class="number">123</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/mysql/conf:/etc/mysql/conf.d&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/mysql/data:/var/lib/mysql&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/mysql/init:/docker-entrypoint-initdb.d&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tlias-net</span></span><br><span class="line">  <span class="attr">tlias:</span></span><br><span class="line">    <span class="attr">build:</span> </span><br><span class="line">      <span class="attr">context:</span> <span class="string">.</span></span><br><span class="line">      <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">tlias-server</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;8080:8080&quot;</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tlias-net</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">mysql</span></span><br><span class="line">  <span class="attr">nginx:</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx:1.20.2</span></span><br><span class="line">    <span class="attr">container_name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">ports:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;80:80&quot;</span></span><br><span class="line">    <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/nginx/conf/nginx.conf:/etc/nginx/nginx.conf&quot;</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">&quot;/usr/local/app/nginx/html:/usr/share/nginx/html&quot;</span></span><br><span class="line">    <span class="attr">depends_on:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tlias</span></span><br><span class="line">    <span class="attr">networks:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">tlias-net</span></span><br><span class="line"><span class="attr">networks:</span></span><br><span class="line">  <span class="attr">tlias-net:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">itheima</span></span><br></pre></td></tr></table></figure>

<ol>
<li><h4 id="基础命令"><a href="#基础命令" class="headerlink" title="基础命令"></a>基础命令</h4></li>
</ol>
<p>编写好docker-compose.yml文件，就可以部署项目了。语法如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">docker</span> <span class="string">compose</span> [<span class="string">OPTIONS</span>] [<span class="string">COMMAND</span>]</span><br></pre></td></tr></table></figure>

<p>其中，OPTIONS和COMMAND都是可选参数，比较常见的有：</p>
<table>
<thead>
<tr>
<th align="left"><strong>类型</strong></th>
<th align="left"><strong>参数或指令</strong></th>
<th align="left"><strong>说明</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="left">Options</td>
<td align="left">-f</td>
<td align="left">指定compose文件的路径和名称</td>
</tr>
<tr>
<td align="left">-p</td>
<td align="left">指定project名称。project就是当前compose文件中设置的多个service的集合，是逻辑概念</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">Commands</td>
<td align="left">up</td>
<td align="left">创建并启动所有service容器</td>
</tr>
<tr>
<td align="left">down</td>
<td align="left">停止并移除所有容器、网络</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">ps</td>
<td align="left">列出所有启动的容器</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">logs</td>
<td align="left">查看指定容器的日志</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">stop</td>
<td align="left">停止容器</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">start</td>
<td align="left">启动容器</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">restart</td>
<td align="left">重启容器</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">top</td>
<td align="left">查看运行的进程</td>
<td align="left"></td>
</tr>
<tr>
<td align="left">exec</td>
<td align="left">在指定的运行中容器中执行命令</td>
<td align="left"></td>
</tr>
</tbody></table>
<ol>
<li><h4 id="操作演示"><a href="#操作演示" class="headerlink" title="操作演示"></a>操作演示</h4></li>
</ol>
<p>1). 在 Linux 服务器的 <code>/usr/local</code> 目录下创建目录 app，并切换到 <code>/usr/local/app</code> 目录。</p>
<p>2). 上传资料中提供的 “资料&#x2F;05. Docker Compose” 中的文件及文件夹到 <code>/usr/local/app</code> 目录中，如下所示：</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=OTRkMmFjMWZiZmJmZDViZDRhOWEzMzFkNTBjNjlkNzNfV3g0WkJhUkpnSVNRWHBiRHlxY0wyNHUwdk5NNHBscTVfVG9rZW46T2VFMWJ3bmtEb3d0eld4RVBGTWN3NmhJbjRnXzE3NDIwNDYzNTc6MTc0MjA0OTk1N19WNA" alt="img"></p>
<p>注意，资料中提供的Dockerfile文件中的阿里云OSS的 AccessKeyId，AccessKeySecret需要替换成自己的。</p>
<p>3). 执行如下指令，基于DockerCompose部署项目。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">docker</span> <span class="string">compose</span> <span class="string">up</span> <span class="string">-d</span></span><br></pre></td></tr></table></figure>

<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=ZTUwNDdkZWI1ZTc4NmRlN2UyNWJjYTIzZTNlNGNkZWJfczc2OVlEWEp0S2RZV2ExTkx3SU0xSDBwNk9VVEZ4WU9fVG9rZW46Tm45ZmJHUVB6b0xiR2N4MWRvOGMyblU4bnViXzE3NDIwNDYzNTc6MTc0MjA0OTk1N19WNA" alt="img"></p>
<p>项目启动完毕之后，就可以启动服务器测试喽 。</p>
<p><img src="https://heuqqdmbyk.feishu.cn/space/api/box/stream/download/asynccode/?code=ZGJiOGI1MDhmZThiNTI1OTMyZjk4MGUyY2RjZTA1ZjBfSW9aT245d3lBQ2hSbkxnV0JtWVdpeWRlU1pDRGltaHhfVG9rZW46WTFQamJpdVo2b2RjMmN4eW15UWNGMUE1bkNlXzE3NDIwNDYzNTc6MTc0MjA0OTk1N19WNA" alt="img"></p>
<ol>
<li><h2 id="附录：Docker安装"><a href="#附录：Docker安装" class="headerlink" title="附录：Docker安装"></a>附录：Docker安装</h2></li>
<li><h3 id="卸载旧版"><a href="#卸载旧版" class="headerlink" title="卸载旧版"></a>卸载旧版</h3></li>
</ol>
<p>首先如果系统中已经存在旧的Docker，则先卸载：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">yum remove docker \</span><br><span class="line">    docker-client \</span><br><span class="line">    docker-client-latest \</span><br><span class="line">    docker-common \</span><br><span class="line">    docker-latest \</span><br><span class="line">    docker-latest-logrotate \</span><br><span class="line">    docker-logrotate \</span><br><span class="line">    docker-engine \</span><br><span class="line">    docker-selinux </span><br></pre></td></tr></table></figure>

<ol>
<li><h3 id="配置Docker的yum库"><a href="#配置Docker的yum库" class="headerlink" title="配置Docker的yum库"></a>配置Docker的yum库</h3></li>
</ol>
<p>首先要安装一个yum工具</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum install -y yum-utils device-mapper-persistent-data lvm2</span><br></pre></td></tr></table></figure>

<p>安装成功后，执行命令，配置Docker的yum源（已更新为阿里云源）：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"></span><br><span class="line"><span class="built_in">sudo</span> sed -i <span class="string">&#x27;s+download.docker.com+mirrors.aliyun.com/docker-ce+&#x27;</span> /etc/yum.repos.d/docker-ce.repo</span><br></pre></td></tr></table></figure>

<p>更新yum，建立缓存</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">sudo</span> yum makecache fast</span><br></pre></td></tr></table></figure>

<ol>
<li><h3 id="安装Docker"><a href="#安装Docker" class="headerlink" title="安装Docker"></a>安装Docker</h3></li>
</ol>
<p>最后，执行命令，安装Docker</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br></pre></td></tr></table></figure>

<ol>
<li><h3 id="启动和校验"><a href="#启动和校验" class="headerlink" title="启动和校验"></a>启动和校验</h3></li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动Docker</span></span><br><span class="line">systemctl start docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止Docker</span></span><br><span class="line">systemctl stop docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启</span></span><br><span class="line">systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置开机自启</span></span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行docker ps命令，如果不报错，说明安装启动成功</span></span><br><span class="line">docker ps</span><br></pre></td></tr></table></figure>

<ol>
<li><h3 id="配置镜像加速"><a href="#配置镜像加速" class="headerlink" title="配置镜像加速"></a>配置镜像加速</h3></li>
</ol>
<p>镜像地址可能会变更，如果失效可以百度找最新的docker镜像。</p>
<p>配置镜像步骤如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建目录</span></span><br><span class="line"><span class="built_in">rm</span> -f /etc/docker/daemon.json</span><br><span class="line"></span><br><span class="line"><span class="comment"># 复制内容</span></span><br><span class="line"><span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt;-<span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;registry-mirrors&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;http://hub-mirror.c.163.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://mirrors.tuna.tsinghua.edu.cn&quot;</span>,</span><br><span class="line">        <span class="string">&quot;http://mirrors.sohu.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://ustc-edu-cn.mirror.aliyuncs.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://ccr.ccs.tencentyun.com&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.m.daocloud.io&quot;</span>,</span><br><span class="line">        <span class="string">&quot;https://docker.awsl9527.cn&quot;</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重新加载配置</span></span><br><span class="line">systemctl daemon-reload</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启Docker</span></span><br><span class="line">systemctl restart docker</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/03/15/Docker%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/" data-id="cm8sja97300048ktb4gzf3a7i" data-title="Docker快速入门" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Springboot-创建对战列表和排行榜页面" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/01/24/Springboot-%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E5%92%8C%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/" class="article-date">
  <time class="dt-published" datetime="2025-01-24T09:00:42.000Z" itemprop="datePublished">2025-01-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Web/">Web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/01/24/Springboot-%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E5%92%8C%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/">Springboot-创建对战列表和排行榜页面</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>这部分的代码实现均在backend端。</p>
<h2 id="天梯积分更新"><a href="#天梯积分更新" class="headerlink" title="天梯积分更新"></a>天梯积分更新</h2><p>随着对战的结束，要相应的更新用户的天梯积分</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905101408875.png" alt="image-20220905101408875"></p>
<p>更新代码如下：</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905102514339.png" alt="image-20220905102514339"></p>
<h2 id="对局列表"><a href="#对局列表" class="headerlink" title="对局列表"></a>对局列表</h2><h3 id="后端API"><a href="#后端API" class="headerlink" title="后端API"></a>后端API</h3><p>首先实现一个API，从后端返回一个对局列表的List。实现API，需要依次编写service, service.impl, controller。</p>
<p>由于对局列表可能很长，需要添加分页功能。</p>
<p>在<code>config.MybatisConfig</code>中添加分页配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MybatisConfig</span> &#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> MybatisPlusInterceptor <span class="title function_">mybatisPlusInterceptor</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MybatisPlusInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MybatisPlusInterceptor</span>();</span><br><span class="line">        interceptor.addInnerInterceptor(<span class="keyword">new</span> <span class="title class_">PaginationInnerInterceptor</span>(DbType.MYSQL));</span><br><span class="line">        <span class="keyword">return</span> interceptor;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>service.record</code>中创建<code>GetRecordListService</code></p>
<p>不需要将所有页面的信息均返回出来，用户需要展示第几页，就对应的返回第几页。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GetRecordListService</span> &#123;</span><br><span class="line">    JSONObject <span class="title function_">getList</span> <span class="params">(Integer page)</span>;<span class="comment">//page表示页号 只需要返回对应页号的list</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>service.impl.record</code>中创建<code>GetRecordListServiceImpl</code></p>
<p>假定每页展示10条信息，所以如果page &#x3D; 1，返回0<del>9条；page &#x3D; 2，返回10</del>19条</p>
<p>直接借助mabatisplus中的工具IPage实现即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetRecordListServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">GetRecordListService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RecordMapper recordMapper;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> JSONObject <span class="title function_">getList</span><span class="params">(Integer page)</span> &#123;</span><br><span class="line">        IPage&lt;Record&gt; recordIPage = <span class="keyword">new</span> <span class="title class_">Page</span>&lt;&gt;(page, <span class="number">10</span>);<span class="comment">//每页size为10</span></span><br><span class="line">        QueryWrapper&lt;Record&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.orderByDesc(<span class="string">&quot;id&quot;</span>);<span class="comment">//按照id逆序排序</span></span><br><span class="line">        <span class="comment">//将record按照ID逆序排序，并返回第page页的内容</span></span><br><span class="line">        List&lt;Record&gt; records = recordMapper.selectPage(recordIPage, queryWrapper).getRecords();</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">resp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();<span class="comment">//用于返回到前端</span></span><br><span class="line">        List&lt;JSONObject&gt; items = <span class="keyword">new</span> <span class="title class_">LinkedList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span>(Record record : records)&#123;</span><br><span class="line">            <span class="comment">//存储对战双方的用户名 用户头像</span></span><br><span class="line">            <span class="type">User</span> <span class="variable">userA</span> <span class="operator">=</span> userMapper.selectById(record.getAId());</span><br><span class="line">            <span class="type">User</span> <span class="variable">userB</span> <span class="operator">=</span> userMapper.selectById(record.getBId());</span><br><span class="line">            <span class="type">JSONObject</span> <span class="variable">item</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">            item.put(<span class="string">&quot;a_photo&quot;</span>, userA.getPhoto());</span><br><span class="line">            item.put(<span class="string">&quot;a_username&quot;</span>, userA.getUsername());</span><br><span class="line">            item.put(<span class="string">&quot;b_photo&quot;</span>, userB.getPhoto());</span><br><span class="line">            item.put(<span class="string">&quot;b_username&quot;</span>, userB.getUsername());</span><br><span class="line">            <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> <span class="string">&quot;平局&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span>(<span class="string">&quot;A&quot;</span>.equals(record.getLoser())) result = <span class="string">&quot;B胜&quot;</span>;</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(<span class="string">&quot;B&quot;</span>.equals(record.getLoser())) result = <span class="string">&quot;A胜&quot;</span>;</span><br><span class="line">            item.put(<span class="string">&quot;result&quot;</span>, result);</span><br><span class="line">            item.put(<span class="string">&quot;record&quot;</span>, record);</span><br><span class="line">            items.add(item);</span><br><span class="line">        &#125;</span><br><span class="line">        resp.put(<span class="string">&quot;records&quot;</span>, items);</span><br><span class="line">        resp.put(<span class="string">&quot;records_count&quot;</span>, recordMapper.selectCount(<span class="literal">null</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> resp;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>controller.record</code>中创建<code>GetRecordListController</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetRecordListController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GetRecordListService getRecordListService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/record/getlist/&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> JSONObject <span class="title function_">getList</span> <span class="params">(<span class="meta">@RequestParam</span> Map&lt;String, String&gt; data)</span>&#123;</span><br><span class="line">       <span class="type">Integer</span> <span class="variable">page</span> <span class="operator">=</span>  Integer.parseInt(data.get(<span class="string">&quot;page&quot;</span>));</span><br><span class="line">       <span class="keyword">return</span> getRecordListService.getList(page);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="前端展示"><a href="#前端展示" class="headerlink" title="前端展示"></a>前端展示</h3><h4 id="获取列表"><a href="#获取列表" class="headerlink" title="获取列表"></a>获取列表</h4><p>在<code>RecordIndexView.vue</code>中，请求获取对局记录。</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905114924342.png" alt="image-20220905114924342"></p>
<p>测试如下：</p>
<p>与后端返回的格式一致，结果分两大部分records和records_count</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905114551579.png" alt="image-20220905114551579"></p>
<p>其中records.records又包括</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905114714223.png" alt="image-20220905114714223"></p>
<p>接下来要将列表显示出来。</p>
<p>需要建立一个tabel，遍历records将内容展示出来</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905121909562.png" alt="image-20220905121909562"></p>
<p>效果如下：<img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905122017059.png" alt="image-20220905122017059"></p>
<h4 id="查看录像"><a href="#查看录像" class="headerlink" title="查看录像"></a>查看录像</h4><p>为了方便展示录像，需要存储一些全局信息，包括是否展示录像，以及a和b的steps</p>
<p><code>record.js</code></p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905194555531.png" alt="image-20220905194555531"></p>
<p>同时，点击查看录像，需要进入一个新的页面，建立一个新的vue页面<code>src\views\record\RecordContentView.vue</code></p>
<p>由于录像页面，和PK页面实际上大部分内容相同，因此，直接将PK页面的内容复制过来加以修改。‘</p>
<p>这里只需要用到<code>PlayGround</code>这一个组件，初始化为。</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905195857088.png" alt="image-20220905195857088"></p>
<p>并将这样一个页面，加入路由</p>
<p>注意，路由中，<code>path</code>可以加入参数，这里<code>recordId</code>就是传入的参数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">RecordContentView</span> <span class="keyword">from</span> <span class="string">&#x27;../views/record/RecordContentView.vue&#x27;</span></span><br><span class="line"><span class="keyword">const</span> routes = [</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">path</span>:<span class="string">&quot;/record/:recordId&quot;</span>,</span><br><span class="line">    <span class="attr">name</span>:<span class="string">&quot;record_content&quot;</span>,</span><br><span class="line">    <span class="attr">component</span>:<span class="title class_">RecordContentView</span>,</span><br><span class="line">    <span class="attr">meta</span>:&#123;</span><br><span class="line">      <span class="attr">requestAuth</span>:<span class="literal">true</span>,</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br></pre></td></tr></table></figure>

<p>回到<code>src\views\record\RecordIndexView.vue</code></p>
<p>点击查看录像按钮时，触发<code>open_record_content</code>，并且传入记录的ID</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905173240392.png" alt="image-20220905173240392"></p>
<p>在<code>open_record_content</code>函数中，需要通过<code>updateIsrecord</code>来标记为录像页面；</p>
<p>同时注意，在对战页面的vue页面中，取消标记</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905192726799.png" alt="image-20220905192726799"></p>
<p>在<code>open_record_content</code>函数中同时调用<code>updateGame</code>，对游戏进行更新，调用<code>updateSteps</code>，更新<code>a_step</code>和<code>b_step</code>，调用<code>updateRecordLoser</code>，更新<code>record_loser</code></p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905204953412.png" alt="image-20220905204953412"></p>
<p>同时需要在Gamemap.js中添加一些逻辑判断。</p>
<p>因为不管是对战页面，还是录像页面，都共用了<code>PlayGround</code>组件</p>
<p>对于<code>PlayGround</code>组件，由<code>GameMap</code>组件构成</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905173658505.png" alt="image-20220905173658505"></p>
<p>在GameMap中要创建GameMap类的实例</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905173816481.png" alt="image-20220905173816481"></p>
<p>因此，不管是对战页面还是录像页面，都需要<code>GameMap.js</code>中执行相应的逻辑</p>
<p>这里需要在<code>GameMap.js</code>中判断是录像是否被标记，如果没有标记，就依然是之前对战的逻辑。</p>
<h4 id="操作回放"><a href="#操作回放" class="headerlink" title="操作回放"></a>操作回放</h4><p>如果录像被标记，也就是<code>this.store.state.record.is_record</code>为true。</p>
<p>录像本质上是操作的回放，只需要根据两名玩家的steps，重新将蛇移动一遍。</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905204922888.png" alt="image-20220905204922888"></p>
<p>这样，就实现了对局录像的展示。</p>
<h4 id="分页展示"><a href="#分页展示" class="headerlink" title="分页展示"></a>分页展示</h4><p>借助Bootstrap的Pagination组件</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905205824432.png" alt="image-20220905205824432"></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">nav</span> <span class="attr">aria-label</span>=<span class="string">&quot;...&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">&quot;pagination&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;page-item disabled&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;page-link&quot;</span>&gt;</span>Previous<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;page-item&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;page-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span>1<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;page-item active&quot;</span> <span class="attr">aria-current</span>=<span class="string">&quot;page&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">&quot;page-link&quot;</span>&gt;</span>2<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;page-item&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;page-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span>3<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">&quot;page-item&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">&quot;page-link&quot;</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span>&gt;</span>Next<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>加入到vue页面中去，效果如下：</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905210240683.png" alt="image-20220905210240683"></p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905210248588.png" alt="image-20220905210248588"></p>
<p>被<code>active</code>标记的数字变蓝</p>
<p>我们的需求是，展示当前页，并且在分页栏中留出前后两页。</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905214731291.png" alt="image-20220905214731291"></p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905215642772.png" alt="image-20220905215642772"></p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905215702172.png" alt="image-20220905215702172"></p>
<p>此时结果符合预期</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905215730382.png" alt="image-20220905215730382"></p>
<p>并且，还需要点击哪个按钮，就要跳转到对应的页面。</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905220558503.png" alt="image-20220905220558503"></p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905220611554.png" alt="image-20220905220611554"></p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905220620228.png" alt="image-20220905220620228"></p>
<p>分页功能成功实现！</p>
<h2 id="排行榜"><a href="#排行榜" class="headerlink" title="排行榜"></a>排行榜</h2><h3 id="后端API-1"><a href="#后端API-1" class="headerlink" title="后端API"></a>后端API</h3><p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905222243643.png" alt="image-20220905222243643"></p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905222259006.png" alt="image-20220905222259006"></p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905222309156.png" alt="image-20220905222309156"></p>
<h3 id="前端展示-1"><a href="#前端展示-1" class="headerlink" title="前端展示"></a>前端展示</h3><p>在对局页面<code>src\views\record\RecordIndexView.vue</code>逻辑一致，因此，代码复用率很高</p>
<p>主要就是将records和total_records改为users和total_users，修改非常少量的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;ContentFieldVue&gt;</span><br><span class="line">        &lt;table class=&quot;table table-striped table-hover&quot; style=&quot;text-align:center&quot;&gt;</span><br><span class="line">            &lt;thead&gt;</span><br><span class="line">                &lt;tr&gt;</span><br><span class="line">                    &lt;th&gt;玩家&lt;/th&gt;</span><br><span class="line">                    &lt;th&gt;天梯积分&lt;/th&gt;</span><br><span class="line">                &lt;/tr&gt;</span><br><span class="line">            &lt;/thead&gt;</span><br><span class="line">            &lt;tbody&gt;</span><br><span class="line">                &lt;tr v-for=&quot;user in users&quot; :key=&quot;user.id&quot;&gt;</span><br><span class="line">                    &lt;td&gt;</span><br><span class="line">                        &lt;img :src=&quot;user.photo&quot; alt=&quot;&quot; class=&quot;ranklist-user-photo&quot;&gt;</span><br><span class="line">                        &amp;nbsp;</span><br><span class="line">                        &lt;span class=&quot;ranklist-user-username&quot;&gt; &#123;&#123; user.username &#125;&#125;&lt;/span&gt;</span><br><span class="line">                    &lt;/td&gt;</span><br><span class="line">                    &lt;td&gt;</span><br><span class="line">                        &#123;&#123; user.rating &#125;&#125;</span><br><span class="line">                    &lt;/td&gt;</span><br><span class="line">                &lt;/tr&gt;</span><br><span class="line">            &lt;/tbody&gt;</span><br><span class="line">        &lt;/table&gt;</span><br><span class="line">        &lt;nav aria-label=&quot;...&quot;&gt;</span><br><span class="line">            &lt;ul class=&quot;pagination&quot; style=&quot;float:right&quot;&gt;</span><br><span class="line">                &lt;li class=&quot;page-item&quot; @click=&quot;click_page(-2)&quot;&gt;</span><br><span class="line">                    &lt;a class=&quot;page-link&quot; href=&quot;#&quot; &gt;前一页&lt;/a&gt;</span><br><span class="line">                &lt;/li&gt;</span><br><span class="line">                &lt;li :class=&quot;&#x27;page-item &#x27; + page.is_active&quot; </span><br><span class="line">                    v-for=&quot;page in pages&quot; :key=&quot;page.pageId&quot; @click=&quot;click_page(page.pageId)&quot;&gt;</span><br><span class="line">                    &lt;a class=&quot;page-link&quot; href=&quot;#&quot;&gt;&#123;&#123;page.pageId&#125;&#125;&lt;/a&gt;</span><br><span class="line">                &lt;/li&gt;</span><br><span class="line">                &lt;li class=&quot;page-item&quot; @click=&quot;click_page(-1)&quot;&gt;</span><br><span class="line">                    &lt;a class=&quot;page-link&quot; href=&quot;#&quot;&gt;后一页&lt;/a&gt;</span><br><span class="line">                &lt;/li&gt;</span><br><span class="line">            &lt;/ul&gt;</span><br><span class="line">        &lt;/nav&gt;</span><br><span class="line">    &lt;/ContentFieldVue&gt;</span><br><span class="line">&lt;/template&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">import ContentFieldVue from &#x27;../../components/ContentField.vue&#x27;</span><br><span class="line">import &#123; useStore &#125; from &#x27;vuex&#x27;;</span><br><span class="line">import $ from &#x27;jquery&#x27;</span><br><span class="line">import &#123; ref &#125; from &#x27;vue&#x27;;</span><br><span class="line">export default &#123;</span><br><span class="line">    components: &#123;</span><br><span class="line">        ContentFieldVue</span><br><span class="line">    &#125;,</span><br><span class="line">    setup() &#123;</span><br><span class="line">        const store = useStore();</span><br><span class="line">        let current_page = 1;</span><br><span class="line">        let users = ref([]);</span><br><span class="line">        let total_users = 0;</span><br><span class="line">        let pages = ref([]);</span><br><span class="line">        const click_page = page =&gt; &#123;</span><br><span class="line">            if(page === -2)</span><br><span class="line">                page = current_page - 1;</span><br><span class="line">            if(page === -1)</span><br><span class="line">                page = current_page + 1;</span><br><span class="line">            let max_pages = parseInt(Math.ceil(total_users / 3));</span><br><span class="line">            if(page &gt;= 1 &amp;&amp; page &lt;= max_pages)&#123;</span><br><span class="line">                pull_page(page);//加载一个新的分页</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        const update_pages = () =&gt;&#123;</span><br><span class="line">            let max_pages = parseInt(Math.ceil(total_users / 3));//最大页数</span><br><span class="line">            let new_pages = [];</span><br><span class="line">            for(let i = current_page - 2; i &lt;= current_page + 2; i++)&#123;</span><br><span class="line">                if(i &gt;= 1 &amp;&amp; i &lt;= max_pages)&#123;</span><br><span class="line">                    new_pages.push(&#123;</span><br><span class="line">                        pageId:i,</span><br><span class="line">                        is_active:i === current_page ? &quot;active&quot; : &quot;&quot;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;   </span><br><span class="line">            pages.value = new_pages;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        const pull_page = page =&gt; &#123;</span><br><span class="line">            current_page = page;</span><br><span class="line">            $.ajax(&#123;</span><br><span class="line">                url: &quot;http://127.0.0.1:3000/ranklist/getlist/&quot;,</span><br><span class="line">                data: &#123;</span><br><span class="line">                    page,</span><br><span class="line">                &#125;,</span><br><span class="line">                type: &quot;get&quot;,</span><br><span class="line">                headers: &#123;</span><br><span class="line">                    Authorization: &quot;Bearer &quot; + store.state.user.token,</span><br><span class="line">                &#125;,</span><br><span class="line">                success(resp) &#123;</span><br><span class="line">                    console.log(resp);</span><br><span class="line">                    users.value = resp.users;</span><br><span class="line">                    total_users = resp.user_count;</span><br><span class="line">                    update_pages();</span><br><span class="line">                &#125;,</span><br><span class="line">                error(resp) &#123;</span><br><span class="line">                    console.log(resp);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        pull_page(current_page);</span><br><span class="line"></span><br><span class="line">        return &#123;</span><br><span class="line">            users,</span><br><span class="line">            total_users,</span><br><span class="line">            pages,</span><br><span class="line">            click_page</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>此时就可以实现</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E4%B8%8E%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/image-20220905230520878.png" alt="image-20220905230520878"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/01/24/Springboot-%E5%88%9B%E5%BB%BA%E5%AF%B9%E6%88%98%E5%88%97%E8%A1%A8%E5%92%8C%E6%8E%92%E8%A1%8C%E6%A6%9C%E9%A1%B5%E9%9D%A2/" data-id="cm8sja97d001h8ktb6qmudg9y" data-title="Springboot-创建对战列表和排行榜页面" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Springboot/" rel="tag">Springboot</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Springboot-实现微服务Bot代码的执行" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/01/24/Springboot-%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1Bot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/" class="article-date">
  <time class="dt-published" datetime="2025-01-24T09:00:11.000Z" itemprop="datePublished">2025-01-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Web/">Web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/01/24/Springboot-%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1Bot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/">Springboot-实现微服务Bot代码的执行</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="流程设计"><a href="#流程设计" class="headerlink" title="流程设计"></a>流程设计</h2><p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827101236922.png" alt="image-20220827101236922"></p>
<p>接下来要实现的是，Bot代码执行的微服务部分。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827101334278.png" alt="image-20220827101334278"></p>
<h2 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h2><p>相应的，首先要创建该服务的后端。</p>
<img src="/images/实现微服务：Bot代码的执行/image-20220827101446610.png" alt="image-20220827101446610" style="zoom:67%;" />

<p>然后将<code>matchingsystem</code>模块的依赖直接复制过来</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--Spring Security--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--spring-cloud-dependencies--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2021.0.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!--Project Lombok--&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>同时在<code>BotRunningSystem</code>项目中添加依赖<code>joor-java-8</code>(<a target="_blank" rel="noopener" href="https://mvnrepository.com/">Maven仓库地址</a>)：用于动态的编译和执行代码</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827102505975.png" alt="image-20220827102505975"></p>
<p>为了如果拓展为实现其他语言，可以在云端自动启动一个<code>docker</code>容器，来执行其他语言。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827102420236.png" alt="image-20220827102420236"></p>
<p>重命名：</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827102739701.png" alt="image-20220827102739701"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827102934681.png" alt="image-20220827102934681"></p>
<p>同时添加<code>resources/application.properties</code>文件，写入端口号</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server.port=3002</span><br></pre></td></tr></table></figure>

<h2 id="后端API"><a href="#后端API" class="headerlink" title="后端API"></a>后端API</h2><p>首先要实现一个后端API，接收Bot代码，并将其加入到Bot运行池</p>
<p> 实现后端API需要加入对应的<code>controller</code>， <code>service</code>， <code>service.impl</code>，以及添加<code>ResTemplateConfig</code>，并且在<code>SecurityConfig</code>中配置网关。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827182317628.png" alt="image-20220827182317628"></p>
<p>下面暂时写一些测试性的内容。</p>
<p><code>BotRunningService.java</code></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827182331040.png" alt="image-20220827182331040"></p>
<p><code>BotRunningServiceImpl.java</code></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827182441852.png" alt="image-20220827182441852"></p>
<p><code>BotRunningController.java</code></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827182527098.png" alt="image-20220827182527098"></p>
<p><code>RestTemplateConfig.java</code></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827182559744.png" alt="image-20220827182559744"></p>
<p><code>SecurityConfig.java</code>，用于配置网关</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827182634448.png" alt="image-20220827182634448"></p>
<h2 id="修改前端"><a href="#修改前端" class="headerlink" title="修改前端"></a>修改前端</h2><p>前端需要做一些修改，可以选择人工对战还是Bot参与对战。</p>
<p>并且，在client向server发请求时，如果是Bot参与对战，还需要指名bot_id</p>
<p>需要在匹配页面加入一个复选框</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827183204926.png" alt="image-20220827183204926"></p>
<p>在BootStrap中找到相应工具</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827183144690.png" alt="image-20220827183144690"></p>
<p>添加如下：</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827183943739.png" alt="image-20220827183943739"></p>
<p>效果：</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827183956814.png" alt="image-20220827183956814"></p>
<p>然后还需要动态的获取Bot列表，</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827190403955.png" alt="image-20220827190403955"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827190413350.png" alt="image-20220827190413350"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827190317530.png" alt="image-20220827190317530"></p>
<p>同样，需要将用户选择了哪个bot告诉前端，引出需要做一个双向数据绑定。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827191156691.png" alt="image-20220827191156691"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827191231959.png" alt="image-20220827191231959"></p>
<p>这样将用户的选择与前端的变量就双向绑定了起来。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827191314444.png" alt="image-20220827191314444"></p>
<h2 id="参数传递"><a href="#参数传递" class="headerlink" title="参数传递"></a>参数传递</h2><p>然后需要在通信的时候，将user_id作为参数返回，并且后端也要相应的接收参数。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827195036221.png" alt="image-20220827195036221"></p>
<p>BackEnd端接收</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827200822318.png" alt="image-20220827200822318"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827195620555.png" alt="image-20220827195620555"></p>
<p>BackEnd端向MatchingSystem端发送</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827200910937.png" alt="image-20220827200910937"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827195710288.png" alt="image-20220827195710288"></p>
<p>MatchingSystem端接收</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827201045838.png" alt="image-20220827201045838"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827201159091.png" alt="image-20220827201159091"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827201221097.png" alt="image-20220827201221097"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827201234489.png" alt="image-20220827201234489"></p>
<p>同样MatchingSystem端再向Backend端返回结果的时候，也需要发送一个botId</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827201330477.png" alt="image-20220827201330477"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827201725372.png" alt="image-20220827201725372"></p>
<p>Backend接收参数</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827202803956.png" alt="image-20220827202803956"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827202830999.png" alt="image-20220827202830999"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827202909896.png" alt="image-20220827202909896"></p>
<p>这次，整个发送bot_id的流程才算完整。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827210137930.png" alt="image-20220827210137930"></p>
<h2 id="取到Bot信息"><a href="#取到Bot信息" class="headerlink" title="取到Bot信息"></a>取到Bot信息</h2><p><code>WebSocketServer.java</code></p>
<p>1）首先将BotMapper注入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> BotMapper botMapper;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setBotMapper</span><span class="params">(BotMapper botMapper)</span>&#123;</span><br><span class="line">    WebSocketServer.botMapper = botMapper;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）借助BotMapper将两个用户选择的bot取出</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827224139071.png" alt="image-20220827224139071"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827224237483.png" alt="image-20220827224237483"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827224307904.png" alt="image-20220827224307904"></p>
<p>此时将bot的信息传入了Game中</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827224643379.png" alt="image-20220827224643379"></p>
<h2 id="Bot-or-not判断"><a href="#Bot-or-not判断" class="headerlink" title="Bot or not判断"></a>Bot or not判断</h2><p>取到了bot信息，创建完地图之后，在执行nextstep之前，判断botid是否等于-1，如果是-1，就要处理的是用户手动键入的指令，那么就等待用户输入；如果不等于-1，说明参与游戏的是Bot代码，则需要向BotRunningSystem发送消息，使其自动计算，并返回结果。</p>
<p>因此，需要在<code>nextStep()</code>中实现上述的判断。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220827230237963.png" alt="image-20220827230237963"></p>
<p>如果是人工输入，则无需操作；如果是Bot参与，需要将用户id，bot代码，以及当前的局面传到<code>RotRunningSystem</code>系统的<code>BotRunningController</code></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220828172653207.png" alt="image-20220828172653207"></p>
<p>其中，<code>getInput(Player player)</code>表示获取当前游戏局面的信息</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220828172911382.png" alt="image-20220828172911382"></p>
<p>此外，为了防止人工输入和bot执行混淆，还需要在执行bot的时候，屏蔽掉用户的输入。只有判断用户亲自出马的时候，才接收人的输入。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220828171241700.png" alt="image-20220828171241700"></p>
<p>测试如下：</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220828175008165.png" alt="image-20220828175008165"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220828174818192.png" alt="image-20220828174818192"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220828174830377.png" alt="image-20220828174830377"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220828174849609.png" alt="image-20220828174849609"></p>
<p>可以看到，经过了漫长的传递过程，此时<code>bot</code>的信息，终于传到了<code>BotRunningSystem</code></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220828175732185.png" alt="image-20220828175732185"></p>
<h2 id="Bot微服务"><a href="#Bot微服务" class="headerlink" title="Bot微服务"></a>Bot微服务</h2><p>接下来就是本节的重点，也就是实现Bot Running System微服务。</p>
<h3 id="生产者—消费者模式"><a href="#生产者—消费者模式" class="headerlink" title="生产者—消费者模式"></a>生产者—消费者模式</h3><p>这部分的工作在于，不断的接收用户的输入，将接收到的代码放在一个队列里面，也就是队列中存储当前所有的任务。每接收一个来自生产者的任务过来，就将其放在队列里。BotPool相当于消费者，每完成一个任务，检查一下队列是否为空，如果队列不空，就从队头取出代码执行。执行完之后继续检查。</p>
<p>MatchingPool中的循环，每循环一次，sleep一秒钟，但BotPool中的循环，为了保证用户体验，需要满足一旦有任务，立即执行。执行完之后，如果队列为空，就继续等待。因此两者循环的实现逻辑不一样，后者用到条件变量。</p>
<p>首先实现消费者线程及其流程。</p>
<h3 id="消费者线程"><a href="#消费者线程" class="headerlink" title="消费者线程"></a>消费者线程</h3><p>1）如果任务队列为空，就要将其阻塞，当有任务出现时，就要发生信号量，将其唤醒。因此需要用到条件变量。</p>
<blockquote>
<p>使用<code>condition.await()</code>将当前线程阻塞</p>
<p>Causes the current thread to wait until it is signalled or interrupted.</p>
<p>（导致当前线程等待，直到发出信号或中断。）</p>
</blockquote>
<p>2）此外还需要队列，来存储<code>Bot</code>，定义一个<code>Bot</code>类，</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220829152101867.png" alt="image-20220829152101867"></p>
<p>并定义一个存储Bot对象的队列<code>Queue&lt;Bot&gt;</code>。</p>
<blockquote>
<p>生产者和消费者都会对<code>Queue&lt;Bot&gt;</code>进行操作，因此处理的时候需要加锁。</p>
</blockquote>
<p>3）在消费Bot对象之前，一点要先解锁，否则往队列添加Bot对象的时候就会被阻塞，但完全没有必要，因为没有读写冲突。</p>
<p>代码如下：</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830111057877.png" alt="image-20220830111057877"></p>
<p>其中，如果队列为空，线程将会被阻塞。当<code>addBot()</code>被调用，队列中添加新的任务时，线程将会被唤醒</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220829152439066.png" alt="image-20220829152439066"></p>
<p>BotPool线程的存储，以及关于添加Bot的调用，均放在<code>BotRunningServiceImpl</code>中</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220829154311980.png" alt="image-20220829154311980"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220829152602531.png" alt="image-20220829152602531"></p>
<p>与匹配系统一样，也是在BootStrap服务启动的时候，启动BotPool线程。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220829152723391.png" alt="image-20220829152723391"></p>
<h3 id="consum操作"><a href="#consum操作" class="headerlink" title="consum操作"></a>consum操作</h3><p>这里只是简单的实现Java代码的编译和执行。后续如果需要添加安全验证或者支持其他语言，只需要修改consum函数即可。对于安全验证，也就是防止程序运行可能产生的危害，可以将其放在沙箱中运行。对于支持其他语言，可以将consum函数改为对docker的执行（Java中执行终端命令，将终端命令的执行放进docker即可）</p>
<p>这里使用Java中的一个工具Joor，可以动态编译和执行Java代码。</p>
<p>为了让整个执行过程时间可控，每执行一段代码，就需要将其放在一个线程中，线程可以支持如果超时就会断掉的操作。新建一个<code>Consumer</code>类用于表示这种线程。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220829162116678.png" alt="image-20220829162116678"></p>
<p>然后在<code>botpool</code>的<code>consum</code>函数中，创建一个<code>Consumer</code>对象，并调用对象的<code>startTimeout</code>方法。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830113243696.png" alt="image-20220830113243696"></p>
<p>再回到<code>Consumer</code>类的<code>run()</code>中，需要使用到<code>joor.Reflect</code>类来动态编译执行一段代码</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830112609873.png" alt="image-20220830112609873"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830112559352.png" alt="image-20220830112559352"></p>
<p>不过这里有个问题，在动态编译过程中，如果是重名的类，只会编译一次。但是对于每一个任务代码，都应该重新编译一遍，因此，需要在类名之前，添加一个随机字符串，来保证类不一样。</p>
<p>下面这段代码，就可以实现从前端动态接收一段代码，并动态编译一遍。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830113417105.png" alt="image-20220830113417105"></p>
<h3 id="测试Bot代码"><a href="#测试Bot代码" class="headerlink" title="测试Bot代码"></a>测试Bot代码</h3><p>1）1号玩家的Bot，返回0，表示向上走</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830104252366.png" alt="image-20220830104252366"></p>
<p>2）6号玩家，返回2，表示向下走</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830104438032.png" alt="image-20220830104438032"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830104917155.png" alt="image-20220830104917155"></p>
<p>解决一个空指针异常</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830115524145.png" alt="image-20220830115524145"></p>
<p>修改依赖</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830115807058.png" alt="image-20220830115807058"></p>
<p>这样，在控制台中就能看到输出结果</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830120233441.png" alt="image-20220830120233441"></p>
<p>表示1号玩家往上移动，6号玩家往下移动。</p>
<p>此时Bot信息就传递到了consumer(Joor)</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830152710621.png" alt="image-20220830152710621"></p>
<p>接下来一步要考虑的，就是将Bot代码执行的结果，返回给3000断开的主后端服务器，最终传到nextstep中</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830152919973.png" alt="image-20220830152919973"></p>
<h2 id="Bot结果返回"><a href="#Bot结果返回" class="headerlink" title="Bot结果返回"></a>Bot结果返回</h2><h3 id="Backend-API"><a href="#Backend-API" class="headerlink" title="Backend API"></a>Backend API</h3><p>为了接收<code>consumer</code>中计算的结果，我们要在主服务器中实现一个新的API。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830163403223.png" alt="image-20220830163403223"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830163431472.png" alt="image-20220830163431472"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830163505316.png" alt="image-20220830163505316"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830170422703.png" alt="image-20220830170422703"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830163544134.png" alt="image-20220830163544134"></p>
<p>取出<code>bot</code>所对应的玩家<code>userId</code>和操作<code>direction</code>，然后需要玩家的操作传递到<code>setNextStep</code></p>
<p>参考<code>WebSocketServer</code>中的<code>move</code>（玩家操作传递到<code>setNextStep</code>)</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830163148975.png" alt="image-20220830163148975"></p>
<h3 id="setNextStep"><a href="#setNextStep" class="headerlink" title="setNextStep"></a>setNextStep</h3><p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830164257810.png" alt="image-20220830164257810"></p>
<p>这样就能实现，用户Bot生成的操作，通过Server传递给Game</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830164423636.png" alt="image-20220830164423636"></p>
<p>现在只需要实现<code>consumer</code>动态编译Bot代码的结果返回给主服务器<code>StartGameController</code></p>
<h3 id="结果返回"><a href="#结果返回" class="headerlink" title="结果返回"></a>结果返回</h3><p>将<code>RestTemplate</code>注入通过<code>@Component</code>到当前的<code>Consumer</code>类</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830171129430.png" alt="image-20220830171129430"></p>
<p>通过<code>RestTemplate</code>将结果返回到主服务器（主服务器中的<code>StartGameController</code>接收）</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830171014066.png" alt="image-20220830171014066"></p>
<p>此时，整个流程就已经打通，通信过程完成闭环。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830173617837.png" alt="image-20220830173617837"></p>
<h3 id="功能测试"><a href="#功能测试" class="headerlink" title="功能测试"></a>功能测试</h3><p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830174121943.png" alt="image-20220830174121943"></p>
<p>此时测试，两个Bot均可以实现自动执行。注意，先点击匹配的用户在左下角，后点匹配的在右上角。</p>
<p>可以修改使得左边用户返回1，则会一直往右走。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830183308296.png" alt="image-20220830183308296"></p>
<p>当然，可以实现人机对战，即左边蛇一直往右走（Bot运行）右边的蛇用户控制。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830183505703.png" alt="image-20220830183505703"></p>
<h2 id="Bot编写"><a href="#Bot编写" class="headerlink" title="Bot编写"></a>Bot编写</h2><h3 id="设计过程"><a href="#设计过程" class="headerlink" title="设计过程"></a>设计过程</h3><p>Bot代码的编写可以直接在IDEA中实现，之后将其复制到浏览器上。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830183905928.png" alt="image-20220830183905928"></p>
<p>这里实现一个稍微正常一点的AI，也就是在执行的时候判断上下左右哪一步可以走。</p>
<p>对input进行解码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String[] str = input.split(<span class="string">&quot;#&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">map</span> <span class="operator">=</span> str[<span class="number">0</span>];<span class="comment">// 取出地图</span></span><br><span class="line"><span class="type">int</span> <span class="variable">aSx</span> <span class="operator">=</span> Integer.parseInt(str[<span class="number">1</span>]), aSy = Integer.parseInt(str[<span class="number">2</span>]);<span class="comment">//取出我方起点坐标</span></span><br><span class="line"><span class="type">String</span> <span class="variable">aSteps</span> <span class="operator">=</span> str[<span class="number">3</span>];<span class="comment">// 取出我方操作</span></span><br><span class="line"><span class="type">int</span> <span class="variable">bSx</span> <span class="operator">=</span> Integer.parseInt(str[<span class="number">4</span>]), bSy = Integer.parseInt(str[<span class="number">5</span>]);<span class="comment">//取出对手起点坐标</span></span><br><span class="line"><span class="type">String</span> <span class="variable">bSteps</span> <span class="operator">=</span> str[<span class="number">6</span>];<span class="comment">// 取出对手操作</span></span><br></pre></td></tr></table></figure>

<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830184304826.png" alt="image-20220830184304826"></p>
<p>1）取出地图</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 取出地图</span></span><br><span class="line"><span class="type">int</span>[][] g = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">13</span>][<span class="number">14</span>];</span><br><span class="line"><span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">13</span>; i++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">14</span>; j++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(str[<span class="number">0</span>].charAt(k) == <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">            g[i][j] = <span class="number">1</span>;</span><br><span class="line">        k++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）取出两条蛇的路径</p>
<p>直接用之前在<code>Play.java</code>中写过的代码即可</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830201505389.png" alt="image-20220830201505389"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//检验当前回合 蛇的长度是否增加</span></span><br><span class="line"><span class="keyword">private</span>  <span class="type">boolean</span> <span class="title function_">check_tail_increasing</span><span class="params">(<span class="type">int</span> step)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(step &lt;= <span class="number">10</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">return</span> step % <span class="number">3</span> == <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//返回蛇的身体</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Cell&gt; <span class="title function_">getCells</span><span class="params">(<span class="type">int</span> sx, <span class="type">int</span> sy, String steps)</span>&#123;</span><br><span class="line">    List&lt;Cell&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="comment">//对于四种操作0(w), 1(d), 2(s), 3(a)</span></span><br><span class="line">    <span class="comment">// 在行和列方向上的计算偏移量</span></span><br><span class="line">    <span class="type">int</span>[] dx = &#123;-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">int</span>[] dy = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>&#125;;</span><br><span class="line">    <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> sx;</span><br><span class="line">    <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> sy;</span><br><span class="line">    <span class="type">int</span> <span class="variable">step</span> <span class="operator">=</span> <span class="number">0</span>;<span class="comment">//回合数</span></span><br><span class="line">    <span class="type">char</span>[] snacksteps = steps.toCharArray();</span><br><span class="line">    res.add(<span class="keyword">new</span> <span class="title class_">Cell</span>(x,y));<span class="comment">//添加起点</span></span><br><span class="line">    <span class="comment">//不断根据steps计算出整个蛇身体</span></span><br><span class="line">    <span class="keyword">for</span> (Character d : snacksteps) &#123;</span><br><span class="line">        x += dx[d - <span class="string">&#x27;0&#x27;</span>];</span><br><span class="line">        y += dy[d - <span class="string">&#x27;0&#x27;</span>];</span><br><span class="line">        res.add(<span class="keyword">new</span> <span class="title class_">Cell</span>(x,y));</span><br><span class="line">        <span class="keyword">if</span>(!check_tail_increasing(++step))&#123;</span><br><span class="line">            <span class="comment">//如果蛇尾不增加 就删掉蛇尾</span></span><br><span class="line">            res.remove(<span class="number">0</span>);<span class="comment">//O(N)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//取出蛇的轨迹</span></span><br><span class="line">List&lt;Cell&gt; aCells = getCells(aSx, aSy, aSteps);</span><br><span class="line">List&lt;Cell&gt; bCells = getCells(bSx, bSy, bSteps);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(Cell c : aCells) g[c.x][c.y] = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">for</span> (Cell c : bCells) g[c.x][c.y] = <span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>3）判断可行的移动方向</p>
<p>枚举一下上右下左四个方向，一旦发现可以走，就设定移动方向。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 判断可行的移动方向</span></span><br><span class="line"><span class="comment">// 对于四种方向0(↑), 1(→), 2(↓), 3(←)</span></span><br><span class="line"><span class="comment">// 在行和列方向上的计算偏移量</span></span><br><span class="line"><span class="type">int</span>[] dx = &#123;-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>&#125;;</span><br><span class="line"><span class="type">int</span>[] dy = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> aCells.get(aCells.size() - <span class="number">1</span>).x + dx[i];<span class="comment">//下一处x</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> aCells.get(aCells.size() - <span class="number">1</span>).y + dy[i];<span class="comment">//下一处y</span></span><br><span class="line">    <span class="keyword">if</span>(x &gt;= <span class="number">0</span> &amp;&amp; x &lt; <span class="number">13</span> &amp;&amp; y &gt;= <span class="number">0</span> &amp;&amp; y &lt; <span class="number">14</span> &amp;&amp; g[x][y] == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//如果没有可行的方向 向上走--灭亡</span></span><br></pre></td></tr></table></figure>

<h3 id="代码实现"><a href="#代码实现" class="headerlink" title="代码实现"></a>代码实现</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.botrunningsystem.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bot</span> <span class="keyword">implements</span> <span class="title class_">com</span>.kob.botrunningsystem.utils.BotInterface&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Cell</span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> x;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> y;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">Cell</span><span class="params">(<span class="type">int</span> x, <span class="type">int</span> y)</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.x = x;</span><br><span class="line">            <span class="built_in">this</span>.y = y;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//检验当前回合 蛇的长度是否增加</span></span><br><span class="line">    <span class="keyword">private</span>  <span class="type">boolean</span> <span class="title function_">check_tail_increasing</span><span class="params">(<span class="type">int</span> step)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(step &lt;= <span class="number">10</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> step % <span class="number">3</span> == <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//返回蛇的身体</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Cell&gt; <span class="title function_">getCells</span><span class="params">(<span class="type">int</span> sx, <span class="type">int</span> sy, String steps)</span>&#123;</span><br><span class="line">        List&lt;Cell&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//对于四种操作0(w), 1(d), 2(s), 3(a)</span></span><br><span class="line">        <span class="comment">// 在行和列方向上的计算偏移量</span></span><br><span class="line">        <span class="type">int</span>[] dx = &#123;-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>&#125;;</span><br><span class="line">        <span class="type">int</span>[] dy = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>&#125;;</span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> sx;</span><br><span class="line">        <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> sy;</span><br><span class="line">        <span class="type">int</span> <span class="variable">step</span> <span class="operator">=</span> <span class="number">0</span>;<span class="comment">//回合数</span></span><br><span class="line">        <span class="type">char</span>[] snacksteps = steps.toCharArray();</span><br><span class="line">        res.add(<span class="keyword">new</span> <span class="title class_">Cell</span>(x,y));<span class="comment">//添加起点</span></span><br><span class="line">        <span class="comment">//不断根据steps计算出整个蛇身体</span></span><br><span class="line">        <span class="keyword">for</span> (Character d : snacksteps) &#123;</span><br><span class="line">            x += dx[d - <span class="string">&#x27;0&#x27;</span>];</span><br><span class="line">            y += dy[d - <span class="string">&#x27;0&#x27;</span>];</span><br><span class="line">            res.add(<span class="keyword">new</span> <span class="title class_">Cell</span>(x,y));</span><br><span class="line">            <span class="keyword">if</span>(!check_tail_increasing(++step))&#123;</span><br><span class="line">                <span class="comment">//如果蛇尾不增加 就删掉蛇尾</span></span><br><span class="line">                res.remove(<span class="number">0</span>);<span class="comment">//O(N)</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">nextMove</span><span class="params">(String input)</span> &#123;</span><br><span class="line">        <span class="comment">// 对input解码</span></span><br><span class="line">        String[] str = input.split(<span class="string">&quot;#&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">map</span> <span class="operator">=</span> str[<span class="number">0</span>];<span class="comment">// 取出地图</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">aSx</span> <span class="operator">=</span> Integer.parseInt(str[<span class="number">1</span>]), aSy = Integer.parseInt(str[<span class="number">2</span>]);<span class="comment">//取出我方起点坐标</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">aSteps</span> <span class="operator">=</span> str[<span class="number">3</span>];<span class="comment">// 取出我方操作</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">bSx</span> <span class="operator">=</span> Integer.parseInt(str[<span class="number">4</span>]), bSy = Integer.parseInt(str[<span class="number">5</span>]);<span class="comment">//取出对手起点坐标</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">bSteps</span> <span class="operator">=</span> str[<span class="number">6</span>];<span class="comment">// 取出对手操作</span></span><br><span class="line">        <span class="comment">// 取出地图</span></span><br><span class="line">        <span class="type">int</span>[][] g = <span class="keyword">new</span> <span class="title class_">int</span>[<span class="number">13</span>][<span class="number">14</span>];</span><br><span class="line">        <span class="type">int</span> <span class="variable">k</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">13</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">14</span>; j++) &#123;</span><br><span class="line">                <span class="keyword">if</span>(map.charAt(k) == <span class="string">&#x27;1&#x27;</span>)</span><br><span class="line">                    g[i][j] = <span class="number">1</span>;</span><br><span class="line">                k++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//取出蛇的轨迹</span></span><br><span class="line">        List&lt;Cell&gt; aCells = getCells(aSx, aSy, aSteps);</span><br><span class="line">        List&lt;Cell&gt; bCells = getCells(bSx, bSy, bSteps);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(Cell c : aCells) g[c.x][c.y] = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span> (Cell c : bCells) g[c.x][c.y] = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 判断可行的移动方向</span></span><br><span class="line">        <span class="comment">// 对于四种方向0(↑), 1(→), 2(↓), 3(←)</span></span><br><span class="line">        <span class="comment">// 在行和列方向上的计算偏移量</span></span><br><span class="line">        <span class="type">int</span>[] dx = &#123;-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>&#125;;</span><br><span class="line">        <span class="type">int</span>[] dy = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">4</span>; i++) &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> aCells.get(aCells.size() - <span class="number">1</span>).x + dx[i];<span class="comment">//下一处x</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> aCells.get(aCells.size() - <span class="number">1</span>).y + dy[i];<span class="comment">//下一处y</span></span><br><span class="line">            <span class="keyword">if</span>(x &gt;= <span class="number">0</span> &amp;&amp; x &lt; <span class="number">13</span> &amp;&amp; y &gt;= <span class="number">0</span> &amp;&amp; y &lt; <span class="number">14</span> &amp;&amp; g[x][y] == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> i;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;<span class="comment">//如果没有可行的方向 向上走--灭亡</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p>将两个bot修改替换为上面的代码</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830204758707.png" alt="image-20220830204758707"></p>
<p>如果需要对Bot代码需要调试，只能通过println的方式，添加到原来bot中。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830205544422.png" alt="image-20220830205544422"></p>
<p>对于操作而言，需要去掉两端的括号。</p>
<p>此时测试，成功！</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830205904445.png" alt="image-20220830205904445"></p>
<p>也可以人机对战</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9ABot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/image-20220830210111379.png" alt="image-20220830210111379"></p>
<p>至此，这部分的代码全部完成。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/01/24/Springboot-%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1Bot%E4%BB%A3%E7%A0%81%E7%9A%84%E6%89%A7%E8%A1%8C/" data-id="cm8sja97e001n8ktbf85262bi" data-title="Springboot-实现微服务Bot代码的执行" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Springboot/" rel="tag">Springboot</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Springboot-实现微服务匹配系统" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/01/24/Springboot-%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/" class="article-date">
  <time class="dt-published" datetime="2025-01-24T08:59:37.000Z" itemprop="datePublished">2025-01-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Web/">Web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/01/24/Springboot-%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/">Springboot-实现微服务匹配系统</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h2><p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220809232853003.png" alt="image-20220809232853003"></p>
<p>整个匹配的过程是异步过程，也就是在Matching system中执行匹配的过程，会执行一个未知的时间，当出现符合条件的匹配结果时，才会立即将结果返回给前端。这种流程很难用之前的Http来达到预期效果（http为请求一次返回一次，且一般立即响应）。对于匹配系统，请求一次，返回的时间位置，而且可能多次返回。</p>
<p>用websocket协议，不仅客户端可以向服务器主动发送请求，服务器也可以主动向客户端发送请求，是一种对称的通信方式。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220809233425880.png" alt="image-20220809233425880"></p>
<p>之前的地图生成方式，是在用户本地（浏览器中）随机生成，如果两名玩家都在本地实现地图，地图就会产生冲突。因此，需要将生成地图的整个过程，由服务器统一完成。此外，判断游戏是否失败的逻辑（蛇撞击），如果在用户本地（浏览器）中实现，就可能会导致用户作弊。所以，不仅是生成地图，而是整个游戏的过程（蛇的移动、判定），都要做服务器端统一完成，服务器端的相关参数、判定结果返回给前端，前端只用来渲染画面，不做任何判定逻辑。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220809235633315.png" alt="image-20220809235633315"></p>
<h3 id="websocket原理"><a href="#websocket原理" class="headerlink" title="websocket原理"></a>websocket原理</h3><p>将前端建立的每个websocket连接在后端维护起来</p>
<p>添加<code>consumer.WebSocketServer</code>类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.websocket.*;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.PathParam;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ServerEndpoint(&quot;/websocket/&#123;token&#125;&quot;)</span>  <span class="comment">// 注意不要以&#x27;/&#x27;结尾</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> &#123;</span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam(&quot;token&quot;)</span> String token)</span> &#123;</span><br><span class="line">        <span class="comment">// 建立连接</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 关闭链接</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, Session session)</span> &#123;</span><br><span class="line">        <span class="comment">// 从Client接收消息</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnError</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Session session, Throwable error)</span> &#123;</span><br><span class="line">        error.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在用户开始匹配的时候，每个client向后端发送一个请求，就会在后端开辟一个线程，创建并维护一个websocket连接（实际上就是new一个WebSocketServer类的实例）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">WebSocketServer</span> <span class="variable">client1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebSocketServer</span>();</span><br><span class="line"><span class="type">WebSocketServer</span> <span class="variable">client2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">WebSocketServer</span>();</span><br></pre></td></tr></table></figure>

<p>后端接收到请求之后，将信息发送给匹配系统。</p>
<h2 id="集成WebSocket"><a href="#集成WebSocket" class="headerlink" title="集成WebSocket"></a>集成WebSocket</h2><p>1）在<code>pom.xml</code>文件中添加依赖：</p>
<ul>
<li><code>spring-boot-starter-websocket</code></li>
<li><code>fastjson</code></li>
</ul>
<p>2）添加<code>config.WebSocketConfig</code>配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.config;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.socket.server.standard.ServerEndpointExporter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> ServerEndpointExporter <span class="title function_">serverEndpointExporter</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ServerEndpointExporter</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3）添加<code>consumer.WebSocketServer</code>类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.consumer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.*;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.PathParam;</span><br><span class="line"><span class="keyword">import</span> javax.websocket.server.ServerEndpoint;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ServerEndpoint(&quot;/websocket/&#123;token&#125;&quot;)</span>  <span class="comment">// 注意不要以&#x27;/&#x27;结尾</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> &#123;</span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam(&quot;token&quot;)</span> String token)</span> &#123;</span><br><span class="line">        <span class="comment">//  建立连接时自动调用</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 关闭链接时自动调用</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, Session session)</span> &#123;</span><br><span class="line">        <span class="comment">// Server从Client接收消息时触发</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnError</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Session session, Throwable error)</span> &#123;</span><br><span class="line">        error.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面最核心的一个函数是<code>onMessage</code>，负责Server从Client接收消息时处理相关逻辑。那如何在通过后端，向前端client发送信息呢？</p>
<p>定义<code>Session</code>对象，每个连接本质上是通过<code>Session</code>维护</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<p>新增<code>sendMessage</code>函数，用于后端向当前连接发送信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(String message)</span>&#123;</span><br><span class="line">    <span class="comment">// Server发送消息</span></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>.session)&#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            <span class="built_in">this</span>.session.getBasicRemote().sendText(message);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外还需要存储下每个<code>connection</code>对应的用户是谁，这样才能清楚哪两个用户之间发生了匹配，用户信息也要存储到<code>Session</code>中。并且需要根据用户的<code>ID</code>，找到相应的<code>WebSocketServer</code>连接是哪一个，所以将两者的映射关系存储在<code>ConcurrentHashMap</code>中，<code>ConcurrentHashMap</code>是一个线程安全的哈希表</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> User user;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> ConcurrentHashMap&lt;Integer,WebSocketServer&gt;</span><br><span class="line">    userConnectionInfo = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>

<p>由于<code>WebSocket</code>不属于<code>Spring</code>的一个组件，不是单例模式，因此，注入<code>mapper</code>的方式有些区别</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserMapper</span><span class="params">(UserMapper userMapper)</span>&#123;</span><br><span class="line">    WebSocketServer.userMapper = userMapper;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在建立连接时，需要建立用户ID与<code>WebSocketServer</code>实例的映射</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnOpen</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam(&quot;token&quot;)</span> String token)</span> &#123;</span><br><span class="line">    <span class="comment">// 建立连接时自动调用</span></span><br><span class="line">    <span class="built_in">this</span>.session = session;</span><br><span class="line">    System.out.println(<span class="string">&quot;Connected!&quot;</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">userId</span> <span class="operator">=</span> Integer.parseInt(token);<span class="comment">//假设token为userId</span></span><br><span class="line">    <span class="built_in">this</span>.user = userMapper.selectById(userId);</span><br><span class="line">    userConnectionInfo.put(userId, <span class="built_in">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在关闭连接时，删除这种映射</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnClose</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 关闭链接时自动调用</span></span><br><span class="line">    System.out.println(<span class="string">&quot;Disconnected!&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.user != <span class="literal">null</span>)&#123;</span><br><span class="line">        userConnectionInfo.remove(<span class="built_in">this</span>.user.getId());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时的<code>WebSocketServer.java</code>为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@ServerEndpoint(&quot;/websocket/&#123;token&#125;&quot;)</span>  <span class="comment">// 注意不要以&#x27;/&#x27;结尾</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">WebSocketServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ConcurrentHashMap&lt;Integer,WebSocketServer&gt;</span><br><span class="line">            userConnectionInfo = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Session</span> <span class="variable">session</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setUserMapper</span><span class="params">(UserMapper userMapper)</span>&#123;</span><br><span class="line">        WebSocketServer.userMapper = userMapper;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@OnOpen</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam(&quot;token&quot;)</span> String token)</span> &#123;</span><br><span class="line">        <span class="comment">// 建立连接时自动调用</span></span><br><span class="line">        <span class="built_in">this</span>.session = session;</span><br><span class="line">        System.out.println(<span class="string">&quot;Connected!&quot;</span>);</span><br><span class="line">        <span class="type">int</span> <span class="variable">userId</span> <span class="operator">=</span> Integer.parseInt(token);<span class="comment">//假设token为userId</span></span><br><span class="line">        <span class="built_in">this</span>.user = userMapper.selectById(userId);</span><br><span class="line">        userConnectionInfo.put(userId, <span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnClose</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">// 关闭链接时自动调用</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Disconnected!&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">this</span>.user != <span class="literal">null</span>)&#123;</span><br><span class="line">            userConnectionInfo.remove(<span class="built_in">this</span>.user.getId());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnMessage</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, Session session)</span> &#123;</span><br><span class="line">        <span class="comment">// Server从Client接收消息时触发</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Receive message!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnError</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onError</span><span class="params">(Session session, Throwable error)</span> &#123;</span><br><span class="line">        error.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sendMessage</span><span class="params">(String message)</span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="built_in">this</span>.session)&#123;</span><br><span class="line">            <span class="keyword">try</span>&#123;</span><br><span class="line">                <span class="built_in">this</span>.session.getBasicRemote().sendText(message);</span><br><span class="line">            &#125;<span class="keyword">catch</span> (IOException e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4）配置<code>config.SecurityConfig</code>，将<code>/websocket/&#123;token&#125;</code>一类的<code>url</code>链接全部放行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(WebSecurity web)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    web.ignoring().antMatchers(<span class="string">&quot;/websocket/**&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="接口调试"><a href="#接口调试" class="headerlink" title="接口调试"></a>接口调试</h2><p>我们在<code>views\pk\PkIndexView.vue</code>中对<code>WebSocket</code>进行测试</p>
<p>期望在当前组件被加载成功之后，建立一个连接。</p>
<p>需要引入<code>vue</code>的两个与生命周期有关的函数</p>
<ul>
<li><code>onMounted</code>是当组件被挂载完成之后执行的函数</li>
<li><code>onUnmounted</code>是当组件被卸载之后执行的函数</li>
</ul>
<p>同时，需要将<code>WebSocket</code>存储到全局变量中，在store中开一个新的module用于存储所有和pk相关的全局变量</p>
<p><code>src\store\pk.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="title function_">default</span> (&#123;</span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">       <span class="attr">status</span>:<span class="string">&quot;matching&quot;</span>,<span class="comment">//matching表示匹配界面 playing表示对战界面</span></span><br><span class="line">       <span class="attr">socket</span>:<span class="literal">null</span>,<span class="comment">//存储前后端建立的connection</span></span><br><span class="line">       <span class="attr">opponent_username</span>:<span class="string">&quot;&quot;</span>,<span class="comment">//对手名</span></span><br><span class="line">       <span class="attr">opponent_photo</span>:<span class="string">&quot;&quot;</span>,<span class="comment">//对手头像</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mutations</span>: &#123;</span><br><span class="line">      </span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">actions</span>: &#123;</span><br><span class="line">       </span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">modules</span>: &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<p>由于在成功创建连接之后，需要将连接信息，存储到全局变量中</p>
<p>所以需要在<code>src\store\pk.js</code>实现几个辅助函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="title function_">default</span> (&#123;</span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">       <span class="attr">status</span>:<span class="string">&quot;matching&quot;</span>,<span class="comment">//matching表示匹配界面 playing表示对战界面</span></span><br><span class="line">       <span class="attr">socket</span>:<span class="literal">null</span>,<span class="comment">//存储前后端建立的connection</span></span><br><span class="line">       <span class="attr">opponent_username</span>:<span class="string">&quot;&quot;</span>,<span class="comment">//对手名</span></span><br><span class="line">       <span class="attr">opponent_photo</span>:<span class="string">&quot;&quot;</span>,<span class="comment">//对手头像</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mutations</span>: &#123;</span><br><span class="line">      <span class="title function_">updateSocket</span>(<span class="params">state, socket</span>)&#123;</span><br><span class="line">        state.<span class="property">socket</span> = socket;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">updateOpponent</span>(<span class="params">state, opponent</span>)&#123;</span><br><span class="line">        state.<span class="property">opponent_username</span> = opponent.<span class="property">username</span>;</span><br><span class="line">        state.<span class="property">opponent_photo</span> = opponent.<span class="property">photo</span>;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">updateStatus</span>(<span class="params">state, status</span>)&#123;</span><br><span class="line">        state.<span class="property">status</span> = status;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">actions</span>: &#123;</span><br><span class="line">       </span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">modules</span>: &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<p>然后在<code>views\pk\PkIndexView.vue</code>引入全局变量<code>useStore</code></p>
<p>在当前组件被挂载的时候（可以简单理解为页面被打开的时候），也就是<code>onMounted</code>执行的时候，我们需要创建<code>connection</code>，在<code>onUnmounted</code>执行的时候，关闭连接。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">components</span>:&#123;</span><br><span class="line">        <span class="title class_">PlayGround</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> store = <span class="title function_">useStore</span>();</span><br><span class="line">        <span class="keyword">const</span> socketUrl = <span class="string">`ws://127.0.0.1:3000/websocket/<span class="subst">$&#123;store.state.user.id&#125;</span>`</span>;</span><br><span class="line">        <span class="keyword">let</span> socket = <span class="literal">null</span>;</span><br><span class="line">        <span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">            socket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(socketUrl);</span><br><span class="line">            socket.<span class="property">onopen</span> = <span class="function">() =&gt;</span> &#123;<span class="comment">//如果连接成功，将socket存储到全局变量中</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;connected!&quot;</span>);</span><br><span class="line">                store.<span class="title function_">commit</span>(<span class="string">&quot;updateSocket&quot;</span>,socket);</span><br><span class="line">            &#125;</span><br><span class="line">            socket.<span class="property">onmessage</span> = <span class="function"><span class="params">msg</span> =&gt;</span>&#123;</span><br><span class="line">                <span class="keyword">const</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(msg.<span class="property">data</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">            &#125;</span><br><span class="line">            socket.<span class="property">onclose</span> = <span class="function">() =&gt;</span>&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;disconnected!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="title function_">onUnmounted</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            socket.<span class="title function_">close</span>();</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="建立连接"><a href="#建立连接" class="headerlink" title="建立连接"></a>建立连接</h3><p>当进入到对战页面时，可以在后端和浏览器的控制台中看到连接成功的输出</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220810145912567.png" alt="image-20220810145912567"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220810145928993.png" alt="image-20220810145928993"></p>
<p>此时如果切换到其他页面，又会断开连接</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220810150031718.png" alt="image-20220810150031718"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220810150017457.png" alt="image-20220810150017457"></p>
<p>注意如果刷新页面，就会先断开连接，后建立连接</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220810150242024.png" alt="image-20220810150242024"></p>
<p>而且，必须要在页面卸载时，关闭连接</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">onUnmounted</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">	socket.<span class="title function_">close</span>();</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>否则，切换到其他页面的时候，没有关闭连接，但是在每一次进来的时候，又会创建连接</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220810150549415.png" alt="image-20220810150549415"></p>
<p>刷新或者关闭时，会关闭所有的连接，从输出看出不止一个</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220810150637938.png" alt="image-20220810150637938"></p>
<p>所以，如果不进行正常关闭，在切换到其他页面时，旧连接不会关闭，因此会产生很多冗余的连接。</p>
<p>在成功连接后，后端输出获取到的用户信息如下：</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220810151904289.png" alt="image-20220810151904289"></p>
<p>此时建立连接时，是直接将用户的ID传输过来，但这样显然是不安全的，因为前端可以通过修改<code>&#123;token&#125;</code>的方式，伪装成任意一个用户的身份建立连接，因此需要添加验证，这里仍然是使用<code>Jwt</code>进行验证</p>
<h3 id="Jwt验证"><a href="#Jwt验证" class="headerlink" title="Jwt验证"></a>Jwt验证</h3><p>前端直接将<code>jwt-token</code>传过去</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> socketUrl = <span class="string">`ws://127.0.0.1:3000/websocket/<span class="subst">$&#123;store.state.user.token&#125;</span>`</span>;</span><br></pre></td></tr></table></figure>

<p>后端验证的方式，在<code>config.filter.JwtAuthenticationTokenFilter</code>已经给出</p>
<p>那就是就是如果能从<code>token</code>中解析出<code>userId</code>就认为是合法的，否则就是不合法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">String userid;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> JwtUtil.parseJWT(token);</span><br><span class="line">    <span class="comment">//如果能解析出userid表示合法 否则不合法</span></span><br><span class="line">    userid = claims.getSubject();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了日后方便，将这段代码提出，放在一个单独的工具类<code>consumer.utils.JwtAuthentication</code>中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.kob.backend.consumer.utils;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.kob.backend.utils.JwtUtil;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthentication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title function_">getUserId</span><span class="params">(String token)</span>&#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">userId</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> JwtUtil.parseJWT(token);</span><br><span class="line">            <span class="comment">//如果能解析出userid表示合法 否则不合法</span></span><br><span class="line">            userId = Integer.parseInt(claims.getSubject());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> userId;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时<code>WebSocketServer.java</code>中<code>onOpen</code>函数体更新为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnOpen</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">(Session session, <span class="meta">@PathParam(&quot;token&quot;)</span> String token)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// 建立连接时自动调用</span></span><br><span class="line">    <span class="built_in">this</span>.session = session;</span><br><span class="line">    System.out.println(<span class="string">&quot;Connected!&quot;</span>);</span><br><span class="line">    <span class="type">int</span> <span class="variable">userId</span> <span class="operator">=</span> JwtAuthentication.getUserId(token);</span><br><span class="line">    <span class="built_in">this</span>.user = userMapper.selectById(userId);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.user != <span class="literal">null</span>)</span><br><span class="line">        userConnectionInfo.put(userId, <span class="built_in">this</span>);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">this</span>.session.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样就能够成功实现<code>jwt</code>验证</p>
<h2 id="前端实现"><a href="#前端实现" class="headerlink" title="前端实现"></a>前端实现</h2><p>此时前端还只有对战界面，并没有匹配界面，我们需要实现匹配界面，以及匹配界面和对战界面的切换</p>
<p>与切换有关的全局变量，就是在<code>pk.js</code>中定义的<code>status</code>， <code>matching</code>表示匹配界面，<code>playing</code>表示对战界面</p>
<p>那就需要当<code>status</code>为<code>playing</code>的时候再显示对战页面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;PlayGround v-if=&quot;$store.state.pk.status === &#x27;playing&#x27;&quot;/&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p>并且需要创建一个新的组件<code>MatchGround.vue</code>，用于表示匹配界面</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;div class=&quot;matchground&quot;&gt;</span><br><span class="line">        &lt;div class=&quot;row&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;col-6&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;user_photo&quot;&gt;</span><br><span class="line">                    &lt;img :src=&quot;$store.state.user.photo&quot; alt=&quot;&quot;&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;user_username&quot;&gt;</span><br><span class="line">                    &#123;&#123; $store.state.user.username &#125;&#125;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">            &lt;div class=&quot;col-6&quot;&gt;</span><br><span class="line">                &lt;div class=&quot;user_photo&quot;&gt;</span><br><span class="line">                    &lt;img :src=&quot;$store.state.pk.opponent_photo&quot; alt=&quot;&quot;&gt;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">                &lt;div class=&quot;user_username&quot;&gt;</span><br><span class="line">                    &#123;&#123; $store.state.pk.opponent_username &#125;&#125;</span><br><span class="line">                &lt;/div&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &lt;div class=&quot;row&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;col-12&quot; style=&quot;text-align:center; padding-top:12vh&quot;&gt;</span><br><span class="line">                    &lt;button @click=&quot;click_match_btn&quot; class=&quot;btn btn-success btn-lg&quot;&gt;&#123;&#123;match_btn_info&#125;&#125;&lt;/button&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p>为按钮绑定一个<code>click_match_btn</code>触发函数，当点击”开始匹配”，使用<code>WebSocket</code>的<code>sent</code>API向后端发送包含<code>event:&quot;start-matching&quot;</code>的字符串（注意，<code>JSON.stringify</code>是将<code>JSON</code>格式处理为字符串，后续还可以恢复<code>JSON</code>格式）</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">import</span> &#123; ref &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; useStore &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span>;</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="title function_">setup</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="keyword">const</span> store = <span class="title function_">useStore</span>();</span><br><span class="line">        <span class="keyword">let</span> match_btn_info = <span class="title function_">ref</span>(<span class="string">&quot;开始匹配&quot;</span>);</span><br><span class="line">        <span class="keyword">const</span> <span class="title function_">click_match_btn</span> = (<span class="params"></span>) =&gt;&#123;</span><br><span class="line">            <span class="keyword">if</span>(match_btn_info.<span class="property">value</span> === <span class="string">&quot;开始匹配&quot;</span>)&#123;</span><br><span class="line">                match_btn_info.<span class="property">value</span> = <span class="string">&quot;取消&quot;</span>;</span><br><span class="line">                <span class="comment">//JSON.stringify将JSON转换为字符串</span></span><br><span class="line">                store.<span class="property">state</span>.<span class="property">pk</span>.<span class="property">socket</span>.<span class="title function_">sent</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">                    <span class="attr">event</span>:<span class="string">&quot;start-matching&quot;</span>,</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                match_btn_info.<span class="property">value</span> = <span class="string">&quot;开始匹配&quot;</span>;</span><br><span class="line">                store.<span class="property">state</span>.<span class="property">pk</span>.<span class="property">socket</span>.<span class="title function_">sent</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;</span><br><span class="line">                    <span class="attr">event</span>:<span class="string">&quot;stop-matching&quot;</span>,</span><br><span class="line">                &#125;));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">return</span>&#123;</span><br><span class="line">            match_btn_info,</span><br><span class="line">            click_match_btn,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>后端收到请求时，就会将<code>message</code>字符串解析为<code>JSON</code>格式，然后根据<code>event</code>值来分配给不同的任务</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startMatching</span><span class="params">()</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;start matching!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">stopMatching</span><span class="params">()</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;stop matching!&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@OnMessage</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, Session session)</span> &#123;<span class="comment">//当做路由 分配任务</span></span><br><span class="line">    <span class="comment">// Server从Client接收消息时触发</span></span><br><span class="line">    System.out.println(<span class="string">&quot;Receive message!&quot;</span>);</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">data</span> <span class="operator">=</span> JSONObject.parseObject(message);<span class="comment">//将字符串解析成JSON</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">event</span> <span class="operator">=</span> data.getString(<span class="string">&quot;event&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;start-matching&quot;</span>.equals(event))&#123;<span class="comment">//防止event为空的异常</span></span><br><span class="line">        startMatching();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;stop-matching&quot;</span>.equals(event)) &#123;</span><br><span class="line">        stopMatching();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在后端需要建立一个线程安全的Set作为匹配池</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> CopyOnWriteArraySet&lt;User&gt; </span><br><span class="line">        matchpool = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArraySet</span>&lt;&gt;();</span><br></pre></td></tr></table></figure>

<p>然后在相应的时间添加和删除</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@OnClose</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="comment">// 关闭链接时自动调用</span></span><br><span class="line">    System.out.println(<span class="string">&quot;Disconnected!&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">this</span>.user != <span class="literal">null</span>)&#123;</span><br><span class="line">        userConnectionInfo.remove(<span class="built_in">this</span>.user.getId());</span><br><span class="line">        matchpool.remove(<span class="built_in">this</span>.user);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startMatching</span><span class="params">()</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;start matching!&quot;</span>);</span><br><span class="line">    matchpool.add(<span class="built_in">this</span>.user);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">stopMatching</span><span class="params">()</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;stop matching!&quot;</span>);</span><br><span class="line">    matchpool.remove(<span class="built_in">this</span>.user);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于现在还没有实现微服务，暂时先实现一个傻瓜式的匹配，也就是匹配池中大于等于两个用户的时候，就实现两两匹配，也就是两个用户<code>user1</code>和<code>user2</code>，并通过两个用户自己的连接，告诉前端匹配成功的相关消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startMatching</span><span class="params">()</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;start matching!&quot;</span>);</span><br><span class="line">    matchpool.add(<span class="built_in">this</span>.user);</span><br><span class="line">    <span class="keyword">while</span> (matchpool.size() &gt;= <span class="number">2</span>)&#123;</span><br><span class="line">        Iterator&lt;User&gt; iterator = matchpool.iterator();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user2</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">        matchpool.remove(user1);</span><br><span class="line">        matchpool.remove(user2);</span><br><span class="line">        <span class="comment">//分别给user1和user2传送消息告诉他们匹配成功了</span></span><br><span class="line">        <span class="comment">//通过user1的连接向user1发消息</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">resp1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        resp1.put(<span class="string">&quot;event&quot;</span>,<span class="string">&quot;start-matching&quot;</span>);</span><br><span class="line">        resp1.put(<span class="string">&quot;opponent_username&quot;</span>,user2.getUsername());</span><br><span class="line">        resp1.put(<span class="string">&quot;opponent_photo&quot;</span>,user2.getPhoto());</span><br><span class="line">        <span class="type">WebSocketServer</span> <span class="variable">webSocketServer1</span> <span class="operator">=</span> userConnectionInfo.get(user1.getId());<span class="comment">//获取user1的连接</span></span><br><span class="line">        webSocketServer1.sendMessage(resp1.toJSONString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过user2的连接向user2发消息</span></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">resp2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        resp2.put(<span class="string">&quot;event&quot;</span>,<span class="string">&quot;start-matching&quot;</span>);</span><br><span class="line">        resp2.put(<span class="string">&quot;opponent_username&quot;</span>,user1.getUsername());</span><br><span class="line">        resp2.put(<span class="string">&quot;opponent_photo&quot;</span>,user1.getPhoto());</span><br><span class="line">        <span class="type">WebSocketServer</span> <span class="variable">webSocketServer2</span> <span class="operator">=</span> userConnectionInfo.get(user2.getId());</span><br><span class="line">        webSocketServer2.sendMessage(resp2.toJSONString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在前端的<code>PkIndexView.vue</code>中，当接收到后端发送的消息之后，相关逻辑的实现在<code>onmessage</code>函数中</p>
<p>如果匹配成功，就要更新对手信息</p>
<h3 id="匹配测试"><a href="#匹配测试" class="headerlink" title="匹配测试"></a>匹配测试</h3><p>注意，需要两个用户进行测试的话，必须在两个不同的浏览器中。一个浏览器只能允许同时登录一个用户，因为在<code>Local Storage</code>中会共用一个<code>jwt_token</code></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220810182946774.png" alt="image-20220810182946774"></p>
<p>前端如何匹配成功，就更新对手的用户名和头像。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="title class_">PlayGround</span> <span class="keyword">from</span> <span class="string">&#x27;../../components/PlayGround.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> <span class="title class_">MatchGround</span> <span class="keyword">from</span> <span class="string">&#x27;../../components/MatchGround.vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; onMounted &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; onUnmounted &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; useStore &#125; <span class="keyword">from</span> <span class="string">&#x27;vuex&#x27;</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="attr">components</span>:&#123;</span><br><span class="line">        <span class="title class_">PlayGround</span>,</span><br><span class="line">        <span class="title class_">MatchGround</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">setup</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">const</span> store = <span class="title function_">useStore</span>();</span><br><span class="line">        <span class="keyword">const</span> socketUrl = <span class="string">`ws://127.0.0.1:3000/websocket/<span class="subst">$&#123;store.state.user.token&#125;</span>`</span>;</span><br><span class="line">        <span class="keyword">let</span> socket = <span class="literal">null</span>;</span><br><span class="line">        <span class="title function_">onMounted</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">            store.<span class="title function_">commit</span>(<span class="string">&quot;updateOpponent&quot;</span>,&#123;</span><br><span class="line">                <span class="attr">username</span>:<span class="string">&quot;我的对手&quot;</span>,</span><br><span class="line">                <span class="attr">photo</span>:<span class="string">&quot;https://cdn.acwing.com/media/article/image/2022/08/09/1_1db2488f17-anonymous.png&quot;</span>,</span><br><span class="line">            &#125;);</span><br><span class="line">            socket = <span class="keyword">new</span> <span class="title class_">WebSocket</span>(socketUrl);</span><br><span class="line">            socket.<span class="property">onopen</span> = <span class="function">() =&gt;</span> &#123;<span class="comment">//如果连接成功，将socket存储到全局变量中</span></span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;connected!&quot;</span>);</span><br><span class="line">                store.<span class="title function_">commit</span>(<span class="string">&quot;updateSocket&quot;</span>,socket);</span><br><span class="line">            &#125;</span><br><span class="line">            socket.<span class="property">onmessage</span> = <span class="function"><span class="params">msg</span> =&gt;</span>&#123;</span><br><span class="line">                <span class="keyword">const</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(msg.<span class="property">data</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">                <span class="keyword">if</span>(data.<span class="property">event</span> === <span class="string">&quot;start-matching&quot;</span>)&#123;</span><br><span class="line">                    store.<span class="title function_">commit</span>(<span class="string">&quot;updateOpponent&quot;</span>,&#123;</span><br><span class="line">                        <span class="attr">username</span>:data.<span class="property">opponent_username</span>,</span><br><span class="line">                        <span class="attr">photo</span>:data.<span class="property">opponent_photo</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                    <span class="comment">// store.commit(&quot;updateStatus&quot;,&quot;playing&quot;)</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            socket.<span class="property">onclose</span> = <span class="function">() =&gt;</span>&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;disconnected!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="title function_">onUnmounted</span>(<span class="function">()=&gt;</span>&#123;</span><br><span class="line">            socket.<span class="title function_">close</span>();</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220810184626741.png" alt="image-20220810184626741"></p>
<p>然后在匹配成功之后，设置延迟两秒显示，然后跳转到对战页面</p>
<img src="/images/实现微服务：匹配系统/image-20220810185856530.png" alt="image-20220810185856530" style="zoom:80%;" />

<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220810192234151.png" alt="image-20220810192234151"></p>
<p>如果切换其他页面再切换回来的时候，地图又发生了变化，期望点击其他页面的时候自动放弃，再切换回来的时候，重新回到匹配页面。</p>
<p>那就需要在卸载页面（<code>onUnmounted</code>）的时候，不仅需要断开连接，同时还要将状态切换为<code>matching</code>状态。</p>
<p>但此时有一个很大的问题，就是两个人的游戏地图不一致。这是因为地图是在浏览器本地生成，为了解决同步问题，需要由服务器统一接管。</p>
<h2 id="地图同步"><a href="#地图同步" class="headerlink" title="地图同步"></a>地图同步</h2><p>接下来需要在服务器端实现之前分析的Game流程</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220809235633315.png" alt="image-20220809235633315"></p>
<p>添加<code>consumer.utils.Game.java</code>，用于管理整个游戏流程</p>
<p>参考<code>assets\scripts\GameMap.js</code></p>
<p>画地图参考<code>GameMap.js</code>中<code>create_walls()</code>函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Random;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Game</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> Integer rows;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> Integer cols;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> Integer inner_walls_count;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="type">int</span>[][] g;</span><br><span class="line">    <span class="comment">//辅助数组</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] dx = &#123;-<span class="number">1</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">int</span>[] dy = &#123;<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,-<span class="number">1</span>&#125;;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Game</span><span class="params">(Integer rows, Integer cols, Integer inner_walls_count)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.rows = rows;</span><br><span class="line">        <span class="built_in">this</span>.cols = cols;</span><br><span class="line">        <span class="built_in">this</span>.inner_walls_count = inner_walls_count;</span><br><span class="line">        <span class="built_in">this</span>.g = <span class="keyword">new</span> <span class="title class_">int</span>[rows][cols];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span>[][] getG() &#123;<span class="comment">//返回地图</span></span><br><span class="line">        <span class="keyword">return</span> g;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">check_connectivity</span><span class="params">(<span class="type">int</span> sx, <span class="type">int</span> sy,<span class="type">int</span> tx, <span class="type">int</span> ty)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (sx == tx &amp;&amp; sy == ty)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        g[sx][sy] = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">4</span>; i++)&#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> sx + dx[i];</span><br><span class="line">            <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> sy + dy[i];</span><br><span class="line">            <span class="keyword">if</span>(x &gt;= <span class="number">0</span> &amp;&amp; x &lt; <span class="built_in">this</span>.rows &amp;&amp; y &gt;= <span class="number">0</span> &amp;&amp; y &lt; <span class="built_in">this</span>.cols &amp;&amp; g[x][y] == <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(check_connectivity(x, y, tx, ty))&#123;</span><br><span class="line">                    g[sx][sy] = <span class="number">0</span>;<span class="comment">//恢复现场</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        g[sx][sy] = <span class="number">0</span>;<span class="comment">//恢复现场</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">draw</span><span class="params">()</span>&#123;<span class="comment">//绘制地图</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.rows; i++) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="built_in">this</span>.cols; j++) &#123;</span><br><span class="line">                g[i][j] = <span class="number">0</span>;<span class="comment">//0表示可通行区域 1表示障碍物</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//给四周加上障碍物</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> <span class="number">0</span>; r &lt; <span class="built_in">this</span>.rows; r++)&#123;<span class="comment">//给左右两侧设置为1</span></span><br><span class="line">            g[r][<span class="number">0</span>]=<span class="number">1</span>;</span><br><span class="line">            g[r][<span class="built_in">this</span>.cols-<span class="number">1</span>]=<span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">0</span>; c &lt; <span class="built_in">this</span>.cols; c++)&#123;<span class="comment">//给上下两侧设置为1</span></span><br><span class="line">            g[<span class="number">0</span>][c] = g[<span class="built_in">this</span>.rows-<span class="number">1</span>][c] = <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//在内部随机生成inner_walls_count个对称的障碍物</span></span><br><span class="line">        <span class="type">Random</span> <span class="variable">random</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Random</span>();</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.inner_walls_count / <span class="number">2</span>; i++)&#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> <span class="number">0</span>; j &lt; <span class="number">1000</span>; j++) &#123;</span><br><span class="line">                <span class="type">int</span> <span class="variable">r</span> <span class="operator">=</span> random.nextInt(<span class="built_in">this</span>.rows);<span class="comment">//返回0~rows-1的随机值</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> random.nextInt(<span class="built_in">this</span>.cols);<span class="comment">//返回0~cols-1的随机值</span></span><br><span class="line">                <span class="keyword">if</span>(g[r][c] == <span class="number">1</span> || g[<span class="built_in">this</span>.rows - <span class="number">1</span> - r][<span class="built_in">this</span>.cols - <span class="number">1</span> - c] == <span class="number">1</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;<span class="comment">//已经有了 不能重复添加 直接进入下一轮循环 j++</span></span><br><span class="line">                <span class="keyword">if</span>(r == <span class="built_in">this</span>.rows - <span class="number">2</span> &amp;&amp; c == <span class="number">1</span> || r == <span class="number">1</span> &amp;&amp; c == <span class="built_in">this</span>.cols-<span class="number">2</span>)</span><br><span class="line">                    <span class="keyword">continue</span>;<span class="comment">//保证左上角和右下角不能有障碍物</span></span><br><span class="line"></span><br><span class="line">                <span class="comment">//成功设置一个障碍物后 直接退出当前for i++</span></span><br><span class="line">                g[r][c] = g[<span class="built_in">this</span>.rows - <span class="number">1</span> - r][<span class="built_in">this</span>.cols - <span class="number">1</span> - c] = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断连通性</span></span><br><span class="line">        <span class="keyword">return</span> check_connectivity(<span class="built_in">this</span>.rows-<span class="number">2</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="built_in">this</span>.cols-<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createMap</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span>(draw())</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后在<code>WebSocketServer.java</code></p>
<p>当开始匹配的时候，实例化一个Game对象用于生成地图，并将生成的地图返回给连接中的两个用户。</p>
<blockquote>
<p>当然，最终的地图应该是保存在webSocket中，也就是只对当前匹配的两个用户可见，对其他连接的用户不可见，这一点放在后面实现。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startMatching</span><span class="params">()</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;start matching!&quot;</span>);</span><br><span class="line">    matchpool.add(<span class="built_in">this</span>.user);</span><br><span class="line">    <span class="keyword">while</span> (matchpool.size() &gt;= <span class="number">2</span>)&#123;</span><br><span class="line">        Iterator&lt;User&gt; iterator = matchpool.iterator();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user1</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user2</span> <span class="operator">=</span> iterator.next();</span><br><span class="line">        matchpool.remove(user1);</span><br><span class="line">        matchpool.remove(user2);</span><br><span class="line">        <span class="type">Game</span> <span class="variable">game</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Game</span>(<span class="number">13</span>,<span class="number">14</span>,<span class="number">20</span>);</span><br><span class="line">        game.createMap();</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">resp1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        resp1.put(<span class="string">&quot;event&quot;</span>,<span class="string">&quot;start-matching&quot;</span>);</span><br><span class="line">        resp1.put(<span class="string">&quot;opponent_username&quot;</span>,user2.getUsername());</span><br><span class="line">        resp1.put(<span class="string">&quot;opponent_photo&quot;</span>,user2.getPhoto());</span><br><span class="line">        resp1.put(<span class="string">&quot;gamemap&quot;</span>,game.getG());</span><br><span class="line">        <span class="type">WebSocketServer</span> <span class="variable">webSocketServer1</span> <span class="operator">=</span> userConnectionInfo.get(user1.getId());</span><br><span class="line">        webSocketServer1.sendMessage(resp1.toJSONString());</span><br><span class="line"></span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">resp2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        resp2.put(<span class="string">&quot;event&quot;</span>,<span class="string">&quot;start-matching&quot;</span>);</span><br><span class="line">        resp2.put(<span class="string">&quot;opponent_username&quot;</span>,user1.getUsername());</span><br><span class="line">        resp2.put(<span class="string">&quot;opponent_photo&quot;</span>,user1.getPhoto());</span><br><span class="line">        resp2.put(<span class="string">&quot;gamemap&quot;</span>,game.getG());</span><br><span class="line">        <span class="type">WebSocketServer</span> <span class="variable">webSocketServer2</span> <span class="operator">=</span> userConnectionInfo.get(user2.getId());</span><br><span class="line">        webSocketServer2.sendMessage(resp2.toJSONString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时后端可以返回地图，前端写好接收地图的逻辑</p>
<p><code>src\store\pk.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="title function_">default</span> (&#123;</span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">       <span class="attr">status</span>:<span class="string">&quot;matching&quot;</span>,<span class="comment">//matching表示匹配界面 playing表示对战界面</span></span><br><span class="line">       <span class="attr">socket</span>:<span class="literal">null</span>,<span class="comment">//存储前后端建立的connection</span></span><br><span class="line">       <span class="attr">opponent_username</span>:<span class="string">&quot;&quot;</span>,<span class="comment">//对手名</span></span><br><span class="line">       <span class="attr">opponent_photo</span>:<span class="string">&quot;&quot;</span>,<span class="comment">//对手头像</span></span><br><span class="line">       <span class="attr">gamemap</span>:<span class="literal">null</span><span class="comment">//地图</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mutations</span>: &#123;</span><br><span class="line">      <span class="title function_">updateSocket</span>(<span class="params">state, socket</span>)&#123;</span><br><span class="line">        state.<span class="property">socket</span> = socket;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">updateOpponent</span>(<span class="params">state, opponent</span>)&#123;</span><br><span class="line">        state.<span class="property">opponent_username</span> = opponent.<span class="property">username</span>;</span><br><span class="line">        state.<span class="property">opponent_photo</span> = opponent.<span class="property">photo</span>;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">updateStatus</span>(<span class="params">state, status</span>)&#123;</span><br><span class="line">        state.<span class="property">status</span> = status;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">updayeGamemap</span>(<span class="params">state, gamemap</span>)&#123;</span><br><span class="line">        state.<span class="property">gamemap</span> = gamemap;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">actions</span>: &#123;</span><br><span class="line">       </span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">modules</span>: &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br></pre></td></tr></table></figure>

<p><code>src\views\pk\PkIndexView.vue</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">socket.<span class="property">onmessage</span> = <span class="function"><span class="params">msg</span> =&gt;</span> &#123;</span><br><span class="line">                <span class="keyword">const</span> data = <span class="title class_">JSON</span>.<span class="title function_">parse</span>(msg.<span class="property">data</span>);</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(data);</span><br><span class="line">                <span class="keyword">if</span> (data.<span class="property">event</span> === <span class="string">&quot;start-matching&quot;</span>) &#123;</span><br><span class="line">                    store.<span class="title function_">commit</span>(<span class="string">&quot;updateOpponent&quot;</span>, &#123;</span><br><span class="line">                        <span class="attr">username</span>: data.<span class="property">opponent_username</span>,</span><br><span class="line">                        <span class="attr">photo</span>: data.<span class="property">opponent_photo</span></span><br><span class="line">                    &#125;);</span><br><span class="line">                    <span class="comment">//匹配成功后，延时2秒，进入对战页面</span></span><br><span class="line">                    <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">                        store.<span class="title function_">commit</span>(<span class="string">&quot;updateStatus&quot;</span>, <span class="string">&quot;playing&quot;</span>)</span><br><span class="line">                    &#125;, <span class="number">2000</span>);</span><br><span class="line">                    store.<span class="title function_">commit</span>(<span class="string">&quot;updateGamemap&quot;</span>,data.<span class="property">gamemap</span>)<span class="comment">//更新地图</span></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>后端获取<code>gamemap</code>并更新到全局变量之后，要将获取到的<code>gamemap</code>渲染到画布上</p>
<p>首先在组件<code>GameMap.vue</code>中将全局变量<code>store</code>传递到<code>GameMap</code>的构造函数中</p>
<p><code>src\components\GameMap.vue</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">import &#123; GameMap &#125; from &#x27;../assets/scripts/GameMap&#x27;</span><br><span class="line">import &#123;onMounted, ref&#125; from &#x27;vue&#x27; //用于定义变量</span><br><span class="line">import &#123; useStore &#125; from &#x27;vuex&#x27;;</span><br><span class="line">export default &#123;</span><br><span class="line">    setup()&#123;</span><br><span class="line">        const store = useStore();</span><br><span class="line">        let parent = ref(null);</span><br><span class="line">        let canvas = ref(null);</span><br><span class="line">        onMounted(()=&gt;&#123;</span><br><span class="line">            new GameMap(canvas.value.getContext(&#x27;2d&#x27;), parent.value, store)</span><br><span class="line">        &#125;);</span><br><span class="line">        return&#123;</span><br><span class="line">            parent,</span><br><span class="line">            canvas</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>对于<code>scripts\GameMap.js</code></p>
<p>相关的代码更新为：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">GameMap</span> <span class="keyword">extends</span> <span class="title class_ inherited__">GameObject</span> &#123;</span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">ctx, parent, store</span>)&#123;</span><br><span class="line">        <span class="variable language_">super</span>();</span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">ctx</span> = ctx;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">parent</span> = parent;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">store</span> = store;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">L</span> = <span class="number">0</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">rows</span> = <span class="number">13</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">cols</span> = <span class="number">14</span>;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">inner_walls_count</span> = <span class="number">10</span>;<span class="comment">//定义内部障碍物数量</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">walls</span> = [];<span class="comment">//用于保存障碍物,属于对象数组</span></span><br><span class="line"></span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">snakes</span> = [</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Snake</span>(&#123;<span class="attr">id</span>:<span class="number">0</span>, <span class="attr">color</span>:<span class="string">&quot;#4876EC&quot;</span>,<span class="attr">r</span>: <span class="variable language_">this</span>.<span class="property">rows</span> - <span class="number">2</span>, <span class="attr">c</span>: <span class="number">1</span>&#125;,<span class="variable language_">this</span>),</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">Snake</span>(&#123;<span class="attr">id</span>:<span class="number">1</span>, <span class="attr">color</span>:<span class="string">&quot;#F94848&quot;</span>,<span class="attr">r</span>: <span class="number">1</span>, <span class="attr">c</span>: <span class="variable language_">this</span>.<span class="property">cols</span> - <span class="number">2</span>&#125;,<span class="variable language_">this</span>),</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">//画地图:创建障碍物</span></span><br><span class="line">    <span class="title function_">create_walls</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="comment">//直接将地图取出--后端传过来</span></span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">store</span>)</span><br><span class="line">        <span class="keyword">const</span> g = <span class="variable language_">this</span>.<span class="property">store</span>.<span class="property">state</span>.<span class="property">pk</span>.<span class="property">gamemap</span>;</span><br><span class="line">        <span class="comment">//创建障碍物对象 并添加到this.walls数组</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">let</span> r = <span class="number">0</span>; r &lt; <span class="variable language_">this</span>.<span class="property">rows</span>; r++)&#123;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">let</span> c = <span class="number">0</span>; c &lt; <span class="variable language_">this</span>.<span class="property">cols</span>; c++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(g[r][c])&#123;</span><br><span class="line">                    <span class="variable language_">this</span>.<span class="property">walls</span>.<span class="title function_">push</span>(<span class="keyword">new</span> <span class="title class_">Wall</span> (r,c,<span class="variable language_">this</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_">start</span>(<span class="params"></span>)&#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">create_walls</span>();<span class="comment">//不用循环1000次了 因为直接接收的后端生成的</span></span><br><span class="line">        <span class="variable language_">this</span>.<span class="title function_">add_listening_events</span>();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>至此，就解决了地图同步问题</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220817162739007.png" alt="image-20220817162739007"></p>
<h2 id="玩家位置同步"><a href="#玩家位置同步" class="headerlink" title="玩家位置同步"></a>玩家位置同步</h2><h3 id="后端修改"><a href="#后端修改" class="headerlink" title="后端修改"></a>后端修改</h3><p>玩家的位置也要在服务端确定，确定完之后将每个玩家的位置传到前端。</p>
<p>添加一个玩家类</p>
<p><code>consumer.utils.Game.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Player</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> Integer sx;<span class="comment">//起始x坐标</span></span><br><span class="line">    <span class="keyword">private</span> Integer sy;<span class="comment">//起始y坐标</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; steps;<span class="comment">//保存每一步操作---决定了蛇当前的形状</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在初始化<code>Game</code>的时候，实例化两个<code>Player</code>对象</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220817175347817.png" alt="image-20220817175347817"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220817175807564.png" alt="image-20220817175807564"></p>
<p>在<code>WebSocketServer.java</code>中，为了方便管理，将与<code>Game</code>相关的信息，封装成一个<code>JSON</code></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220817181541093.png" alt="image-20220817181541093"></p>
<p>这样后端就可以将两名玩家的信息（包括生成的地图）传送给前端</p>
<h3 id="前端修改"><a href="#前端修改" class="headerlink" title="前端修改"></a>前端修改</h3><p>在<code>src\store\pk.js</code>中添加玩家信息的变量和更新函数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="title function_">default</span> (&#123;</span><br><span class="line">    <span class="attr">state</span>: &#123;</span><br><span class="line">       <span class="attr">status</span>:<span class="string">&quot;matching&quot;</span>,<span class="comment">//matching表示匹配界面 playing表示对战界面</span></span><br><span class="line">       <span class="attr">socket</span>:<span class="literal">null</span>,<span class="comment">//存储前后端建立的connection</span></span><br><span class="line">       <span class="attr">opponent_username</span>:<span class="string">&quot;&quot;</span>,<span class="comment">//对手名</span></span><br><span class="line">       <span class="attr">opponent_photo</span>:<span class="string">&quot;&quot;</span>,<span class="comment">//对手头像</span></span><br><span class="line">       <span class="attr">gamemap</span>:<span class="literal">null</span>,</span><br><span class="line">       <span class="attr">a_id</span>:<span class="number">0</span>,</span><br><span class="line">       <span class="attr">a_sx</span>:<span class="number">0</span>,</span><br><span class="line">       <span class="attr">a_sy</span>:<span class="number">0</span>,</span><br><span class="line">       <span class="attr">b_id</span>:<span class="number">0</span>,</span><br><span class="line">       <span class="attr">b_sx</span>:<span class="number">0</span>,</span><br><span class="line">       <span class="attr">b_sy</span>:<span class="number">0</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">mutations</span>: &#123;</span><br><span class="line">      <span class="title function_">updateSocket</span>(<span class="params">state, socket</span>)&#123;</span><br><span class="line">        state.<span class="property">socket</span> = socket;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">updateOpponent</span>(<span class="params">state, opponent</span>)&#123;</span><br><span class="line">        state.<span class="property">opponent_username</span> = opponent.<span class="property">username</span>;</span><br><span class="line">        state.<span class="property">opponent_photo</span> = opponent.<span class="property">photo</span>;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">updateStatus</span>(<span class="params">state, status</span>)&#123;</span><br><span class="line">        state.<span class="property">status</span> = status;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="title function_">updateGame</span>(<span class="params">state, game</span>)&#123;</span><br><span class="line">        state.<span class="property">a_id</span> = game.<span class="property">a_id</span>;</span><br><span class="line">        state.<span class="property">a_sx</span> = game.<span class="property">a_sx</span>;</span><br><span class="line">        state.<span class="property">a_sy</span> = game.<span class="property">a_sy</span>;</span><br><span class="line">        state.<span class="property">b_id</span> = game.<span class="property">b_id</span>;</span><br><span class="line">        state.<span class="property">b_sx</span> = game.<span class="property">b_sx</span>;</span><br><span class="line">        state.<span class="property">b_sy</span> = game.<span class="property">b_sy</span>;</span><br><span class="line">        state.<span class="property">gamemap</span> = game.<span class="property">map</span>;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">actions</span>: &#123;</span><br><span class="line">       </span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">modules</span>: &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">  </span><br></pre></td></tr></table></figure>

<p>在<code>src\views\pk\PkIndexView.vue</code>中，在<code>onmessage</code>中，调用<code>updateGame</code>函数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">import PlayGround from &#x27;../../components/PlayGround.vue&#x27;</span><br><span class="line">import MatchGround from &#x27;../../components/MatchGround.vue&#x27;</span><br><span class="line">import &#123; onMounted &#125; from &#x27;vue&#x27;</span><br><span class="line">import &#123; onUnmounted &#125; from &#x27;vue&#x27;</span><br><span class="line">import &#123; useStore &#125; from &#x27;vuex&#x27;</span><br><span class="line">export default &#123;</span><br><span class="line">    components: &#123;</span><br><span class="line">        PlayGround,</span><br><span class="line">        MatchGround</span><br><span class="line">    &#125;,</span><br><span class="line">    setup() &#123;</span><br><span class="line">        const store = useStore();</span><br><span class="line">        const socketUrl = `ws://127.0.0.1:3000/websocket/$&#123;store.state.user.token&#125;`;</span><br><span class="line">        let socket = null;</span><br><span class="line">        onMounted(() =&gt; &#123;</span><br><span class="line">            ....//省略</span><br><span class="line">            socket.onmessage = msg =&gt; &#123;</span><br><span class="line">                const data = JSON.parse(msg.data);</span><br><span class="line">                console.log(data);</span><br><span class="line">                if (data.event === &quot;start-matching&quot;) &#123;</span><br><span class="line">                    store.commit(&quot;updateOpponent&quot;, &#123;</span><br><span class="line">                        username: data.opponent_username,</span><br><span class="line">                        photo: data.opponent_photo</span><br><span class="line">                    &#125;);</span><br><span class="line">                    //匹配成功后，延时2秒，进入对战页面</span><br><span class="line">                    setTimeout(() =&gt; &#123;</span><br><span class="line">                        store.commit(&quot;updateStatus&quot;, &quot;playing&quot;)</span><br><span class="line">                    &#125;, 2000);</span><br><span class="line">                    store.commit(&quot;updateGame&quot;,data.game)//更新Game:包括玩家信息和地图</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            socket.onclose = () =&gt; &#123;</span><br><span class="line">                console.log(&quot;disconnected!&quot;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        onUnmounted(() =&gt; &#123;</span><br><span class="line">            socket.close();</span><br><span class="line">            store.commit(&quot;updateStatus&quot;, &quot;matching&quot;);</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>运行项目，使用用户名sun和用户名hong的登录，两个浏览器控制台<code>console.log(data.game)</code>的输出内容一致，均为，同步成功</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220817184701914.png" alt="image-20220817184701914"></p>
<h2 id="游戏同步：多线程"><a href="#游戏同步：多线程" class="headerlink" title="游戏同步：多线程"></a>游戏同步：多线程</h2><h3 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h3><p>之前只是两个棋盘，在浏览器本地通过wsad和上下左右来控制移动。</p>
<p>现在三个棋盘，两个client和一个server，需要实现三个棋盘的同步</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818094655746.png" alt="image-20220818094655746"></p>
<p>再来梳理一下之前的游戏流程</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818095616805.png" alt="image-20220818095616805"></p>
<p>对于从等待用户orBot输入到判别系统这一过程是独立的，</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818095749236.png" alt="image-20220818095749236"></p>
<p>但是一般代码的执行是单线程，也就是按照顺序执行，例如如果在当前线程执行操作，当等待用户输入的时候，线程就会卡死，需要我们这样一个线程中有多个游戏在运行，只有Game1结束之后才能跑Game2，这样在第二个对局中，玩家就会漫长的等待。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818100333814.png" alt="image-20220818100333814"></p>
<p>因此，Game不能作为一个单线程来处理，因此，需要另起一个新的线程来做。</p>
<p>也就是将Game变成一个支持多线程的类</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818100750453.png" alt="image-20220818100750453"></p>
<h3 id="多线程"><a href="#多线程" class="headerlink" title="多线程"></a>多线程</h3><p>首先为<code>WebSocketServer</code>增加一个成员变量，用于记录链接中的Game实例</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818101937329.png" alt="image-20220818101937329"></p>
<p>在确定两名匹配的玩家之后，更新两名玩家的<code>WebSocketServer</code>连接上的<code>Game</code>实例值。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818102328316.png" alt="image-20220818102328316"></p>
<p>然后回到<code>Game.java</code>，将<code>Game</code>变成一个支持多线程的类，只需将<code>Game</code>继承<code>Thread</code>类，就可以支持多线程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Game</span> <span class="keyword">extends</span> <span class="title class_">Thread</span></span><br></pre></td></tr></table></figure>

<p>然后重写多线程的入口函数<code>run()</code></p>
<p>在开启一个新线程执行<code>game.start()</code>的时候，新线程中的入口函数，就是<code>run()</code></p>
<p>初始化两个成员变量，用于表示两名玩家的下一步操作</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Integer nextStepA;</span><br><span class="line"><span class="keyword">private</span> Integer nextStepB;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNextStepA</span><span class="params">(Integer nextStepA)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.nextStepA = nextStepA;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNextStepB</span><span class="params">(Integer nextStepB)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.nextStepB = nextStepB;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>未来会在<code>WebSocketServer.java</code>中，接收到输入的时候，调用这两个函数</p>
<p>也就是在蓝色的线程里面修改<code>nextStepA</code>和<code>nextStepB</code>的值，而在红色的线程里面，会读取这两个线程的值</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818103052021.png" alt="image-20220818103052021"></p>
<p>这就涉及到两个线程会同时读写一个变量，可能会产生读写冲突，需要枷锁</p>
<p>定义一个锁</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">ReentrantLock</span> <span class="variable">lock</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReentrantLock</span>();</span><br></pre></td></tr></table></figure>

<p>之后在<code>setNextStepA</code>和<code>setNextStepB</code>中</p>
<p>对两个变量进行更新之前，先锁上，操作完之后，解锁（不管有没有报异常）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNextStepA</span><span class="params">(Integer nextStepA)</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.nextStepA = nextStepA;</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNextStepB</span><span class="params">(Integer nextStepB)</span> &#123;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.nextStepB = nextStepB;</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>nextStep()</code>函数中，负责等待两名玩家的输入，如果都在指定时间内输入了，就返回<code>true</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">nextStep</span><span class="params">()</span>&#123;<span class="comment">//等待两名玩家的下一步操作</span></span><br><span class="line">    <span class="comment">//由于前端动画200ms才能画一个格子</span></span><br><span class="line">    <span class="comment">//如果在此期间接收到的输入多于一步 只会留最后一步 多余的会被覆盖</span></span><br><span class="line">    <span class="comment">//因此在每一个下一步都要先休息200ms</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(<span class="number">200</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果5秒内有玩家没有输入 就返回false</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span>(nextStepA != <span class="literal">null</span> &amp;&amp; nextStepB != <span class="literal">null</span>)&#123;</span><br><span class="line">                    playerA.getSteps().add(nextStepA);</span><br><span class="line">                    playerB.getSteps().add(nextStepB);</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果其中一个超时没有输入，游戏就终止，并且分出胜负。</p>
<p>因此还需要定义一个游戏状态<code>status</code>和谁输了<code>loser</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">status</span> <span class="operator">=</span> <span class="string">&quot;playing&quot;</span>;<span class="comment">//游戏状态 playing--&gt;finished</span></span><br><span class="line"><span class="keyword">private</span> <span class="type">String</span> <span class="variable">loser</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;<span class="comment">//all:平; A:A输; B:B输了</span></span><br></pre></td></tr></table></figure>

<p>最后，在线程的入口<code>run()</code>中初始逻辑如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;<span class="comment">//1000步之内游戏肯定结束</span></span><br><span class="line">        <span class="keyword">if</span>(nextStep())&#123;</span><br><span class="line">            <span class="comment">//如果获取两个玩家的下一步操作</span></span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            status = <span class="string">&quot;finished&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span>(nextStepA == <span class="literal">null</span> &amp;&amp; nextStepB == <span class="literal">null</span>)&#123;</span><br><span class="line">                loser = <span class="string">&quot;all&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nextStepA == <span class="literal">null</span>) &#123;</span><br><span class="line">                loser = <span class="string">&quot;A&quot;</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                loser = <span class="string">&quot;B&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但是上面这段逻辑有个问题，如果两名玩家在五秒内没有给出操作，就会进入<code>else</code>判断，此时本应该是平均，也就是<code>loser = &quot;all&quot;</code>，但如果下面这段代码执行时，用户给出了输入，结果就会不符合预期。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(nextStepA == <span class="literal">null</span> &amp;&amp; nextStepB == <span class="literal">null</span>)&#123;</span><br><span class="line">       loser = <span class="string">&quot;all&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (nextStepA == <span class="literal">null</span>) &#123;</span><br><span class="line">       loser = <span class="string">&quot;A&quot;</span>;</span><br><span class="line">&#125; <span class="keyword">else</span>&#123;</span><br><span class="line">       loser = <span class="string">&quot;B&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以，由于这里涉及到变量的读操作，为了在读的过程中被修改，因此也需要加锁。读完之后再解锁。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(nextStep())&#123;</span><br><span class="line">    <span class="comment">//如果获取两个玩家的下一步操作</span></span><br><span class="line">    System.out.println();</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    status = <span class="string">&quot;finished&quot;</span>;</span><br><span class="line">    lock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(nextStepA == <span class="literal">null</span> &amp;&amp; nextStepB == <span class="literal">null</span>)&#123;</span><br><span class="line">            loser = <span class="string">&quot;all&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nextStepA == <span class="literal">null</span>) &#123;</span><br><span class="line">            loser = <span class="string">&quot;A&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">            loser = <span class="string">&quot;B&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.lock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>然后来看<code>if (nextStep())</code>判断，如果获取两个玩家的下一步操作</p>
<p>需要先进行<code>judge()</code>，来判断输入是否合法</p>
<p>并且，虽然A和B都知道自己的操作，但是看不到对方的操作，因此需要中心服务器以广播的形式来告知。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818174229481.png" alt="image-20220818174229481"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++) &#123;<span class="comment">//1000步之内游戏肯定结束</span></span><br><span class="line">        <span class="keyword">if</span> (nextStep()) &#123;</span><br><span class="line">            <span class="comment">//如果获取两个玩家的下一步操作</span></span><br><span class="line">            judge();</span><br><span class="line">            <span class="keyword">if</span>(status.equals(<span class="string">&quot;playing&quot;</span>))&#123;</span><br><span class="line">                sentMove();</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                sentResult();</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            status = <span class="string">&quot;finished&quot;</span>;</span><br><span class="line">            lock.lock();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (nextStepA == <span class="literal">null</span> &amp;&amp; nextStepB == <span class="literal">null</span>) &#123;</span><br><span class="line">                    loser = <span class="string">&quot;all&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nextStepA == <span class="literal">null</span>) &#123;</span><br><span class="line">                    loser = <span class="string">&quot;A&quot;</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    loser = <span class="string">&quot;B&quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.lock();</span><br><span class="line">            &#125;</span><br><span class="line">            sentResult();</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而其中暂时不实现<code>judge</code>的逻辑，其他辅助函数的逻辑如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sentAllmessage</span><span class="params">(String message)</span>&#123;<span class="comment">//工具函数:向两名玩家广播信息</span></span><br><span class="line">    WebSocketServer.userConnectionInfo.get(playerA.getId()).sendMessage(message);</span><br><span class="line">    WebSocketServer.userConnectionInfo.get(playerB.getId()).sendMessage(message);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sentMove</span><span class="params">()</span> &#123;<span class="comment">//向两个Client广播玩家操作信息</span></span><br><span class="line">    lock.lock();<span class="comment">//凡是对操作进行读写的操作 都要加锁</span></span><br><span class="line">    <span class="keyword">try</span>&#123;</span><br><span class="line">        <span class="type">JSONObject</span> <span class="variable">resp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">        resp.put(<span class="string">&quot;event&quot;</span>,<span class="string">&quot;move&quot;</span>);</span><br><span class="line">        resp.put(<span class="string">&quot;a_direction&quot;</span>,nextStepA);</span><br><span class="line">        resp.put(<span class="string">&quot;b_direction&quot;</span>,nextStepB);</span><br><span class="line">        nextStepA = nextStepB = <span class="literal">null</span>;<span class="comment">//清空操作</span></span><br><span class="line">        sentAllmessage(resp.toJSONString());</span><br><span class="line">    &#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">        lock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">sentResult</span><span class="params">()</span> &#123;<span class="comment">//向两个client公布结果信息</span></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">resp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    resp.put(<span class="string">&quot;event&quot;</span>,<span class="string">&quot;result&quot;</span>);<span class="comment">//定义事件</span></span><br><span class="line">    resp.put(<span class="string">&quot;loser&quot;</span>,loser);</span><br><span class="line">    sentAllmessage(resp.toJSONString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样后端基本逻辑完成，接下来是前端与后端的通信，前端要将用户的操作发送过来，以及接收并处理中心服务器的广播</p>
<h3 id="前后端通信"><a href="#前后端通信" class="headerlink" title="前后端通信"></a>前后端通信</h3><p>此前判断蛇的移动，在<code>scripts\GameMap.js</code></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">add_listening_events</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="title function_">focus</span>();<span class="comment">//聚焦</span></span><br><span class="line">       <span class="keyword">const</span> [snake0, snake1] = <span class="variable language_">this</span>.<span class="property">snakes</span>;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;keydown&quot;</span>,<span class="function"><span class="params">e</span>=&gt;</span>&#123;</span><br><span class="line">           <span class="variable language_">console</span>.<span class="title function_">log</span>(e.<span class="property">key</span>);</span><br><span class="line">           <span class="comment">//wasd控制左下角球 上下左右控制右上角球</span></span><br><span class="line">           <span class="keyword">if</span>(e.<span class="property">key</span> === <span class="string">&#x27;w&#x27;</span>) snake0.<span class="title function_">set_direction</span>(<span class="number">0</span>);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;d&#x27;</span>) snake0.<span class="title function_">set_direction</span>(<span class="number">1</span>);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;s&#x27;</span>) snake0.<span class="title function_">set_direction</span>(<span class="number">2</span>);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;a&#x27;</span>) snake0.<span class="title function_">set_direction</span>(<span class="number">3</span>);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;ArrowUp&#x27;</span>) snake1.<span class="title function_">set_direction</span>(<span class="number">0</span>);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;ArrowRight&#x27;</span>) snake1.<span class="title function_">set_direction</span>(<span class="number">1</span>);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;ArrowDown&#x27;</span>) snake1.<span class="title function_">set_direction</span>(<span class="number">2</span>);</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;ArrowLeft&#x27;</span>) snake1.<span class="title function_">set_direction</span>(<span class="number">3</span>);</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这里，由于一个client负责一个玩家，只处理wsad即可。</p>
<p>修改如下，将玩家的操作操作传送到后端</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">add_listening_events</span>(<span class="params"></span>)&#123;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="title function_">focus</span>();<span class="comment">//聚焦</span></span><br><span class="line">       <span class="keyword">const</span> [snake0, snake1] = <span class="variable language_">this</span>.<span class="property">snakes</span>;</span><br><span class="line">       <span class="variable language_">this</span>.<span class="property">ctx</span>.<span class="property">canvas</span>.<span class="title function_">addEventListener</span>(<span class="string">&quot;keydown&quot;</span>,<span class="function"><span class="params">e</span>=&gt;</span>&#123;</span><br><span class="line">           <span class="variable language_">console</span>.<span class="title function_">log</span>(e.<span class="property">key</span>);</span><br><span class="line">           <span class="comment">//wasd控制移动</span></span><br><span class="line">           <span class="keyword">let</span> d = -<span class="number">1</span>;</span><br><span class="line">           <span class="keyword">if</span>(e.<span class="property">key</span> === <span class="string">&#x27;w&#x27;</span>) d = <span class="number">0</span>;</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;d&#x27;</span>) d = <span class="number">1</span>;</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;s&#x27;</span>) d = <span class="number">2</span>;</span><br><span class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (e.<span class="property">key</span> === <span class="string">&#x27;a&#x27;</span>) d = <span class="number">3</span>;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span>(d &gt;= <span class="number">0</span>)&#123;<span class="comment">//有效输入</span></span><br><span class="line">               <span class="variable language_">this</span>.<span class="property">store</span>.<span class="property">state</span>.<span class="property">pk</span>.<span class="property">socket</span>.<span class="title function_">sent</span>(<span class="title class_">JSON</span>.<span class="title function_">stringify</span>(&#123;<span class="comment">//将JSON转换为字符串</span></span><br><span class="line">                   <span class="attr">event</span>:<span class="string">&quot;move&quot;</span>,</span><br><span class="line">                   <span class="attr">direction</span>:d,</span><br><span class="line">               &#125;))</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>后端接收并分配给专门的路由来进行处理</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">move</span><span class="params">(Integer direction)</span> &#123;</span><br><span class="line">    <span class="comment">//判断是A玩家还是B玩家在操作</span></span><br><span class="line">    <span class="keyword">if</span>(game.getPlayerA().getId().equals(user.getId()))&#123;</span><br><span class="line">        game.setNextStepA(direction);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span> (game.getPlayerB().getId().equals(user.getId())) &#123;</span><br><span class="line">        game.setNextStepB(direction);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">Exception</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Exception</span>(<span class="string">&quot;Error&quot;</span>);</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@OnMessage</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMessage</span><span class="params">(String message, Session session)</span> &#123;<span class="comment">//当做路由 分配任务</span></span><br><span class="line">    <span class="comment">// Server从Client接收消息时触发</span></span><br><span class="line">    System.out.println(<span class="string">&quot;Receive message!&quot;</span>);</span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">data</span> <span class="operator">=</span> JSONObject.parseObject(message);<span class="comment">//将字符串解析成JSON</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">event</span> <span class="operator">=</span> data.getString(<span class="string">&quot;event&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(<span class="string">&quot;start-matching&quot;</span>.equals(event))&#123;<span class="comment">//防止event为空的异常</span></span><br><span class="line">        startMatching();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;stop-matching&quot;</span>.equals(event)) &#123;</span><br><span class="line">        stopMatching();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;move&quot;</span>.equals(event)) &#123;</span><br><span class="line">       	<span class="type">Integer</span> <span class="variable">direction</span> <span class="operator">=</span> data.getInteger(<span class="string">&quot;direction&quot;</span>);</span><br><span class="line">        System.out.println(direction);</span><br><span class="line">        move(direction);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时，client端用户输入WSAD的时候，后端就能准确接收到信息。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818183500945.png" alt="image-20220818183500945"></p>
<p>同时，前端也要接收后端的广播来的信息，具体有两种<code>event</code>，分别是<code>move</code>和<code>result</code></p>
<h3 id="1-event-move"><a href="#1-event-move" class="headerlink" title="1) event &#x3D;&#x3D; move"></a>1) event &#x3D;&#x3D; move</h3><p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818191839958.png" alt="image-20220818191839958"></p>
<p>对操作进行更新需要用到<code>Snack.js</code>中的<code>set_direction</code>方法</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818192126187.png" alt="image-20220818192126187"></p>
<p>两个玩家控制的<code>snack</code>对象在保存在<code>GameMap</code>对象中。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818192357488.png" alt="image-20220818192357488"></p>
<p>为了取到，需要将<code>GameMap</code>对象，作为游戏对象，保存为全局变量</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818191356614.png" alt="image-20220818191356614"></p>
<p>先在<code>src\store\pk.js</code>中将<code>gameObject</code>存入全局变量，并写好更新函数</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818191647251.png" alt="image-20220818191647251"></p>
<p>这样就能获取到游戏对象，并且更新两个玩家控制的<code>snack</code>的方向</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818195452452.png" alt="image-20220818195452452"></p>
<p>此时，两个玩家都能够控制蛇正常移动</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818200929557.png" alt="image-20220818200929557"></p>
<p>但是每次输入之后都会感觉到一些延迟，是因为输入之后可能线程还处于睡眠状态</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818200727010.png" alt="image-20220818200727010"></p>
<p>调整为：</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220818200738389.png" alt="image-20220818200738389"></p>
<h3 id="2-event-result"><a href="#2-event-result" class="headerlink" title="2) event &#x3D;&#x3D; result"></a>2) event &#x3D;&#x3D; result</h3><p>之前判断玩家输赢（蛇的状态）的逻辑在前端</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果下一步操作撞了 蛇瞬间去世</span></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable language_">this</span>.<span class="property">gamemap</span>.<span class="title function_">check_valid</span>(<span class="variable language_">this</span>.<span class="property">next_cell</span>))&#123;</span><br><span class="line"><span class="variable language_">this</span>.<span class="property">status</span> = <span class="string">&quot;die&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819103307108.png" alt="image-20220819103307108"></p>
<p>将这段代码去掉。现在要交由后端来播报结果。</p>
<p>判断输赢有两部分逻辑：撞墙和超时，超时的逻辑已经写好，现在写判断撞墙的逻辑</p>
<p>参考前端<code>GameMap.js</code>中的<code>check_valid(cell)</code>函数</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819104425612.png" alt="image-20220819104425612"></p>
<p>后端逻辑如下：</p>
<p>1）首先需要将两名玩家所控制的蛇取到：</p>
<p>新建<code>Cell</code>类代表蛇的单元</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Cell</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer x;</span><br><span class="line">    <span class="keyword">private</span> Integer y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>Player.java</code>中，将蛇的身体返回</p>
<p>0、1、2、3位置表示表示上右下左</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819105814184.png" alt="image-20220819105814184"></p>
<p>对于四种操作<code>0(w), 1(d), 2(s), 3(a)</code>分别在行和列方向上的偏移量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span>[] dx = &#123;-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>&#125;;<span class="comment">//行方向的偏移量</span></span><br><span class="line"><span class="type">int</span>[] dy = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>&#125;; <span class="comment">//列方向的偏移量</span></span><br></pre></td></tr></table></figure>

<p>所以<code>Player.java</code>的逻辑更新为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Player</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> Integer sx;<span class="comment">//起始x坐标</span></span><br><span class="line">    <span class="keyword">private</span> Integer sy;<span class="comment">//起始y坐标</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; steps;<span class="comment">//保存每一步操作---决定了蛇当前的形状</span></span><br><span class="line">    <span class="comment">//检验当前回合 蛇的长度是否增加</span></span><br><span class="line">    <span class="keyword">private</span>  <span class="type">boolean</span> <span class="title function_">check_tail_increasing</span><span class="params">(<span class="type">int</span> step)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(step &lt;= <span class="number">10</span>) <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">return</span> step % <span class="number">3</span> == <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//返回蛇的身体</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Cell&gt; <span class="title function_">getCells</span><span class="params">()</span>&#123;</span><br><span class="line">        List&lt;Cell&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="comment">//对于四种操作0(w), 1(d), 2(s), 3(a)</span></span><br><span class="line">        <span class="comment">// 在行和列方向上的计算偏移量</span></span><br><span class="line">        <span class="type">int</span>[] dx = &#123;-<span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>&#125;;</span><br><span class="line">        <span class="type">int</span>[] dy = &#123;<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, -<span class="number">1</span>&#125;;</span><br><span class="line">        <span class="type">int</span> <span class="variable">x</span> <span class="operator">=</span> sx;</span><br><span class="line">        <span class="type">int</span> <span class="variable">y</span> <span class="operator">=</span> sy;</span><br><span class="line">        <span class="type">int</span> <span class="variable">step</span> <span class="operator">=</span> <span class="number">0</span>;<span class="comment">//回合数</span></span><br><span class="line">        res.add(<span class="keyword">new</span> <span class="title class_">Cell</span>(x,y));<span class="comment">//添加起点</span></span><br><span class="line">        <span class="comment">//不断根据steps计算出整个蛇身体</span></span><br><span class="line">        <span class="keyword">for</span> (Integer d : steps) &#123;</span><br><span class="line">            x += dx[d];</span><br><span class="line">            y += dy[d];</span><br><span class="line">            res.add(<span class="keyword">new</span> <span class="title class_">Cell</span>(x,y));</span><br><span class="line">            <span class="keyword">if</span>(!check_tail_increasing(++step))&#123;</span><br><span class="line">                <span class="comment">//如果蛇尾不增加 就删掉蛇尾</span></span><br><span class="line">                res.remove(<span class="number">0</span>);<span class="comment">//O(N)</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）判断两名玩家最后一步操作是否合法</p>
<ul>
<li>没有撞到障碍物</li>
<li>没有撞到两条蛇的身体<ul>
<li>没有撞到自己：最后一步与之前n-1个Cell是否重合</li>
<li>没有撞到别人：最后一步与之前n-1个Cell是否重合<ul>
<li>由于A和B不可能走到同一个格子 因此不用判断最后一个格子是否重合</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>只需要判断最后一步，也就是蛇的最后一个Cell是否符合上面三种原则即可。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">boolean</span> <span class="title function_">check_valid</span><span class="params">(List&lt;Cell&gt; cellsA, List&lt;Cell&gt; cellsB)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">n</span> <span class="operator">=</span> cellsA.size();</span><br><span class="line">    <span class="type">Cell</span> <span class="variable">cell</span> <span class="operator">=</span> cellsA.get(n - <span class="number">1</span>);<span class="comment">//取到A的最后一步</span></span><br><span class="line">    <span class="comment">//三种不合法操作: A撞墙、A撞A、A撞B</span></span><br><span class="line">    <span class="comment">//A撞墙</span></span><br><span class="line">    <span class="keyword">if</span>(g[cell.getX()][cell.getY()] == <span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="comment">//A撞A</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n - <span class="number">1</span>; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(cellsA.get(i).getX().equals(cell.getX())</span><br><span class="line">                &amp;&amp; cellsA.get(i).getY().equals(cell.getY()))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//A撞B</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; n - <span class="number">1</span>; i++) &#123; </span><br><span class="line">        <span class="keyword">if</span>(cellsB.get(i).getX().equals(cell.getX())</span><br><span class="line">                &amp;&amp; cellsB.get(i).getY().equals((cell.getY())))&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">judge</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Cell&gt; cellsA = playerA.getCells();</span><br><span class="line">    List&lt;Cell&gt; cellsB = playerB.getCells();</span><br><span class="line">    <span class="comment">//判断两名玩家最后一步操作是否合法</span></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">validA</span> <span class="operator">=</span> check_valid(cellsA, cellsB);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">validB</span> <span class="operator">=</span> check_valid(cellsB, cellsA);</span><br><span class="line">    <span class="keyword">if</span>(!validA || !validB)&#123;</span><br><span class="line">        status = <span class="string">&quot;finished&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(validA)&#123;</span><br><span class="line">            loser = <span class="string">&quot;B&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (validB) &#123;</span><br><span class="line">            loser = <span class="string">&quot;A&quot;</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            loser = <span class="string">&quot;all&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时就能正常的进行合法性判断。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819141014616.png" alt="image-20220819141014616"></p>
<h3 id="游戏结果展示"><a href="#游戏结果展示" class="headerlink" title="游戏结果展示"></a>游戏结果展示</h3><p>最后，还需要将游戏的结果在前端展示，并且，设置一个重启按钮，点击重启之后，重新开始一局。</p>
<p>在<code>pk.js</code>中新增变量，方便用于展示谁赢谁输</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819150811233.png" alt="image-20220819150811233"></p>
<p>新增一个组件<code>ResultBoard.vue</code>用于展示结果</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819150653501.png" alt="image-20220819150653501"></p>
<p>核心代码如下：</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819152032707.png" alt="image-20220819152032707"></p>
<p>然后在对战页面<code>PkIndexView.vue</code>导入组件，使其在<code>loser!=none</code>时展示出来</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819151024672.png" alt="image-20220819151024672"></p>
<p>并且在收到后端播报结果时，更新全局变量中的loser</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819151121848.png" alt="image-20220819151121848"></p>
<p>最终的结果如下，成功的实现了结果展示和重来一局。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819150244338.png" alt="image-20220819150244338"></p>
<p>点击重启</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819151913696.png" alt="image-20220819151913696"></p>
<p>此时，再匹配的用户，又可以开始新的一轮对战。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819150538480.png" alt="image-20220819150538480"></p>
<p>这样，游戏同步功能就全部完成。</p>
<h2 id="对局记录"><a href="#对局记录" class="headerlink" title="对局记录"></a>对局记录</h2><p>接下来来实现另外一功能，就是将对局记录保存在数据库中。</p>
<h3 id="创建record"><a href="#创建record" class="headerlink" title="创建record"></a>创建record</h3><p>1）创建<code>record</code>表用来记录每局对战的信息</p>
<p>表中的列：</p>
<ul>
<li><code>id: int</code><ul>
<li>非空 自增 唯一 主键</li>
</ul>
</li>
<li><code>a_id: int</code></li>
<li><code>a_sx: int</code></li>
<li><code>a_sy: int</code></li>
<li><code>b_id: int</code></li>
<li><code>b_sx: int</code></li>
<li><code>b_sy: int</code></li>
<li><code>a_steps: varchar(1000)</code></li>
<li><code>b_steps: varchar(1000)</code></li>
<li><code>map: varchar(1000)</code></li>
<li><code>loser: varchar(10)</code></li>
<li><code>createtime: datetime</code></li>
</ul>
<p>2）创建Pojo</p>
<p>注意，数据库中如果用下划线，则在pojo中要使用驼峰命名法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Record</span> &#123;</span><br><span class="line">    <span class="meta">@TableId(type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> Integer aId;</span><br><span class="line">    <span class="keyword">private</span> Integer aSx;</span><br><span class="line">    <span class="keyword">private</span> Integer aSy;</span><br><span class="line">    <span class="keyword">private</span> Integer bId;</span><br><span class="line">    <span class="keyword">private</span> Integer bSx;</span><br><span class="line">    <span class="keyword">private</span> Integer bSy;</span><br><span class="line">    <span class="keyword">private</span> String aSteps;</span><br><span class="line">    <span class="keyword">private</span> String bSteps;</span><br><span class="line">    <span class="keyword">private</span> String map;</span><br><span class="line">    <span class="keyword">private</span> String loser;</span><br><span class="line">    <span class="meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;, timezone = &quot;Asia/Shanghai&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date createtime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3）创建Mapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RecordMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;Record&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="写入数据库"><a href="#写入数据库" class="headerlink" title="写入数据库"></a>写入数据库</h3><p>首先将<code>RecordMapper</code>实例注入到<code>WebSocketServer</code>中</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819153955853.png" alt="image-20220819153955853"></p>
<p>在<code>Game.java</code>中，在每次向<code>client</code>播报结果之前，将记录保存到数据库</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819161328576.png" alt="image-20220819161328576"></p>
<p>这样在每局游戏结束时，记录就被保存下来</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819161136837.png" alt="image-20220819161136837"></p>
<p>后续就可以根据记录来复原游戏画面</p>
<h2 id="实现匹配系统的微服务"><a href="#实现匹配系统的微服务" class="headerlink" title="实现匹配系统的微服务"></a>实现匹配系统的微服务</h2><p>微服务可以理解为在SpringBoot之外的另外一个Server，负责处理一段独立的功能，与SpringBoot Server之间通过http通信。在游戏的匹配系统，之前是简单粗暴的放在一个集合上，当集合元素大于2时，取出两名玩家进行匹配，无法适应更加复杂的场景，因此现在要将这段程序独立出来。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819163919485.png" alt="image-20220819163919485"></p>
<p>微服务有多种实现方式，这里采用SpringCloud。SpringCloud和SpringBoot都相当于一个Web Server两者之间通过Http通信</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819164220414.png" alt="image-20220819164220414"></p>
<p>由于SpringCloud实现的匹配系统和SpringBoot实现的游戏后端是并列的，因此项目结构需要改动。</p>
<h3 id="创建SpringCloud项目"><a href="#创建SpringCloud项目" class="headerlink" title="创建SpringCloud项目"></a>创建<code>SpringCloud</code>项目</h3><p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819164536854.png" alt="image-20220819164536854"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819164609646.png" alt="image-20220819164609646"></p>
<h3 id="配置SpringCloud项目"><a href="#配置SpringCloud项目" class="headerlink" title="配置SpringCloud项目"></a>配置<code>SpringCloud</code>项目</h3><p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819164950301.png" alt="image-20220819164950301"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819165048025.png" alt="image-20220819165048025"></p>
<p>在<code>SpringCloud</code>项目中添加依赖：<br><a target="_blank" rel="noopener" href="https://mvnrepository.com/">Maven仓库地址</a><br><code>spring-cloud-dependencies</code></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819165333956.png" alt="image-20220819165333956"></p>
<h3 id="添加子项目—MatchingSystem"><a href="#添加子项目—MatchingSystem" class="headerlink" title="添加子项目—MatchingSystem"></a>添加子项目—MatchingSystem</h3><h4 id="1）添加和配置"><a href="#1）添加和配置" class="headerlink" title="1）添加和配置"></a>1）添加和配置</h4><p>创建<code>SpringCloud</code>的子项目——<code>matchingsystem</code></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819165439541.png" alt="image-20220819165439541"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819165620115.png" alt="image-20220819165620115"></p>
<p>然后需要配置一些依赖。</p>
<p><code>matchingsystem</code>本质上也是一个<code>springboot</code>，所以需要将父级目录<code>backendcloud</code>中<code>porm.xml</code>中的依赖，<code>SpringWeb</code>依赖，直接复制到子项目<code>matchingsystem</code>对应的<code>porm.xml</code></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819170225988.png" alt="image-20220819170225988"></p>
<p>创建<code>application.properties</code>，配置端口，由于游戏后端<code>backend</code>中是3000，这里设置为3001</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819170743739.png" alt="image-20220819170743739"></p>
<h4 id="2）匹配系统的简单布局"><a href="#2）匹配系统的简单布局" class="headerlink" title="2）匹配系统的简单布局"></a>2）匹配系统的简单布局</h4><p>对于匹配系统而言，需要实现的接口中需要有两个函数，<code>addPlayer</code>和<code>removePlayer</code>用于添加和删除玩家</p>
<p>创建接口，就需要创建<code>controller</code>负责调用接口，<code>service</code>负责声明接口，<code>service.impl</code>负责实现接口</p>
<p>为了方便调试，暂时不实现具体功能。</p>
<p><code>MatchingService.java</code></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819174150845.png" alt="image-20220819174150845"></p>
<p><code>MatchingServiceImpl.java</code></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819230327095.png" alt="image-20220819230327095"></p>
<p><code>MatchingController.java</code></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819174309856.png" alt="image-20220819174309856"></p>
<p>注意，对于<code>MultiValueMap</code>结构而言，运行一个<code>key</code>对应的多个<code>value</code>，并用数组保存</p>
<p><code>map.getFirst(&quot;user_id&quot;)</code>表示<code>user_id</code>所对应的<code>value</code>数组中，第一个值001</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819173518541.png" alt="image-20220819173518541"></p>
<p>此时<code>MatchingController</code>还有一个问题是，没有授权验证，这样就有外网通过其他请求来恶意攻击的风险。</p>
<p>与之前<code>backend</code>一样，添加<code>Spring Security</code>依赖</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819174800486.png" alt="image-20220819174800486"></p>
<p>照着之前的代码，只用到<code>configure</code>这一段代码，且不涉及<code>Jwt-token</code>的验证，直接抄过来修改</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819175735806.png" alt="image-20220819175735806"></p>
<p>我们期望的的是只能被后端服务器访问，而不能以其他方式访问。解决这个问题，可以根据IP地址来判断，也就是只能通过本地，而不能通过其他地方来访问。</p>
<p>如下图，对<code>&quot;/player/add/&quot;</code>和<code>&quot;/player/remove/&quot;</code>的请求放开</p>
<p>只有IP地址为本地（127.0.0.1）的<code>Server</code>发出的请求才是有效的。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819194957707.png" alt="image-20220819194957707"></p>
<p>将原来的<code>Main</code>函数，重命名为<code>MatchingSystemApplication</code>，作为<code>Springboot</code>的入口</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819180722912.png" alt="image-20220819180722912"></p>
<p>这样就能够跑起来（只不过此时由于是POST的类型的请求，不支持通过浏览器直接请求）</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819195359065.png" alt="image-20220819195359065"></p>
<p>由于请求是游戏后端backend发起的，因此还需要将两部分对接起来。</p>
<p>现在需要创建一个新的子项目，将之前的逻辑装在backendclound下面</p>
<h3 id="添加子项目—Backend"><a href="#添加子项目—Backend" class="headerlink" title="添加子项目—Backend"></a>添加子项目—Backend</h3><h4 id="1）添加和配置-1"><a href="#1）添加和配置-1" class="headerlink" title="1）添加和配置"></a>1）添加和配置</h4><p>在<code>backendcloud</code>下面创建<code>SpringCloud</code>的子项目——<code>Backend</code></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819195926647.png" alt="image-20220819195926647"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819200206342.png" alt="image-20220819200206342"></p>
<p>然后，将之前的后端<code>backend</code>项目的<code>src</code>整个文件夹直接复制过来。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819200315514.png" alt="image-20220819200315514"></p>
<p>复制到<code>backendcloud</code>下面的子模块<code>backend</code>下面</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819200509777.png" alt="image-20220819200509777"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819200446980.png" alt="image-20220819200446980"></p>
<p>然后将后端<code>backend</code>项目下的<code>porm.xml</code>中的依赖也粘贴到下面这个位置</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819200735514.png" alt="image-20220819200735514"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819200848602.png" alt="image-20220819200848602"></p>
<p>其中的<code>thymeleaf</code>用不到，删除即可。</p>
<p>目前的项目结构如下：</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819205001379.png" alt="image-20220819205001379"></p>
<h4 id="2）连通匹配系统"><a href="#2）连通匹配系统" class="headerlink" title="2）连通匹配系统"></a>2）连通匹配系统</h4><p>首先要打通</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819204842500.png" alt="image-20220819204842500"></p>
<p>需要将下面这段修改，目前还只是简单粗暴的进行从集合中取出User</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819205339894.png" alt="image-20220819205339894"></p>
<p>修改如下：</p>
<p>将与<code>matchpool</code>相关的所有操作都删掉</p>
<p>然后在<code>startMatching()</code>调用时向<code>MatchingSystem</code>发请求，申请为玩家匹配对手，在<code>stopMatching()</code>和<code>onClose()</code> 调用时向<code>MatchingSystem</code>发请求，申请取消玩家的匹配，</p>
<h5 id="配置RestTemplate"><a href="#配置RestTemplate" class="headerlink" title="配置RestTemplate"></a>配置<code>RestTemplate</code></h5><p>向<code>MatchingSystem</code>发请求，需要借助<code>Springboot</code>中的一个工具<code>RestTemplate</code>，它可以在两个Spring进程之间进行通信。</p>
<p>先配置一下这个工具，如果希望在<code>WebSocketServer.java</code>中使用<code>RestTemplate</code>，就需要加<code>Bean</code>注解，这样才能够取出来。</p>
<p>可以理解为，需要用到某个工具的时候，就定义一个它的<code>Configuration</code>，加一个注解<code>Bean</code>，返回一个它的实例。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819211004216.png" alt="image-20220819211004216"></p>
<p>这样在未来使用的时候，就可以通过<code>@Autowired</code>将其注入</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819211333528.png" alt="image-20220819211333528"></p>
<p>原理是，如果加了<code>@Autowired</code>，就会看一下这个接口（或者Service）是否有一个唯一的注解为<code>Bean</code>的函数和它对应，如果有的话就调用这个函数，将返回值赋过来。</p>
<p>现在看下怎么用。</p>
<p>在具体用之前，需要修改下数据库。将<code>rating</code>字段，将<code>bot</code>表中，移动到<code>user</code>表中</p>
<p>同样，修改这两个表对应的pojo</p>
<p>并且在所用调用<code>User</code>和<code>Bot</code>构造函数的时候修改</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819215130236.png" alt="image-20220819215130236"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819215206709.png" alt="image-20220819215206709"></p>
<p>然后进入正题。</p>
<h5 id="使用RestTemplate"><a href="#使用RestTemplate" class="headerlink" title="使用RestTemplate"></a>使用<code>RestTemplate</code></h5><p>借助<code>RestTemplate</code>向<code>MatchingSystem</code>发请求</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819220345823.png" alt="image-20220819220345823"></p>
<p>启动Backend模块对应的Spring服务</p>
<p>此时能够在服务中看到，启动了两个<code>SpringBoot</code></p>
<p><code>Backend</code>对应的端口号为3000</p>
<p><code>MatchingSystem</code>对应的端口号为3001</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819224536454.png" alt="image-20220819224536454"></p>
<p>用户登录之后，进行匹配，在<code>MatchingSystem</code>对应的控制台下面<code>add player1 1500</code>表示匹配系统接收到了来自后端的玩家ID为6的匹配请求。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819230223396.png" alt="image-20220819230223396"></p>
<p>当点击取消时，同样成功接收到了请求</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819230259939.png" alt="image-20220819230259939"></p>
<p>控制台中看到的输出，是在匹配系统中实现的输出。</p>
<p>至此，游戏后端，向匹配系统发请求这一过程就完成。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819230935439.png" alt="image-20220819230935439"></p>
<p>接下来要实现匹配系统内部的逻辑。</p>
<h3 id="匹配系统"><a href="#匹配系统" class="headerlink" title="匹配系统"></a>匹配系统</h3><p>匹配系统在接收到来自游戏后端的匹配请求之后，会将当前参与匹配的所有用户，放在一个池子（数组）里面。开辟额外新线程，每隔1s就扫描一遍整个数组，将能够匹配的玩家匹配到一起。我们期望匹配相近分值的玩家，随着时间的推移，可以逐步放宽分值要求，也就是允许两名匹配玩家的分值差距较大，直到所有玩家都可以在规定时间内匹配在一块为止。具体来说，第一秒，匹配分值差距10以内的玩家，第二秒，匹配分值差距20以内的玩家…..直到匹配完成为止。</p>
<p>现在需要将之前关于线程的那部分再重复一遍。</p>
<p>创建<code>service.impl.utils.MatchingPool</code>用于维护这样一个线程，同时创建<code>service.impl.utils.Player</code>来存储玩家（需要提前将<code>Lombok</code>依赖添加到匹配系统的<code>porm.xml</code>中）</p>
<p> <img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819232357797.png" alt="image-20220819232357797"></p>
<p>对于<code>Player</code>类，需要考虑三个属性：用户名，积分值，等待时间</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220819233045648.png" alt="image-20220819233045648"></p>
<h4 id="MatchingPool线程"><a href="#MatchingPool线程" class="headerlink" title="MatchingPool线程"></a>MatchingPool线程</h4><p>对于<code>MatchingPool</code>，是一个多线程的类，需要继承<code>Thread</code></p>
<ul>
<li>创建一个列表<code>players</code>保存玩家</li>
<li>添加玩家的函数</li>
<li>删除玩家的函数</li>
</ul>
<p>由于<code>players</code>变量多个线程（匹配线程，传入参数线程）共用，因此这个变量涉及到读写冲突，因此就需要加锁。还要注意，从列表中删除元素的时候，要注意重新判断该位置。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824124004462.png" alt="image-20220824124004462"></p>
<p>对于匹配系统而言，由于全局只有一个匹配线程，因此将其定义成静态变量，放在<code>MatchingServiceImpl</code>中。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824123924024.png" alt="image-20220824123924024"></p>
<p>同时在<code>MatchingPool</code>开一个线程，需要重写<code>Thread</code>的<code>run()</code>。对于线程的执行，我们期望周期性的执行，判断当前所有玩家中有没有匹配的。写一个死循环，<code>Thread.sleep(1000)</code>，每1秒中自动执行一遍。对于每一名玩家而言，每等待一秒，对应的<code>waitingTime</code>就会加一，相应的匹配阈值就会变大。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824151459662.png" alt="image-20220824151459662"></p>
<p>在<code>matchPlayers()</code>中，尝试匹配所有玩家</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824164853700.png" alt="image-20220824164853700"></p>
<blockquote>
<p>注意，java中的break：跳出当前循环；但是如果是嵌套循环，则只能跳出当前的这一层循环，只有逐层break才能跳出所有循环。continue：终止当前循环，但是不跳出循环(在循环中continue后面的语句是不会执行了)，继续往下根据循环条件执行循环。</p>
</blockquote>
<p>以上用到的辅助函数</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824151636514.png" alt="image-20220824151636514"></p>
<h4 id="MatchingSystem发送请求"><a href="#MatchingSystem发送请求" class="headerlink" title="MatchingSystem发送请求"></a><code>MatchingSystem</code>发送请求</h4><p>对于<code>sendResult</code>，负责将匹配的两名玩家作为参数返回到backend</p>
<p>也就是这个过程</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824154705730.png" alt="image-20220824154705730"></p>
<p>因为也要用到<code>RestTemplateConfig</code></p>
<p>所以将<code>backend.config.RestTemplateConfig</code>文件复制到<code>matchingsystem.config.RestTemplateConfig</code></p>
<p>为了能让<code>RestTemplateConfig</code>中的<code>Bean</code>注入进来，添加<code>@Component</code></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824155458434.png" alt="image-20220824155458434"></p>
<p>注入之后，就可以使用<code>RestTemplateConfig</code>来进行<code>SpringBoot</code>服务之间的通信</p>
<p>注意要加端口号</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824172041862.png" alt="image-20220824172041862"></p>
<h4 id="Backend接收请求"><a href="#Backend接收请求" class="headerlink" title="Backend接收请求"></a><code>Backend</code>接收请求</h4><p>为了能将匹配的a和b作为参数返回到<code>backend</code>，我们需要在<code>backend</code>写一个接收信息的方法</p>
<p>对于这样的一个方法而言，同样的一个流程</p>
<ul>
<li><code>service</code></li>
<li><code>service.impl</code></li>
<li><code>controller</code></li>
</ul>
<p>变动的文件如下，除了<code>SecurityConfig</code>，其他的均为新增文件</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824160431231.png" alt="image-20220824160431231"></p>
<p><code>StartGameService.java</code></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824153546232.png" alt="image-20220824153546232"></p>
<p><code>StartGameServiceImpl.java</code></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824153621228.png" alt="image-20220824153621228"></p>
<p>其中的<code>WebSocketServer.startGame(aId, bId)</code></p>
<p>内容为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">startGame</span><span class="params">(Integer aId, Integer bId)</span>&#123;</span><br><span class="line">    <span class="type">User</span> <span class="variable">userA</span> <span class="operator">=</span> userMapper.selectById(aId);</span><br><span class="line">    <span class="type">User</span> <span class="variable">userB</span> <span class="operator">=</span> userMapper.selectById(bId);</span><br><span class="line">    <span class="type">Game</span> <span class="variable">game</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Game</span>(<span class="number">13</span>,<span class="number">14</span>,<span class="number">20</span>, userA.getId(), userB.getId());</span><br><span class="line">    game.createMap();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//game是属于A和B两个玩家 因此需要赋值给A和B两名玩家对应的连接上</span></span><br><span class="line">    userConnectionInfo.get(userA.getId()).game = game;</span><br><span class="line">    userConnectionInfo.get(userB.getId()).game = game;</span><br><span class="line"></span><br><span class="line">    game.start();<span class="comment">//开辟一个新的线程</span></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">respGame</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    respGame.put(<span class="string">&quot;a_id&quot;</span>,game.getPlayerA().getId());</span><br><span class="line">    respGame.put(<span class="string">&quot;a_sx&quot;</span>,game.getPlayerA().getSx());</span><br><span class="line">    respGame.put(<span class="string">&quot;a_sy&quot;</span>,game.getPlayerA().getSy());</span><br><span class="line">    respGame.put(<span class="string">&quot;b_id&quot;</span>,game.getPlayerB().getId());</span><br><span class="line">    respGame.put(<span class="string">&quot;b_sx&quot;</span>,game.getPlayerB().getSx());</span><br><span class="line">    respGame.put(<span class="string">&quot;b_sy&quot;</span>,game.getPlayerB().getSy());</span><br><span class="line">    respGame.put(<span class="string">&quot;map&quot;</span>,game.getG());<span class="comment">//两名玩家的地图一致</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//分别给userA和userB传送消息告诉他们匹配成功了</span></span><br><span class="line">    <span class="comment">//通过userA的连接向userA发消息</span></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">respA</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    respA.put(<span class="string">&quot;event&quot;</span>,<span class="string">&quot;start-matching&quot;</span>);</span><br><span class="line">    respA.put(<span class="string">&quot;opponent_username&quot;</span>,userB.getUsername());</span><br><span class="line">    respA.put(<span class="string">&quot;opponent_photo&quot;</span>,userB.getPhoto());</span><br><span class="line">    respA.put(<span class="string">&quot;game&quot;</span>,respGame);</span><br><span class="line">    <span class="type">WebSocketServer</span> <span class="variable">webSocketServer1</span> <span class="operator">=</span> userConnectionInfo.get(userA.getId());<span class="comment">//获取user1的连接</span></span><br><span class="line">    webSocketServer1.sendMessage(respA.toJSONString());</span><br><span class="line"></span><br><span class="line">    <span class="comment">//通过userB的连接向userB发消息</span></span><br><span class="line">    <span class="type">JSONObject</span> <span class="variable">respB</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">JSONObject</span>();</span><br><span class="line">    respB.put(<span class="string">&quot;event&quot;</span>,<span class="string">&quot;start-matching&quot;</span>);</span><br><span class="line">    respB.put(<span class="string">&quot;opponent_username&quot;</span>,userA.getUsername());</span><br><span class="line">    respB.put(<span class="string">&quot;opponent_photo&quot;</span>,userA.getPhoto());</span><br><span class="line">    respB.put(<span class="string">&quot;game&quot;</span>,respGame);</span><br><span class="line">    <span class="type">WebSocketServer</span> <span class="variable">webSocketServer2</span> <span class="operator">=</span> userConnectionInfo.get(userB.getId());</span><br><span class="line">    webSocketServer2.sendMessage(respB.toJSONString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>StartGameController.java</code></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824153753802.png" alt="image-20220824153753802"></p>
<p><code>SecurityConfig.java</code>，对于<code>&quot;/pk/start/game/&quot;</code>这样一个URL，只允许本地调用。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824153836952.png" alt="image-20220824153836952"></p>
<p>这样<code>backend</code>端的接收函数就实现了</p>
<h4 id="匹配池启动"><a href="#匹配池启动" class="headerlink" title="匹配池启动"></a>匹配池启动</h4><p>这样一个匹配池线程我们选择在Springboot启动之前随之启动</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824105744026.png" alt="image-20220824105744026"></p>
<h4 id="Debug调试"><a href="#Debug调试" class="headerlink" title="Debug调试"></a>Debug调试</h4><p>启动<code>MatchingSystem</code>所对应的<code>SpringBoot</code>服务，可以看到，每秒就会执行一次<code>matchPlayers()</code></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824163955389.png" alt="image-20220824163955389"></p>
<p>现在前端一个玩家点击“匹配”按钮</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824164454541.png" alt="image-20220824164454541"></p>
<p>可以看到对应的<code>waitingTime</code>每隔一秒加1</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824164635862.png" alt="image-20220824164635862"></p>
<p>点击取消之后，就会删除。</p>
<p>之后测试两个用户</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824170756125.png" alt="image-20220824170756125"></p>
<p>很快实现匹配</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824170730058.png" alt="image-20220824170730058"></p>
<p>为了便于测试，将两名玩家的分值差距调大。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824171202665.png" alt="image-20220824171202665"></p>
<p>分差100，根据匹配规则，需要满足与自己的分值差距，小于自己的等待时间*10，</p>
<p>ratingDelta &lt;&#x3D; waitingTime * 10; (ratingDelta &#x3D; 100)</p>
<p>意味着</p>
<p>waitingTime &gt;&#x3D; 10</p>
<p>因此，需要两名玩家的等待时间都&gt;&#x3D;10的时候，两者匹配。</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824171226445.png" alt="image-20220824171226445"></p>
<p>测试结果如下：</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824171939710.png" alt="image-20220824171939710"></p>
<h4 id="老板模式"><a href="#老板模式" class="headerlink" title="老板模式"></a>老板模式</h4><p>有些时候玩家匹配成功之后，游戏过程中，突然老板进来了，然后此时立刻关闭网页。也就是不通过请求的方式想匹配系统发起取消匹配，而是直接断开连接。</p>
<p>也就是针对：玩家在匹配池，但是玩家已经断开连接</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824173157365.png" alt="image-20220824173157365"></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824173522989.png" alt="image-20220824173522989"></p>
<p>如上，报异常的原因是因为，<code>userConnectionInfo.get(userA.getId())</code>返回的是一个空对象，然后空对象是没有<code>game</code>属性的，所以会报错。</p>
<p>因此这里需要加一些判断。如果已经断开连接，还是将其匹配到一起，但是6秒之内没有接收到操作就会判输。</p>
<p><code>WebSocketServer.java</code></p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824174716195.png" alt="image-20220824174716195"></p>
<img src="/images/实现微服务：匹配系统/image-20220824174748271.png" alt="image-20220824174748271" style="zoom: 67%;" />

<p>同时，<code>consumer.utils.Game.java</code>也要添加判断</p>
<p><img src="/images/%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%9A%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/image-20220824175133843.png" alt="image-20220824175133843"></p>
<p>如果已经断开连接，还是将其匹配到一起（不报异常），但是6秒之内没有接收到操作就会判输。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/01/24/Springboot-%E5%AE%9E%E7%8E%B0%E5%BE%AE%E6%9C%8D%E5%8A%A1%E5%8C%B9%E9%85%8D%E7%B3%BB%E7%BB%9F/" data-id="cm8sja97f001r8ktb3xvp0938" data-title="Springboot-实现微服务匹配系统" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Springboot/" rel="tag">Springboot</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Springboot-创建个人中心页面" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/01/24/Springboot-%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/" class="article-date">
  <time class="dt-published" datetime="2025-01-24T08:58:59.000Z" itemprop="datePublished">2025-01-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Web/">Web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/01/24/Springboot-%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/">Springboot-创建个人中心页面</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="数据库"><a href="#数据库" class="headerlink" title="数据库"></a>数据库</h2><p>在数据库中创建表<code>bot</code><br>表中包含的列：</p>
<ul>
<li><code>id: int</code>：非空、自动增加、唯一、主键</li>
<li><code>user_id: int</code>：非空，用于表示<code>bot</code>的作者<ul>
<li>注意：在pojo中需要定义成<code>userId</code>，也就是驼峰命名；在<code>queryWrapper</code>中的名称仍然为<code>user_id</code></li>
</ul>
</li>
<li><code>title: varchar(100)</code></li>
<li><code>description: varchar(300)</code></li>
<li><code>content：varchar(10000)</code>，对应的<code>bot</code>的代码</li>
<li><code>rating: int</code>：默认值为1500</li>
<li><code>createtime: datetime</code><ul>
<li><code>pojo</code>中定义日期格式的注解：<code>@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</code></li>
</ul>
</li>
<li><code>modifytime</code>: <code>datetime</code><ul>
<li><code>pojo</code>中定义日期格式的注解：<code>@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</code></li>
</ul>
</li>
</ul>
<h2 id="Pojo"><a href="#Pojo" class="headerlink" title="Pojo"></a>Pojo</h2><p><code>backend/pojo</code>中.java创建对应的<code>Bot.java</code>，将表中的内容映射成<code>class</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Bot</span> &#123;</span><br><span class="line">    <span class="meta">@TableId(type = IdType.AUTO)</span></span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="keyword">private</span> Integer userId;</span><br><span class="line">    <span class="keyword">private</span> String title;</span><br><span class="line">    <span class="keyword">private</span> String description;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">    <span class="keyword">private</span> Integer rating;</span><br><span class="line">    <span class="meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date createtime;</span><br><span class="line">    <span class="meta">@JsonFormat(pattern = &quot;yyyy-MM-dd HH:mm:ss&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> Date modifytime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="mapper"><a href="#mapper" class="headerlink" title="mapper"></a>mapper</h2><p>创建<code>backend/mapper/BotMapper.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">BotMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="后端API"><a href="#后端API" class="headerlink" title="后端API"></a>后端API</h2><p>接下来就需要实现有关增删改查的四个后端<code>api</code></p>
<ul>
<li><code>/user/bot/add/</code>：创建一个<code>Bot</code></li>
<li><code>/user/bot/remove/</code>：删除一个<code>Bot</code></li>
<li><code>/user/bot/update/</code>：修改一个<code>Bot</code></li>
<li><code>/user/bot/getlist/</code>：查询<code>Bot</code>列表</li>
</ul>
<p>对于后端api，总共需要实现三个地方，service，service.impl和controller</p>
<h3 id="service"><a href="#service" class="headerlink" title="service"></a>service</h3><p>1）<code>service.user.bot.AddService.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">AddService</span> &#123;</span><br><span class="line">    Map&lt;String, String&gt; <span class="title function_">add</span> <span class="params">(Map&lt;String, String&gt; data)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）<code>service.user.bot.RemoveService.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">RemoveService</span> &#123;</span><br><span class="line">    Map&lt;String, String&gt; <span class="title function_">remove</span><span class="params">(Map&lt;String, String&gt; data)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3）<code>service.user.bot.UpdateService.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UpdateService</span> &#123;</span><br><span class="line">    Map&lt;String, String&gt; <span class="title function_">update</span> <span class="params">(Map &lt;String, String&gt; data)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4）<code>service.user.bot.GetListService.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">GetListService</span> &#123;</span><br><span class="line">    <span class="comment">//查询当前用户的bot</span></span><br><span class="line">    List&lt;Bot&gt; <span class="title function_">getlist</span><span class="params">()</span>;<span class="comment">//由于当前用户的user id保存在token中 因此不用传参数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="service-impl"><a href="#service-impl" class="headerlink" title="service.impl"></a>service.impl</h3><p>1）<code>service.impl.user.bot.AddServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddServiceImpl</span>  <span class="keyword">implements</span> <span class="title class_">AddService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BotMapper botMapper;<span class="comment">//注入接口</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">add</span><span class="params">(Map&lt;String, String&gt; data)</span> &#123;</span><br><span class="line">        <span class="comment">//1. 获取User</span></span><br><span class="line">        <span class="comment">//同InfoServiceImpl一样 如果授权成功 则从上下文中将User信息提取出来</span></span><br><span class="line">        <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span></span><br><span class="line">                (UsernamePasswordAuthenticationToken) SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">        <span class="type">UserDetailsImpl</span> <span class="variable">loginUser</span> <span class="operator">=</span> (UserDetailsImpl) authenticationToken.getPrincipal();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> loginUser.getUser();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//2. 获取data内容</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">title</span> <span class="operator">=</span> data.get(<span class="string">&quot;title&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">description</span> <span class="operator">=</span> data.get(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> data.get(<span class="string">&quot;content&quot;</span>);</span><br><span class="line"></span><br><span class="line">        Map&lt;String,String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();<span class="comment">//定义return格式</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//语法检查</span></span><br><span class="line">        <span class="keyword">if</span>(title == <span class="literal">null</span> || title.length() == <span class="number">0</span>)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;标题不能为空&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(title.length() &gt; <span class="number">100</span>)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;标题长度不能大于100&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(description == <span class="literal">null</span> || description.length() == <span class="number">0</span>)&#123;</span><br><span class="line">            description = <span class="string">&quot;这个用户很懒，什么也没有留下&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(description.length() &gt; <span class="number">300</span>)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;Bot描述的长度不能大于300&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(content == <span class="literal">null</span> || content.length() == <span class="number">0</span>)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;代码不能为空&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(content.length() &gt; <span class="number">10000</span>)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;代码长度不能大于10000&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3. 创建Bot对象</span></span><br><span class="line">        <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        <span class="comment">//id自增 因此不用传</span></span><br><span class="line">        <span class="comment">//创建时间和修改时间一致</span></span><br><span class="line">        <span class="type">Bot</span> <span class="variable">bot</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Bot</span>(<span class="literal">null</span>, user.getId(), title, description, content, <span class="number">1500</span>, now, now);</span><br><span class="line">        botMapper.insert(bot);</span><br><span class="line">        map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;success&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2）<code>service.impl.user.bot.RemoveServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoveServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">RemoveService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BotMapper botMapper;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">remove</span><span class="params">(Map&lt;String, String&gt; data)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//1.获取当前User</span></span><br><span class="line">        <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span></span><br><span class="line">                (UsernamePasswordAuthenticationToken) SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">        <span class="type">UserDetailsImpl</span> <span class="variable">loginUser</span> <span class="operator">=</span> (UserDetailsImpl) authenticationToken.getPrincipal();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> loginUser.getUser();</span><br><span class="line">        <span class="comment">//2.获取bot</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">bot_id</span> <span class="operator">=</span> Integer.parseInt(data.get(<span class="string">&quot;bot_id&quot;</span>));</span><br><span class="line">        <span class="type">Bot</span> <span class="variable">bot</span> <span class="operator">=</span> botMapper.selectById(bot_id);</span><br><span class="line"></span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.判断条件</span></span><br><span class="line">        <span class="keyword">if</span>(bot == <span class="literal">null</span>)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;Bot不存在或已被删除&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!bot.getUserId().equals(user.getId()))&#123;<span class="comment">//比较数字对象用equals</span></span><br><span class="line">            map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;没有权限删除该Bot&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        botMapper.deleteById(bot_id);</span><br><span class="line">        map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;success&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3)<code>service.impl.user.bot.UpdateServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UpdateServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">UpdateService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BotMapper botMapper;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">update</span><span class="params">(Map&lt;String, String&gt; data)</span> &#123;</span><br><span class="line">        <span class="comment">//1.获取当前User</span></span><br><span class="line">        <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span></span><br><span class="line">                <span class="operator">=</span> (UsernamePasswordAuthenticationToken) SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">        <span class="type">UserDetailsImpl</span> <span class="variable">loginUser</span></span><br><span class="line">                <span class="operator">=</span> (UserDetailsImpl) authenticationToken.getPrincipal();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> loginUser.getUser();</span><br><span class="line">        <span class="comment">//2.获取属性并检查</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">title</span> <span class="operator">=</span> data.get(<span class="string">&quot;title&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">description</span> <span class="operator">=</span> data.get(<span class="string">&quot;description&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">content</span> <span class="operator">=</span> data.get(<span class="string">&quot;content&quot;</span>);</span><br><span class="line">        <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>();</span><br><span class="line">        <span class="comment">//语法检查</span></span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span>(title == <span class="literal">null</span> || title.length() == <span class="number">0</span>)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;标题不能为空&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(title.length() &gt; <span class="number">100</span>)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;标题长度不能大于100&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(description == <span class="literal">null</span> || description.length() == <span class="number">0</span>)&#123;</span><br><span class="line">            description = <span class="string">&quot;这个用户很懒，什么也没有留下&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(description.length() &gt; <span class="number">300</span>)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;Bot描述的长度不能大于300&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(content == <span class="literal">null</span> || content.length() == <span class="number">0</span>)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;代码不能为空&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(content.length() &gt; <span class="number">10000</span>)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;代码长度不能大于10000&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//3.获取bot并更新</span></span><br><span class="line">        <span class="type">int</span> <span class="variable">bot_id</span> <span class="operator">=</span> Integer.parseInt(data.get(<span class="string">&quot;bot_id&quot;</span>));</span><br><span class="line">        <span class="type">Bot</span> <span class="variable">bot</span> <span class="operator">=</span> botMapper.selectById(bot_id);</span><br><span class="line">        <span class="keyword">if</span>(bot == <span class="literal">null</span>)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;Bot不存在或已删除&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!bot.getUserId().equals(user.getId()))&#123;</span><br><span class="line">            map.put(<span class="string">&quot;error_message&quot;</span>, <span class="string">&quot;没有权限修改该Bot&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//注意 id userid不可改 rating不在此处修改</span></span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            bot.setTitle(title);</span><br><span class="line">            bot.setDescription(description);</span><br><span class="line">            bot.setContent(content);</span><br><span class="line">            bot.setModifytime(now);</span><br><span class="line">        &#125;<span class="keyword">catch</span>(Exception e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;更新失败&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        botMapper.updateById(bot);</span><br><span class="line">        map.put(<span class="string">&quot;error_message&quot;</span>, <span class="string">&quot;success&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4）<code>service.impl.user.bot.GetListServiceImpl.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetListServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">GetListService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> BotMapper botMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Bot&gt; <span class="title function_">getlist</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//1.获取用户</span></span><br><span class="line">        <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span></span><br><span class="line">                (UsernamePasswordAuthenticationToken) SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">        <span class="type">UserDetailsImpl</span> <span class="variable">loginUser</span> <span class="operator">=</span> (UserDetailsImpl) authenticationToken.getPrincipal();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> loginUser.getUser();</span><br><span class="line">        <span class="comment">//2.查询当前用户下的所有Bot</span></span><br><span class="line">        QueryWrapper&lt;Bot&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>();</span><br><span class="line">        queryWrapper.eq(<span class="string">&quot;user_id&quot;</span>,user.getId());</span><br><span class="line">        List&lt;Bot&gt; bots = botMapper.selectList(queryWrapper);</span><br><span class="line">        <span class="keyword">return</span> bots;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="controller"><a href="#controller" class="headerlink" title="controller"></a>controller</h3><p>1）<code>controller.user.bot.AddController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AddController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AddService addService;<span class="comment">//将AddService接口注入</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/user/bot/add/&quot;)</span> <span class="comment">//处理涉及修改数据库的请求 用Post</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">add</span> <span class="params">(<span class="meta">@RequestParam</span> Map&lt;String,String&gt; data)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> addService.add(data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试：</p>
<p>在<code>views\user\bot\UserBotIndexView.vue</code>中创建如下代码：</p>
<img src="/images/创建个人中心页面/image-20220730175603032.png" alt="image-20220730175603032" style="zoom:67%;" />

<p>使用<code>zhou</code>进行登录，对应的<code>userID</code>为7</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220730175652505.png" alt="image-20220730175652505"></p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220730175706824.png" alt="image-20220730175706824"></p>
<p>2）<code>controller.user.bot.RemoveController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoveController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RemoveService removeService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/user/bot/remove/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String,String&gt; <span class="title function_">remove</span> <span class="params">(<span class="meta">@RequestParam</span> Map&lt;String, String&gt; data)</span>&#123;</span><br><span class="line">        <span class="comment">//data中只保存botid的信息</span></span><br><span class="line">        <span class="keyword">return</span> removeService.remove(data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3）<code>controller.user.bot.UpdateController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UpdateController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UpdateService updateService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/user/bot/update/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">update</span> <span class="params">(<span class="meta">@RequestParam</span> Map&lt;String,String&gt; data)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> updateService.update(data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4）<code>controller.user.bot.GetListController.java</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">GetListController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> GetListService getListService;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/bot/getlist&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Bot&gt; <span class="title function_">getlist</span> <span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> getListService.getlist();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="前端实现"><a href="#前端实现" class="headerlink" title="前端实现"></a>前端实现</h2><p>接下来实现“我的Bot”页面</p>
<p>在个人中心页面，要能对Bot进行增删改查</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220730161935590.png" alt="image-20220730161935590"></p>
<h3 id="展示列表"><a href="#展示列表" class="headerlink" title="展示列表"></a>展示列表</h3><p>依然是使用Grid system进行布局，Grid system将一行分成12份，我们设置头像占3份，其余占9份</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">template</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;row&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-3&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;card&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;card-body&quot;</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">img</span> <span class="attr">:src</span>=<span class="string">&quot;$store.state.user.photo&quot;</span> <span class="attr">style</span>=<span class="string">&quot;width:100%&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;col-9&quot;</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;card&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;card-header&quot;</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">style</span>=<span class="string">&quot;font-size:130%&quot;</span>&gt;</span>我的Bot<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary float-end&quot;</span>&gt;</span>创建<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;card-body&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">template</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">style</span> <span class="attr">scoped</span>&gt;</span><span class="language-css"></span></span><br><span class="line"><span class="language-css"><span class="selector-tag">div</span><span class="selector-class">.card</span>&#123;</span></span><br><span class="line"><span class="language-css">    <span class="attribute">margin-top</span>: <span class="number">20px</span>;</span></span><br><span class="line"><span class="language-css">&#125;</span></span><br><span class="line"><span class="language-css"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>样式如下：</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803163606182.png" alt="image-20220803163606182"></p>
<p>现在需要显示bot列表，就需要通过Ajax来请求后端的api：<code>/user/bot/getlist/</code></p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803164320577.png" alt="image-20220803164320577"></p>
<p>然后将获取到的bots渲染到前端</p>
<p>首先添加一个表格样式：</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803164531213.png" alt="image-20220803164531213"></p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803175914899.png" alt="image-20220803175914899"></p>
<p>此时，前端就将后端数据库中的结果遍历出来（当前登录的是7号用户）</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803175658935.png" alt="image-20220803175658935"></p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803175725945.png" alt="image-20220803175725945"></p>
<h3 id="创建Bot"><a href="#创建Bot" class="headerlink" title="创建Bot"></a>创建Bot</h3><p>设想是点击创建之后，可以有一个悬浮窗，我们在悬浮窗中创建。</p>
<p>用到Bootstrap的Modal组件</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803180128323.png" alt="image-20220803180128323"></p>
<p>使用其中一个demo进行修改</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803180638349.png" alt="image-20220803180638349"></p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803181249268.png" alt="image-20220803181249268"></p>
<p>效果如下：</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803181301330.png" alt="image-20220803181301330"></p>
<p>现在需要继续在里面添加Form表单</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803181623641.png" alt="image-20220803181623641"></p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803195744539.png" alt="image-20220803195744539"></p>
<p>效果如下：</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803195722573.png" alt="image-20220803195722573"></p>
<p>在<code>script</code>中，借助<code>reactive</code>定义一个<code>Bot</code>对象</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; reactive &#125; <span class="keyword">from</span> <span class="string">&#x27;vue&#x27;</span></span><br><span class="line"><span class="comment">// 定义一个Bot对象</span></span><br><span class="line"><span class="keyword">const</span> botadd = <span class="title function_">reactive</span>(&#123;</span><br><span class="line">    <span class="attr">title</span>:<span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">description</span>:<span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">content</span>:<span class="string">&quot;&quot;</span>,</span><br><span class="line">    <span class="attr">error_message</span>:<span class="string">&quot;&quot;</span>,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>并在前端通过<code>v-model</code>将输入的内容与对象的属性绑定</p>
<p>在点击创建的时候，触发<code>add_bot</code>函数，定义如下：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义函数——创建bot</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">add_bot</span> = (<span class="params"></span>) =&gt;&#123;</span><br><span class="line">    botadd.<span class="property">error_message</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">        <span class="attr">url</span>:<span class="string">&quot;http://localhost:3000/user/bot/add/&quot;</span>,</span><br><span class="line">        <span class="attr">type</span>:<span class="string">&quot;post&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>:&#123;</span><br><span class="line">            <span class="attr">title</span>:botadd.<span class="property">title</span>,</span><br><span class="line">            <span class="attr">description</span>:botadd.<span class="property">description</span>,</span><br><span class="line">            <span class="attr">content</span>:botadd.<span class="property">content</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">headers</span>:&#123;</span><br><span class="line">            <span class="title class_">Authorization</span>:<span class="string">&quot;Bearer &quot;</span> + store.<span class="property">state</span>.<span class="property">user</span>.<span class="property">token</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">success</span>(<span class="params">resp</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(resp.<span class="property">error_message</span> === <span class="string">&quot;success&quot;</span>)&#123;</span><br><span class="line">                <span class="title function_">refresh_bots</span>();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                botadd.<span class="property">error_message</span> = resp.<span class="property">error_message</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意：凡是没有放行的url，也就是需要确保登录正常才能访问，在提交请求的时候，必须要添加授权验证信息：</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">headers</span>:&#123;</span><br><span class="line">            <span class="title class_">Authorization</span>:<span class="string">&quot;Bearer &quot;</span> + store.<span class="property">state</span>.<span class="property">user</span>.<span class="property">token</span>,</span><br><span class="line">        &#125;,</span><br></pre></td></tr></table></figure>

<p>目前只有登录和注册页面放行：</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803201514876.png" alt="image-20220803201514876"></p>
<p>只有对这两个url发起的请求不需要添加<code>headers</code></p>
<p>在点击“创建”按钮，触发<code>add_bot</code>事件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">&quot;button&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span> @<span class="attr">click</span>=<span class="string">&quot;add_bot&quot;</span>&gt;</span>创建&lt;/button</span><br></pre></td></tr></table></figure>

<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803201645383.png" alt="image-20220803201645383"></p>
<p>测试成功。</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803201904298.png" alt="image-20220803201904298"></p>
<p>优化：创建之后</p>
<ul>
<li>自动关闭悬浮窗</li>
<li>清空表单中的内容</li>
</ul>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803202429396.png" alt="image-20220803202429396"></p>
<p>另外有个问题时间不一致：</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803202518882.png" alt="image-20220803202518882"></p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803202531284.png" alt="image-20220803202531284"></p>
<p>在<code>Pojo</code>中修改时区，然后重启项目即可。</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803202734494.png" alt="image-20220803202734494"></p>
<h3 id="删除Bot"><a href="#删除Bot" class="headerlink" title="删除Bot"></a>删除Bot</h3><p>定义<code>remove_bot</code>函数，注意带有参数</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//定义函数——删除Bot</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">remove_bot</span> = (<span class="params">bot</span>)=&gt;&#123;</span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">        <span class="attr">url</span>:<span class="string">&quot;http://localhost:3000/user/bot/remove/&quot;</span>,</span><br><span class="line">        <span class="attr">type</span>:<span class="string">&quot;post&quot;</span>,</span><br><span class="line">        <span class="attr">headers</span>:&#123;</span><br><span class="line">            <span class="title class_">Authorization</span>:<span class="string">&quot;Bearer &quot;</span> + store.<span class="property">state</span>.<span class="property">user</span>.<span class="property">token</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">data</span>:&#123;</span><br><span class="line">            <span class="attr">bot_id</span>:bot.<span class="property">id</span></span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">success</span>(<span class="params">resp</span>)&#123;</span><br><span class="line">            <span class="keyword">if</span>(resp.<span class="property">error_message</span> == <span class="string">&quot;success&quot;</span>)&#123;</span><br><span class="line">                <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;删除成功&quot;</span>);</span><br><span class="line">                <span class="title function_">refresh_bots</span>();</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="title function_">alert</span>(resp.<span class="property">error_message</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>前端通过<code>@click</code>绑定事件</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;tbody&gt;</span><br><span class="line">    &lt;tr v-for=&quot;bot in bots&quot; :key=&quot;bot.id&quot;&gt;</span><br><span class="line">        &lt;td&gt;&#123;&#123; bot.title &#125;&#125;&lt;/td&gt;</span><br><span class="line">        &lt;td&gt;&#123;&#123; bot.createtime &#125;&#125;&lt;/td&gt;</span><br><span class="line">        &lt;td&gt;</span><br><span class="line">            &lt;button type=&quot;button&quot; class=&quot;btn btn-secondary&quot;</span><br><span class="line">                    style=&quot;margin-right:10px&quot;&gt;修改&lt;/button&gt;</span><br><span class="line">            &lt;button type=&quot;button&quot; class=&quot;btn btn-danger&quot; @click=&quot;remove_bot(bot)&quot;&gt;删除&lt;/button&gt;</span><br><span class="line">        &lt;/td&gt;</span><br><span class="line">    &lt;/tr&gt;</span><br><span class="line">&lt;/tbody&gt;</span><br></pre></td></tr></table></figure>

<h3 id="修改Bot"><a href="#修改Bot" class="headerlink" title="修改Bot"></a>修改Bot</h3><p>修改的逻辑和添加基本一致</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//定义函数——修改bot</span></span><br><span class="line"><span class="keyword">const</span> <span class="title function_">update_bot</span> = (<span class="params">bot</span>) =&gt; &#123;</span><br><span class="line">    bot.<span class="property">error_message</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">    $.<span class="title function_">ajax</span>(&#123;</span><br><span class="line">        <span class="attr">url</span>: <span class="string">&quot;http://localhost:3000/user/bot/update/&quot;</span>,</span><br><span class="line">        <span class="attr">type</span>: <span class="string">&quot;post&quot;</span>,</span><br><span class="line">        <span class="attr">data</span>: &#123;</span><br><span class="line">            <span class="attr">bot_id</span>:bot.<span class="property">id</span>,</span><br><span class="line">            <span class="attr">title</span>: bot.<span class="property">title</span>,</span><br><span class="line">            <span class="attr">description</span>: bot.<span class="property">description</span>,</span><br><span class="line">            <span class="attr">content</span>: bot.<span class="property">content</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">headers</span>: &#123;</span><br><span class="line">            <span class="title class_">Authorization</span>: <span class="string">&quot;Bearer &quot;</span> + store.<span class="property">state</span>.<span class="property">user</span>.<span class="property">token</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="title function_">success</span>(<span class="params">resp</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (resp.<span class="property">error_message</span> === <span class="string">&quot;success&quot;</span>) &#123;</span><br><span class="line">                <span class="title class_">Modal</span>.<span class="title function_">getInstance</span>(<span class="string">&#x27;#update-bot-btn-&#x27;</span> + bot.<span class="property">id</span>).<span class="title function_">hide</span>();</span><br><span class="line">                <span class="title function_">alert</span>(<span class="string">&quot;修改成功&quot;</span>);</span><br><span class="line">                <span class="title function_">refresh_bots</span>();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                bot.<span class="property">error_message</span> = resp.<span class="property">error_message</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在前端，需要将每一个<code>bot</code>对应的<code>Modal</code>框都不一样，因此需要添加一个id字段</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803210955149.png" alt="image-20220803210955149"></p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803211231932.png" alt="image-20220803211231932"></p>
<p>每一个<code>bot</code>与每一个模态框绑定起来，这样点击对应的bot之后，在<code>Modal</code>框中展示出相应的的内容</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803211408078.png" alt="image-20220803211408078"></p>
<p>否则的话，不管点击哪个<code>bot</code>，因为只有一个<code>Modal</code>框，展示的都只是第一个<code>bot</code>的内容！</p>
<h3 id="代码编辑器"><a href="#代码编辑器" class="headerlink" title="代码编辑器"></a>代码编辑器</h3><p>希望将编写代码的区域换成代码编辑器</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803212149775.png" alt="image-20220803212149775"></p>
<p>在<code>vue</code>控制台安装依赖：<code>vue3-ace-editor</code></p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803212300911.png" alt="image-20220803212300911"></p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803213335451.png" alt="image-20220803213335451"></p>
<p>解决方法是，使用管理员打开<code>powershell</code></p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803213640148.png" alt="image-20220803213640148"></p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803213657557.png" alt="image-20220803213657557"></p>
<p>集成依赖，并将其注册为VUE选项的组件</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">VAceEditor</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;vue3-ace-editor&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> ace <span class="keyword">from</span> <span class="string">&#x27;ace-builds&#x27;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    data,</span><br><span class="line">    methods,</span><br><span class="line">    ...</span><br><span class="line">    <span class="attr">components</span>: &#123;</span><br><span class="line">        <span class="title class_">VAceEditor</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>setup</code>中添加</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ace.<span class="property">config</span>.<span class="title function_">set</span>(</span><br><span class="line">    <span class="string">&quot;basePath&quot;</span>, </span><br><span class="line">    <span class="string">&quot;https://cdn.jsdelivr.net/npm/ace-builds@&quot;</span> + <span class="built_in">require</span>(<span class="string">&#x27;ace-builds&#x27;</span>).<span class="property">version</span> + <span class="string">&quot;/src-noconflict/&quot;</span>)</span><br></pre></td></tr></table></figure>

<p>然后用下面这段代码替换代码区域</p>
<p>(对于修改而言，是<code>v-model:value=&quot;bot.content&quot;</code>)</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">VAceEditor</span></span></span><br><span class="line"><span class="tag">    <span class="attr">v-model:value</span>=<span class="string">&quot;botadd.content&quot;</span></span></span><br><span class="line"><span class="tag">    @<span class="attr">init</span>=<span class="string">&quot;editorInit&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">lang</span>=<span class="string">&quot;c_cpp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">theme</span>=<span class="string">&quot;textmate&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">style</span>=<span class="string">&quot;height: 300px&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>

<p>实现效果</p>
<p><img src="/images/%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/image-20220803214828599.png" alt="image-20220803214828599"></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/01/24/Springboot-%E5%88%9B%E5%BB%BA%E4%B8%AA%E4%BA%BA%E4%B8%AD%E5%BF%83%E9%A1%B5%E9%9D%A2/" data-id="cm8sja97c001f8ktbe6ngemx6" data-title="Springboot-创建个人中心页面" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Springboot/" rel="tag">Springboot</a></li></ul>

    </footer>
  </div>
  
</article>



  
    <article id="post-Springboot-配置MySQL和注册登录模块" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2025/01/24/Springboot-%E9%85%8D%E7%BD%AEMySQL%E5%92%8C%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/" class="article-date">
  <time class="dt-published" datetime="2025-01-24T08:24:59.000Z" itemprop="datePublished">2025-01-24</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Web/">Web</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2025/01/24/Springboot-%E9%85%8D%E7%BD%AEMySQL%E5%92%8C%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/">Springboot-配置MySQL和注册登录模块</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h2 id="MysQL"><a href="#MysQL" class="headerlink" title="MysQL"></a>MysQL</h2><h3 id="配置环境变量"><a href="#配置环境变量" class="headerlink" title="配置环境变量"></a>配置环境变量</h3><p>将<code>C:\Program Files\MySQL\MySQL Server 8.0\bin</code>（如果安装到了其他目录，填写相应目录的地址即可）添加到环境变量<code>PATH</code>中，这样就可以在任意目录的终端中执行<code>mysql</code>命令了。</p>
<h3 id="MySQL服务"><a href="#MySQL服务" class="headerlink" title="MySQL服务"></a>MySQL服务</h3><p>（默认开机自动启动，如果想手动操作，可以参考如下命令）</p>
<ul>
<li>关闭：<code>net stop mysql80</code></li>
<li>启动：<code>net start mysql80</code></li>
</ul>
<h3 id="MySQL常用操作"><a href="#MySQL常用操作" class="headerlink" title="MySQL常用操作"></a>MySQL常用操作</h3><p>连接用户名为<code>root</code>，密码为<code>123456</code>的数据库服务：<code>mysql -uroot -p123456</code></p>
<ul>
<li><code>show databases;</code>：列出所有数据库</li>
<li><code>create database kob</code>;：创建数据库</li>
<li><code>drop database kob;</code>：删除数据库</li>
<li><code>use kob;</code>：使用数据库kob</li>
<li><code>show tables;</code>：列出当前数据库的所有表</li>
<li><code>create table user(id int, username varchar(100))</code>：创建名称为user的表，表中包含id和username两个属性。</li>
<li><code>drop table user;</code>：删除表</li>
<li><code>insert into user values(1, &#39;hong&#39;);</code>：在表中插入数据</li>
<li><code>select * from user;</code>：查询表中所有数据</li>
<li><code>delete from user where id = 2;</code>：删除某行数据</li>
</ul>
<h3 id="IDEA关联"><a href="#IDEA关联" class="headerlink" title="IDEA关联"></a>IDEA关联</h3><img src="/images/配置MySQL与注册登录模块/image-20220721093920837-16591874391831.png" />

<img src="/images/配置MySQL与注册登录模块/image-20220721095410330-16591874391842.png" />

<p>此时MySQL连接成功，并可以在IDEA中通过图形界面修改</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220721095859613-16591874391843.png" alt="image-20220721095859613"></p>
<h2 id="配置SpringBoot"><a href="#配置SpringBoot" class="headerlink" title="配置SpringBoot"></a>配置SpringBoot</h2><h3 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h3><p>在<a target="_blank" rel="noopener" href="https://mvnrepository.com/">Maven仓库地址</a>中搜索相关依赖</p>
<p>然后在<code>pom.xml</code>文件中添加依赖：</p>
<ul>
<li><p><code>Spring Boot Starter JDBC</code></p>
</li>
<li><p><code>Project Lombok</code></p>
<p>自动资源管理、自动生成 getter、setter、equals、hashCode 和 toString 等</p>
</li>
<li><p><code>MySQL Connector/J</code></p>
</li>
<li><p><code>mybatis-plus-boot-starter</code></p>
</li>
<li><p><code>mybatis-plus-generator</code></p>
<p><a target="_blank" rel="noopener" href="https://baomidou.com/">Mybatis-Plus官网</a></p>
</li>
<li><p><code>spring-boot-starter-security</code>（暂时不装）</p>
</li>
<li><p><code>jjwt-api</code>（暂时不装）</p>
</li>
</ul>
<p>以为例<code>Spring Boot Starter JDBC</code>为例，复制依赖代码</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220721100258315-16591874391844.png" alt="image-20220721100258315"></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework.boot/spring-boot-starter-jdbc --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>复制到<code>pom.xml</code>中的<code>dependencies</code>模块下：</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220721100509553-16591874391845.png" alt="image-20220721100509553"></p>
<p>最终添加的<code>dependency</code>如下</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--Spring Boot Starter JDBC--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--Project Lombok--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--MySQL Connector/J--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>8.0.29<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--mybatis-plus-boot-starter--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--mybatis-plus-generator--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.baomidou<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-plus-generator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.5.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>重新加载所有<code>maven</code>项目</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220721101330393-16591874391846.png" alt="image-20220721101330393"></p>
<p>加载完成之后，就能看到依赖项</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220721101645294-16591874391847.png" alt="image-20220721101645294"></p>
<h3 id="数据库配置"><a href="#数据库配置" class="headerlink" title="数据库配置"></a>数据库配置</h3><p>在<code>application.properties</code>中添加数据库配置：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">spring.datasource.username=root</span><br><span class="line">spring.datasource.password=123456</span><br><span class="line">spring.datasource.url=jdbc:mysql://localhost:3306/kob?serverTimezone=Asia/Shanghai&amp;useUnicode=true&amp;characterEncoding=utf-8</span><br><span class="line">spring.datasource.driver-class-name=com.mysql.cj.jdbc.Driver</span><br></pre></td></tr></table></figure>

<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220721102022625-16591874391848.png" alt="image-20220721102022625"></p>
<p>此时运行项目即可</p>
<h3 id="SpringBoot中的常用模块"><a href="#SpringBoot中的常用模块" class="headerlink" title="SpringBoot中的常用模块"></a>SpringBoot中的常用模块</h3><ul>
<li><p><code>pojo</code>层：将数据库中的表对应成<code>Java</code>中的<code>Class</code></p>
</li>
<li><p><code>mapper</code>层（也叫<code>Dao</code>层）：将<code>pojo</code>层的<code>class</code>中的操作（CRUD），映射成<code>sql</code>语句</p>
<p>Create &#x3D;&gt; insert</p>
<p>Retrieve&#x3D;&gt; select</p>
</li>
<li><p><code>service</code>层：写具体的业务逻辑，组合使用<code>mapper</code>中的操作</p>
</li>
<li><p><code>controller</code>层：负责请求转发，接受前端页面过来的参数，传给相应<code>Service</code>处理，接到返回值，再传给页面</p>
</li>
</ul>
<p>依次实现这些模块</p>
<h4 id="pojo层"><a href="#pojo层" class="headerlink" title="pojo层"></a>pojo层</h4><p>首先创建<code>com/kob/backend/pojo</code>包，然后在其中创建<code>User.java</code></p>
<p>负责实现与<code>User</code>表想对应的<code>User</code>类</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220721104508277-16591874391849.png" alt="image-20220721104508277"></p>
<p>这里的关键是三个注解</p>
<p>从编译后的<code>class</code>文件中，也能证明这一点。</p>
<p>添加注解之前：</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220721104817267-165918743918410.png" alt="image-20220721104817267"></p>
<p>添加注解之后</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220721104700989-165918743918411.png" alt="image-20220721104700989"></p>
<h4 id="mapper层"><a href="#mapper层" class="headerlink" title="mapper层"></a>mapper层</h4><p>首先创建<code>com/kob/backend/mapper</code>包，然后在其中创建<code>UserMapper.java</code></p>
<p>添加<code>@Mapper</code>注解并且继承<code>mybatisplus</code>中的<code>BaseMapper</code>，传入<code>&lt;User&gt;</code></p>
<p>目的是将<code>pojo</code>层的<code>User</code>中的操作（CRUD），映射成<code>sql</code>语句</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220721105538329-165918743918412.png" alt="image-20220721105538329"></p>
<h4 id="controller层"><a href="#controller层" class="headerlink" title="controller层"></a>controller层</h4><p>为方便调试，在当前阶段，先讲<code>service</code>与<code>controller</code>写在一块（后期具体业务需要分开，<code>controller</code>调用<code>sevice</code>中的接口）</p>
<p>创建<code>com/kob/backend/controller</code>包</p>
<p>然后针对<code>User</code>表创建<code>/user/UserController.java</code></p>
<p>添加<code>@RestController</code>注解</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br></pre></td></tr></table></figure>

<p>在这里我们可以实现与<code>User</code>表相关的业务逻辑（正常应该在<code>service</code>层 这里为了方便调试 暂时写在一块了）</p>
<p><code>@RequestMapping </code>将所有请求类型全部接收过来</p>
<ul>
<li>如果只处理<code>post</code>类型的请求<code>@PostMapping</code></li>
<li>如果只处理<code>get</code>类型的请求<code>@GetMapping</code></li>
</ul>
<p>1）实现查询当前所有用户</p>
<p>在<code>controller</code>中如何调用数据库的接口</p>
<p> 首先引入刚刚定义的UserMapper接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">UserMapper userMapper;</span><br></pre></td></tr></table></figure>

<p>UserMapper接口由mybatisplus来实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">UserMapper</span> <span class="keyword">extends</span> <span class="title class_">BaseMapper</span>&lt;User&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继承了mybatisplus中的BaseMapper</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220721140045933-165918743918413.png" alt="image-20220721140045933"></p>
<p>可以通过<a target="_blank" rel="noopener" href="https://baomidou.com/">Mybatis-Plus官网</a>来查看所有API的具体用法</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220721140317544-165918743918414.png" alt="image-20220721140317544"></p>
<p>如果我们希望查询所有用户，就要借助<code>selectList</code>这个api</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/all/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getAll</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> userMapper.selectList(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果运行如下：</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220721142053795-165918743918415.png" alt="image-20220721142053795"></p>
<p>与实际数据表中结果一致</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220721142552136-165918743918416.png" alt="image-20220721142552136"></p>
<p>2）指定ID查询用户</p>
<p>使用<code>selectById</code>api根据ID来查询用户</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/user/&#123;userId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">getUser</span><span class="params">(<span class="meta">@PathVariable</span> <span class="type">int</span> userId)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> userMapper.selectById(userId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果如下</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220721142514277-165918743918418.png" alt="image-20220721142514277"></p>
<p>同时也可以借助<code>Mybatis-Plus</code>中的条件构造器，来构造一些自定义的条件，通过对条件进行筛选的方式来过滤出结果。</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220721142953598-165918743918417.png" alt="image-20220721142953598"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/user/&#123;userId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> User <span class="title function_">getUser</span><span class="params">(<span class="meta">@PathVariable</span> <span class="type">int</span> userId)</span>&#123;</span><br><span class="line">    QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper.eq(<span class="string">&quot;id&quot;</span>, userId);<span class="comment">//构造条件</span></span><br><span class="line">    <span class="keyword">return</span> userMapper.selectOne(queryWrapper);<span class="comment">//过滤</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>结果与<code>selectById</code>一致。</p>
<p>这里代码中的返回值中的<code>User</code>就是所得到的符合条件<code>pojo</code>中<code>User</code>类的对象。</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722104627447-165918743918419.png" alt="image-20220722104627447"></p>
<p>实际上就是返回数据表中的一行数据。</p>
<p>3）区间查询</p>
<p>同样可以通过<code>ge</code>和<code>le</code>来进行区间查询</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/user/&#123;userId&#125;/to/&#123;userId2&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> List&lt;User&gt; <span class="title function_">getUser</span><span class="params">(<span class="meta">@PathVariable</span> <span class="type">int</span> userId, <span class="meta">@PathVariable</span> <span class="type">int</span> userId2)</span>&#123;</span><br><span class="line">    QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">    queryWrapper.ge(<span class="string">&quot;id&quot;</span>, userId).le(<span class="string">&quot;id&quot;</span>,userId2);<span class="comment">//构造条件</span></span><br><span class="line">    <span class="keyword">return</span> userMapper.selectList(queryWrapper);<span class="comment">//过滤</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>可以无限追加条件，通过<code>.condition</code>的方式</p>
</blockquote>
<p>例如查询<code>id&gt;=1</code>&amp;&amp; <code>id &lt;=4</code>的用户</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220721145736086-165918743918420.png" alt="image-20220721145736086"></p>
<p>4）插入数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/user/add/&#123;userId&#125;/&#123;username&#125;/&#123;password&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">addUser</span> <span class="params">(</span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable</span> <span class="type">int</span> userId,</span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable</span> String username,</span></span><br><span class="line"><span class="params">        <span class="meta">@PathVariable</span> String password)</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(userId, username, password);</span><br><span class="line">    userMapper.insert(user);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Add User Successfully&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722105747351-165918743918421.png" alt="image-20220722105747351"></p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722105800471-165918743918422.png" alt="image-20220722105800471"></p>
<p>5）删除记录</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping(&quot;/user/delete/&#123;userId&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">deleteUser</span><span class="params">(<span class="meta">@PathVariable</span> <span class="type">int</span> userId)</span>&#123;</span><br><span class="line">    userMapper.deleteById(userId);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Delete User Successfully&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722110331397-165918743918423.png" alt="image-20220722110331397"></p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722110341718-165918743918424.png" alt="image-20220722110341718"></p>
<h2 id="集成Spring-Security"><a href="#集成Spring-Security" class="headerlink" title="集成Spring Security"></a>集成Spring Security</h2><p>借助<code>Spring Security</code>来实现登录认证，再没有判断登录认证的情况下，访问任意界面，均无法访问，并弹出登录界面</p>
<p>在<code>pom.xml</code>文件中添加依赖：</p>
<ul>
<li><p><code>spring-boot-starter-security</code></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.7.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure></li>
</ul>
<img src="/images/配置MySQL与注册登录模块/image-20220722111559228-165918743918425.png" />

<p>此时再进行访问任意界面，均无法访问，并弹出登录界面</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722111838408-165918743918426.png" alt="image-20220722111838408"></p>
<p>该页面是<code>Spring Security</code>是自己实现的。</p>
<h3 id="login"><a href="#login" class="headerlink" title="login"></a>login</h3><p>默认用户名为<code>user</code></p>
<p>动态生成密码如下：</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722112149800-165918743918427.png" alt="image-20220722112149800"></p>
<p>输入之后就能成功访问</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722112255525-165918743918428.png" alt="image-20220722112255525"></p>
<p>并且在之后的访问过程中，均不需要重新登录。</p>
<h3 id="授权验证原理"><a href="#授权验证原理" class="headerlink" title="授权验证原理"></a>授权验证原理</h3><p>这涉及到授权验证方式：<code>session</code>（之后会使用<code>jjwt</code>，<code>session</code>是传统的授权与验证方式）</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722113233626-165918743918429.png" alt="image-20220722113233626"></p>
<p>1）登录阶段</p>
<p>登录成功以后，后端生成<code>SessionID</code>，将其同时保存在后端数据库与浏览器的<code>Cookie</code>中</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722114408783-165918743918430.png" alt="image-20220722114408783"></p>
<p>2）在每次向后端<code>Springboot</code>发送请求的同时，会将<code>SessionID</code>从<code>Cookie</code>中取出同样传送给后端<code>Springboot</code>。然后<code>Springboot</code>通过向数据库查询判断当前<code>SessionID</code>是否存在以及是否过期，如果存在，将有关<code>SessionID</code>的信息（包括对应的用户名、过期时间）从数据库中取出，判断是否过期，如果当前<code>SessionID</code>没有过期，表示登录成功。如果发现<code>SessionID</code>过期或者根本不存在，则返回给用户登录页重新登录。</p>
<p>例如：登录成功后会在<code>Cookie</code>中存入<code>Session</code>信息</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722115108943-165918743918431.png" alt="image-20220722115108943"></p>
<p>每次向后端请求时，都会取出</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722115250826-165918743918432.png" alt="image-20220722115250826"></p>
<p>如果对Session信息进行篡改或者删除</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722115330665-165918743918434.png" alt="image-20220722115330665"></p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722121136508-165918743918433.png" alt="image-20220722121136508"></p>
<p>再次请求时，由于后端在数据库中找不到对应的<code>SessionID</code>，返回登录页面</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722121223519-165918743918435.png" alt="image-20220722121223519"></p>
<p>注意：<code>SessionID</code>相当于给浏览器颁发的一张临时身份证，之后浏览器在执行业务操作的时候，都要随身携带这个身份证。</p>
<h3 id="logout"><a href="#logout" class="headerlink" title="logout"></a>logout</h3><p>此外，<code>Spring Security</code>还自己实现了<code>logout</code>界面</p>
<blockquote>
<p>可以理解为自己是新的controller</p>
</blockquote>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722112438434-165918743918436.png" alt="image-20220722112438434"></p>
<p>退出之后继续回到了最初的界面</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722112507976-165918743918437.png" alt="image-20220722112507976"></p>
<h3 id="修改Spring-Security"><a href="#修改Spring-Security" class="headerlink" title="修改Spring Security"></a>修改Spring Security</h3><p>此时登录还只是通过Spring Security提供的默认用户名和随机生成密码，如何通过数据库判断一个其中存储的用户是否登录成功呢？需要修改Spring Security</p>
<h4 id="UserDetailsServiceImpl"><a href="#UserDetailsServiceImpl" class="headerlink" title="UserDetailsServiceImpl"></a>UserDetailsServiceImpl</h4><p>实现<code>service.impl.UserDetailsServiceImpl</code>类，继承自<code>UserDetailsService</code>接口，用来接入数据库信息</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722145332746-165918743918438.png" alt="image-20220722145332746"></p>
<p>该<code>UserDetailsService</code>api接收一个username，通过该username返回包含用户的用户名和密码的UserDetails接口的实现类的对象（简称UserDetails的实现对象）</p>
<p>首先考虑根据username去数据库中查询对应的user</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722151902338-165918743918439.png" alt="image-20220722151902338"></p>
<p>在处理User是否存在之前，先创建一个UserDetails的实现类：</p>
<h4 id="UserDetailsImpl"><a href="#UserDetailsImpl" class="headerlink" title="UserDetailsImpl"></a>UserDetailsImpl</h4><ul>
<li>创建<code>service.impl.utils.UserDetailsImpl</code></li>
</ul>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722150951906-165918743918540.png" alt="image-20220722150951906"></p>
<p>实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UserDetailsImpl</span> <span class="keyword">implements</span> <span class="title class_">UserDetails</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> User user;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">UserDetailsImpl</span><span class="params">(User user)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.user = user;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Collection&lt;? <span class="keyword">extends</span> <span class="title class_">GrantedAuthority</span>&gt; getAuthorities() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getPassword</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> user.getPassword();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getUsername</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> user.getUsername();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonExpired</span><span class="params">()</span> &#123;<span class="comment">//是否帐户未过期</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isAccountNonLocked</span><span class="params">()</span> &#123;<span class="comment">//是否未被锁定</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isCredentialsNonExpired</span><span class="params">()</span> &#123;<span class="comment">//凭证是否未被过期</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">()</span> &#123;<span class="comment">//是否被启用</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果不加显示构造函数，也可以下面这样，自动添加相关的属性和构造函数。</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722152132786-165918743918541.png" alt="image-20220722152132786"></p>
<p>现在继续回到<code>service.impl.UserDetailsServiceImpl</code>，填上最后这段代码</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722152326201-165918743918542.png" alt="image-20220722152326201"></p>
<p>此时就可以实现根据数据库中User信息来进行登录，即根据用户的用户名，去查询用户信息，再根据输入的密码判断是否匹配，而不是使用默认的用户名和密码。</p>
<hr>
<p>不过此时登录会报错</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722153046526-165918743918543.png" alt="image-20220722153046526"></p>
<p>如果直接用明文密码来存储，需要在数据库中加上{noop}标记，代表不需要加密直接判断，就不用到PasswordEncoder</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722153312703-165918743918544.png" alt="image-20220722153312703"></p>
<p>此时再来登录</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722153427283-165918743918545.png" alt="image-20220722153427283"></p>
<p>就成功了 </p>
<img src="/images/配置MySQL与注册登录模块/image-20220722154604750-165918743918546.png" alt="image-20220722154604750" style="zoom: 67%;" />

<p>并且可以访问所有的API</p>
<hr>
<h4 id="密码的加密存储"><a href="#密码的加密存储" class="headerlink" title="密码的加密存储"></a>密码的加密存储</h4><p>上述可以看出，如果密码使用明文，必须声明！</p>
<p>如果我们需要对密码进行加密，实现<code>config.SecurityConfig</code>类，用来实现用户密码的加密存储</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>BCryptPasswordEncoder的测试</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722155757004-165918743918547.png" alt="image-20220722155757004"></p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722160024903-165918743918548.png" alt="image-20220722160024903"></p>
<p>现在需要将密码改成对应的加密形式，否则的话没法验证通过</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722161616372-165918743918549.png" alt="image-20220722161616372"></p>
<p>可以借助<code>BCryptPasswordEncoder</code>的<code>encode()</code>方法更新之前数据库中的密码</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722162142668-165918743918550.png" alt="image-20220722162142668"></p>
<p>此时再次登录，就可以成功。	</p>
<p>同时，要在添加阶段就直接存储加密阶段的代码</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722163222639-165918743918551.png" alt="image-20220722163222639"></p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722163442482-165918743918552.png" alt="image-20220722163442482"></p>
<p>结果如下：</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220722163801468-165918743918553.png" alt="image-20220722163801468"></p>
<h2 id="集成jwt验证"><a href="#集成jwt验证" class="headerlink" title="集成jwt验证"></a>集成jwt验证</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>默认情况下，使用session进行身份验证。但对于前后端分离的情况，可能会出现跨域问题，使用session会变得不方便，用jwt验证会更加容易。</p>
<p>对于给定的url，可以分为两大类：</p>
<ul>
<li>公开可以访问<ul>
<li>login页面</li>
</ul>
</li>
<li>需要授权才能访问</li>
</ul>
<p>先来看下传统使用session进行身份验证的方式：</p>
<img src="/images/配置MySQL与注册登录模块/image-20220727102042730-165918743918554.png" alt="image-20220727102042730" style="zoom:80%;" />

<p>（1）用户进行登录时，登录成功以后，后端生成<code>SessionID</code>，将其同时保存在后端数据库或者内存，和浏览器的<code>Cookie</code>中。（后端同样保存了<code>SessionID</code>与用户信息<code>userInfo</code>的映射关系）</p>
<p>（2）在每次向后端<code>Springboot</code>发送请求的同时，会将<code>SessionID</code>从<code>Cookie</code>中取出同样传送给后端。</p>
<p>（3）对于需要授权访问的url，<code>Springboot</code>通过向数据库or内存查询判断当前<code>SessionID</code>是否存在以及是否过期，如果存在，将有关<code>SessionID</code>的信息（包括对应的用户名、过期时间）从数据库中取出，判断是否过期，如果发现<code>SessionID</code>过期或者根本不存在，则返回给用户登录页重新登录。</p>
<p>（4）若当前<code>SessionID</code>没有过期，则通过<code>SessionID</code>与用户信息<code>userInfo</code>的映射关系，将对应的<code>User</code>提取到上下文中（在Contoller中就可以通过一些API来拿到<code>User</code>)，成功进行授权页面的访问。</p>
<p>为了解决跨域的情景，使用Jwt验证。</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220727145258762-165918743918555.png" alt="image-20220727145258762"></p>
<p>优势如下：</p>
<ul>
<li><p>容易实现跨域</p>
</li>
<li><p>不需要在服务器端存储</p>
<p>对于有多个服务器的情况，就可以实现用一个令牌来登录多个服务器</p>
</li>
</ul>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>1）在pom.xml文件配置相关依赖</p>
<ul>
<li><code>jjwt-api</code></li>
<li><code>jjwt-impl</code></li>
<li><code>jjwt-jackson</code></li>
</ul>
<p>2）添加相关类</p>
<ul>
<li><p>实现<code>utils.JwtUtil</code>类，为<code>jwt</code>工具类，用来创建、解析<code>jwt token</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.JwtBuilder;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Jwts;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.SignatureAlgorithm;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.crypto.SecretKey;</span><br><span class="line"><span class="keyword">import</span> javax.crypto.spec.SecretKeySpec;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.UUID;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtUtil</span> &#123;</span><br><span class="line">    <span class="comment">// 有效期14天</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">JWT_TTL</span> <span class="operator">=</span> <span class="number">60</span> * <span class="number">60</span> * <span class="number">1000L</span> * <span class="number">24</span> * <span class="number">14</span>;</span><br><span class="line">    <span class="comment">//秘钥</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">JWT_KEY</span> <span class="operator">=</span> <span class="string">&quot;SDFGjhdsfalshdfHFdsjkdsfds121232131afasdfac&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getUUID</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> UUID.randomUUID().toString().replaceAll(<span class="string">&quot;-&quot;</span>, <span class="string">&quot;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">createJWT</span><span class="params">(String subject)</span> &#123;</span><br><span class="line">        <span class="type">JwtBuilder</span> <span class="variable">builder</span> <span class="operator">=</span> getJwtBuilder(subject, <span class="literal">null</span>, getUUID());</span><br><span class="line">        <span class="keyword">return</span> builder.compact();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> JwtBuilder <span class="title function_">getJwtBuilder</span><span class="params">(String subject, Long ttlMillis, String uuid)</span> &#123;</span><br><span class="line">        <span class="type">SignatureAlgorithm</span> <span class="variable">signatureAlgorithm</span> <span class="operator">=</span> SignatureAlgorithm.HS256;</span><br><span class="line">        <span class="type">SecretKey</span> <span class="variable">secretKey</span> <span class="operator">=</span> generalKey();</span><br><span class="line">        <span class="type">long</span> <span class="variable">nowMillis</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        <span class="type">Date</span> <span class="variable">now</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(nowMillis);</span><br><span class="line">        <span class="keyword">if</span> (ttlMillis == <span class="literal">null</span>) &#123;</span><br><span class="line">            ttlMillis = JwtUtil.JWT_TTL;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">expMillis</span> <span class="operator">=</span> nowMillis + ttlMillis;</span><br><span class="line">        <span class="type">Date</span> <span class="variable">expDate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Date</span>(expMillis);</span><br><span class="line">        <span class="keyword">return</span> Jwts.builder()</span><br><span class="line">                .setId(uuid)</span><br><span class="line">                .setSubject(subject)</span><br><span class="line">                .setIssuer(<span class="string">&quot;sg&quot;</span>)</span><br><span class="line">                .setIssuedAt(now)</span><br><span class="line">                .signWith(signatureAlgorithm, secretKey)</span><br><span class="line">                .setExpiration(expDate);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> SecretKey <span class="title function_">generalKey</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] encodeKey = Base64.getDecoder().decode(JwtUtil.JWT_KEY);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">SecretKeySpec</span>(encodeKey, <span class="number">0</span>, encodeKey.length, <span class="string">&quot;HmacSHA256&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Claims <span class="title function_">parseJWT</span><span class="params">(String jwt)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">SecretKey</span> <span class="variable">secretKey</span> <span class="operator">=</span> generalKey();</span><br><span class="line">        <span class="keyword">return</span> Jwts.parserBuilder()</span><br><span class="line">                .setSigningKey(secretKey)</span><br><span class="line">                .build()</span><br><span class="line">                .parseClaimsJws(jwt)</span><br><span class="line">                .getBody();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


</li>
<li><p>实现<code>config.filter.JwtAuthenticationTokenFilter</code>类，用来验证<code>jwt token</code>是否合法有效，如果验证成功，则将<code>User</code>信息注入上下文中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.kob.backend.mapper.UserMapper;</span><br><span class="line"><span class="keyword">import</span> com.kob.backend.pojo.User;</span><br><span class="line"><span class="keyword">import</span> com.kob.backend.service.impl.utils.UserDetailsImpl;</span><br><span class="line"><span class="keyword">import</span> com.kob.backend.utils.JwtUtil;</span><br><span class="line"><span class="keyword">import</span> io.jsonwebtoken.Claims;</span><br><span class="line"><span class="keyword">import</span> org.jetbrains.annotations.NotNull;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.UsernamePasswordAuthenticationToken;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.core.context.SecurityContextHolder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.stereotype.Component;</span><br><span class="line"><span class="keyword">import</span> org.springframework.util.StringUtils;</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.filter.OncePerRequestFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JwtAuthenticationTokenFilter</span> <span class="keyword">extends</span> <span class="title class_">OncePerRequestFilter</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doFilterInternal</span><span class="params">(HttpServletRequest request, <span class="meta">@NotNull</span> HttpServletResponse response, <span class="meta">@NotNull</span> FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">token</span> <span class="operator">=</span> request.getHeader(<span class="string">&quot;Authorization&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!StringUtils.hasText(token) || !token.startsWith(<span class="string">&quot;Bearer &quot;</span>)) &#123;</span><br><span class="line">            filterChain.doFilter(request, response);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        token = token.substring(<span class="number">7</span>);</span><br><span class="line"></span><br><span class="line">        String userid;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Claims</span> <span class="variable">claims</span> <span class="operator">=</span> JwtUtil.parseJWT(token);</span><br><span class="line">            userid = claims.getSubject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> userMapper.selectById(Integer.parseInt(userid));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (user == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;用户名未登录&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">UserDetailsImpl</span> <span class="variable">loginUser</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UserDetailsImpl</span>(user);</span><br><span class="line">        <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(loginUser, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        SecurityContextHolder.getContext().setAuthentication(authenticationToken);</span><br><span class="line"></span><br><span class="line">        filterChain.doFilter(request, response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置<code>config.SecurityConfig</code>类，放行登录、注册等接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.kob.backend.config.filter.JwtAuthenticationTokenFilter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.http.HttpMethod;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.authentication.AuthenticationManager;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.builders.HttpSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.config.http.SessionCreationPolicy;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.crypto.password.PasswordEncoder;</span><br><span class="line"><span class="keyword">import</span> org.springframework.security.web.authentication.UsernamePasswordAuthenticationFilter;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableWebSecurity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SecurityConfig</span> <span class="keyword">extends</span> <span class="title class_">WebSecurityConfigurerAdapter</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> JwtAuthenticationTokenFilter jwtAuthenticationTokenFilter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> PasswordEncoder <span class="title function_">passwordEncoder</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">BCryptPasswordEncoder</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> AuthenticationManager <span class="title function_">authenticationManagerBean</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.authenticationManagerBean();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">configure</span><span class="params">(HttpSecurity http)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        http.csrf().disable()</span><br><span class="line">                .sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS)</span><br><span class="line">                .and()</span><br><span class="line">                .authorizeRequests()</span><br><span class="line">                .antMatchers(<span class="string">&quot;/user/account/token/&quot;</span>, <span class="string">&quot;/user/account/register/&quot;</span>).permitAll()</span><br><span class="line">                .antMatchers(HttpMethod.OPTIONS).permitAll()</span><br><span class="line">                .anyRequest().authenticated();</span><br><span class="line"></span><br><span class="line">        http.addFilterBefore(jwtAuthenticationTokenFilter, UsernamePasswordAuthenticationFilter.class);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>也就是对于登录和注册的URL，变为公开可以访问：（未来需要放行其他URL，也在这个地方继续添加即可）</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220727151311053-165918743918556.png" alt="image-20220727151311053"></p>
</li>
</ul>
<h2 id="后端API实现"><a href="#后端API实现" class="headerlink" title="后端API实现"></a>后端API实现</h2><p>在具体的API实现之前，先来更新下数据库。将数据库中的id域变为自增</p>
<ul>
<li><p>在数据库中将id列变为自增</p>
<img src="/images/配置MySQL与注册登录模块/image-20220727151452235-165918743918557.png" alt="image-20220727151452235" style="zoom:80%;" />
</li>
<li><p>在<code>pojo.User</code>类中添加注解：<code>@TableId(type = IdType.AUTO)</code></p>
<img src="/images/配置MySQL与注册登录模块/image-20220727152146421-165918743918558.png" alt="image-20220727152146421" style="zoom:80%;" /></li>
</ul>
<p>下面是具体的API编写。在Springboot中实现API一共需要实现三个地方：</p>
<ul>
<li><code>controller</code></li>
<li><code>service</code></li>
<li><code>service.impl</code></li>
</ul>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220727153732362-165918743918559.png" alt="image-20220727153732362"></p>
<h3 id="sevice"><a href="#sevice" class="headerlink" title="sevice"></a><code>sevice</code></h3><p>在<code>sevice</code>中写接口</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220727153812288-165918743918560.png" alt="image-20220727153812288"></p>
<p><code>RegisterService</code></p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220727154116631-165918743918561.png" alt="image-20220727154116631"></p>
<p><code>LoginService</code></p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220727160515837-165918743918562.png" alt="image-20220727160515837"></p>
<p><code>InfoService</code></p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220727154316612-165918743918563.png" alt="image-20220727154316612"></p>
<h3 id="service-impl"><a href="#service-impl" class="headerlink" title="service.impl"></a><code>service.impl</code></h3><p>在<code>service.impl</code>实现接口</p>
<h4 id="LoginServiceImpl"><a href="#LoginServiceImpl" class="headerlink" title="LoginServiceImpl"></a><code>LoginServiceImpl</code></h4><p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220727155907368-165918743918564.png" alt="image-20220727155907368"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">LoginService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> AuthenticationManager authenticationManager;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">getToken</span><span class="params">(String username, String password)</span> &#123;</span><br><span class="line">        <span class="comment">//封装用户名和密码 存放的是加密之后的密码</span></span><br><span class="line">        <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authenticationToken</span> <span class="operator">=</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">UsernamePasswordAuthenticationToken</span>(username, password);</span><br><span class="line">        <span class="comment">//验证是否可以正常登录</span></span><br><span class="line">        <span class="comment">//登录失败会自动处理</span></span><br><span class="line">        <span class="type">Authentication</span> <span class="variable">authenticate</span> <span class="operator">=</span></span><br><span class="line">                authenticationManager.authenticate(authenticationToken);</span><br><span class="line">        <span class="comment">//取出用户</span></span><br><span class="line">        <span class="type">UserDetailsImpl</span> <span class="variable">loginUser</span> <span class="operator">=</span> (UserDetailsImpl) authenticate.getPrincipal();</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> loginUser.getUser();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将用户的user id封装成jwt-token</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">jwt</span> <span class="operator">=</span> JwtUtil.createJWT(user.getId().toString());</span><br><span class="line"></span><br><span class="line">        <span class="comment">//定义返回结果格式</span></span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;success&quot;</span>);</span><br><span class="line">        map.put(<span class="string">&quot;token&quot;</span>,jwt);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="InfoServiceImpl"><a href="#InfoServiceImpl" class="headerlink" title="InfoServiceImpl"></a><code>InfoServiceImpl</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InfoServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">InfoService</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">getinfo</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//如果授权成功 则从上下文中将User信息提取出来</span></span><br><span class="line">        <span class="type">UsernamePasswordAuthenticationToken</span> <span class="variable">authentication</span> <span class="operator">=</span></span><br><span class="line">                (UsernamePasswordAuthenticationToken) SecurityContextHolder.getContext().getAuthentication();</span><br><span class="line">        <span class="type">UserDetailsImpl</span> <span class="variable">loginUser</span> <span class="operator">=</span> (UserDetailsImpl) authentication.getPrincipal();</span><br><span class="line"></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> loginUser.getUser();</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="string">&quot;error_message&quot;</span>, <span class="string">&quot;success&quot;</span>);</span><br><span class="line">        map.put(<span class="string">&quot;id&quot;</span>, user.getId().toString());</span><br><span class="line">        map.put(<span class="string">&quot;username&quot;</span>, user.getUsername());</span><br><span class="line">        map.put(<span class="string">&quot;photo&quot;</span>, user.getPhoto());</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="RegisterServiceImpl"><a href="#RegisterServiceImpl" class="headerlink" title="RegisterServiceImpl"></a><code>RegisterServiceImpl</code></h4><p>主要是加入了一些规则判断，若不符合规则，返回相应的错误信息，若符合规则，则在数据库中添加一个新的User并且将成功的信息返回。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RegisterServiceImpl</span> <span class="keyword">implements</span> <span class="title class_">RegisterService</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> UserMapper userMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PasswordEncoder passwordEncoder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">register</span><span class="params">(String username, String password, String confirmedPassword)</span> &#123;</span><br><span class="line">        Map&lt;String, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span>(username == <span class="literal">null</span>)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;error_message&quot;</span>, <span class="string">&quot;用户名不能为空&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(password == <span class="literal">null</span> || confirmedPassword == <span class="literal">null</span>)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;密码不能为空&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        username = username.trim();<span class="comment">//trim() 方法用于删除字符串的头尾空白符</span></span><br><span class="line">        <span class="keyword">if</span>(username.length() == <span class="number">0</span>)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;用户名不能为空&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(password.length() == <span class="number">0</span> || confirmedPassword.length() == <span class="number">0</span>)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;密码不能为空&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(username.length() &gt; <span class="number">100</span>)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;用户名长度过长&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(password.length() &gt; <span class="number">100</span> || confirmedPassword.length() &gt; <span class="number">100</span>)&#123;</span><br><span class="line">            map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;密码长度过长&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!password.equals(confirmedPassword))&#123;</span><br><span class="line">            map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;两次输入的密码不一致&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//查询用户是否已经存在 如果存在则不允许注册</span></span><br><span class="line">        QueryWrapper&lt;User&gt; queryWrapper = <span class="keyword">new</span> <span class="title class_">QueryWrapper</span>&lt;&gt;();</span><br><span class="line">        queryWrapper.eq(<span class="string">&quot;username&quot;</span>,username);</span><br><span class="line">        List&lt;User&gt; users = userMapper.selectList(queryWrapper);</span><br><span class="line">        <span class="keyword">if</span>(!users.isEmpty())&#123;</span><br><span class="line">            map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;用户名已存在&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> map;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//满足以上的条件 添加新用户</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">encodedPassword</span> <span class="operator">=</span> passwordEncoder.encode(password);</span><br><span class="line">        <span class="type">String</span> <span class="variable">photo</span> <span class="operator">=</span> <span class="string">&quot;https://cdn.acwing.com/media/user/profile/photo/118942_lg_ff1a85241e.jpg&quot;</span>;</span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>(<span class="literal">null</span>, username, encodedPassword, photo);</span><br><span class="line">        userMapper.insert(user);</span><br><span class="line">        map.put(<span class="string">&quot;error_message&quot;</span>,<span class="string">&quot;success&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> map;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="controller"><a href="#controller" class="headerlink" title="controller"></a><code>controller</code></h3><p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728093037903-165918743918565.png" alt="image-20220728093037903"></p>
<h4 id="LoginController"><a href="#LoginController" class="headerlink" title="LoginController"></a><code>LoginController</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LoginController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> LoginService loginService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/user/account/token/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">getToken</span><span class="params">(<span class="meta">@RequestParam</span> Map&lt;String,String&gt; map)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> map.get(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> map.get(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> loginService.getToken(username, password);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注意，对于登录而言，一般是<code>post</code>请求，如果是<code>get</code>请求，会将用户名和密码参数放在<code>url</code>链接中，明文传输，而<code>post</code>请求看不到明文，所以使用<code>@PostMapping</code>注解；</p>
<p>将<code>post</code>请求中的参数，放在<code>Map</code>中，需要用到注解<code>@RequestParam</code></p>
<p>如何调试这段代码的功能呢？</p>
<p>由于是Post请求，所以没法从浏览器输入URL的方式进行访问，因为浏览器中对应的Get请求，不能在浏览器中调试。有两种调试方法</p>
<p>1）前端框架中调试</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728094451442-165918743918566.png" alt="image-20220728094451442"></p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728094508871-165918743918567.png" alt="image-20220728094508871"></p>
<p>2）使用postman（更方便 推荐）</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728094618658-165918743918569.png" alt="image-20220728094618658"></p>
<p>对于返回的token</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiI5OWE5ZThjZDNlZDI0OTI3YTZiMWMzNDk5MDU1ZDljMyIsInN1YiI6IjEiLCJpc3MiOiJzZyIsImlhdCI6MTY1ODk3MjYzMCwiZXhwIjoxNjYwMTgyMjMwfQ.iioSQLuAyzpYLPzTgGuhs1ODb6mYIzpqnz6K8VQqbWc&quot;</span><br></pre></td></tr></table></figure>

<p>使用<a target="_blank" rel="noopener" href="https://jwt.io/%E4%B8%AD%E6%8F%90%E4%BE%9B%E7%9A%84%E5%B7%A5%E5%85%B7%E8%BF%9B%E8%A1%8C%E8%A7%A3%E6%9E%90%EF%BC%8C%E5%8F%AF%E4%BB%A5%E7%9C%8B%E5%87%BA%E5%AF%B9%E5%BA%94%E7%9A%84userID">https://jwt.io/中提供的工具进行解析，可以看出对应的userID</a></p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728094756371-165918743918568.png" alt="image-20220728094756371"></p>
<h4 id="InfoController"><a href="#InfoController" class="headerlink" title="InfoController"></a><code>InfoController</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InfoController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> InfoService infoService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping(&quot;/user/account/info/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">getinfo</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> infoService.getinfo();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一般而言，获取信息对应的get，修改，删除和添加对应的是post</p>
<p>调试：</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728101432315-165918743918570.png" alt="image-20220728101432315"></p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728101243101-165918743918571.png" alt="image-20220728101243101"></p>
<p>使用哪个用户的token，就可以生成哪个用户的信息。至此，我们实现了用户的登录和授权认证。</p>
<h4 id="RegisterController"><a href="#RegisterController" class="headerlink" title="RegisterController"></a><code>RegisterController</code></h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RegisterController</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RegisterService registerService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(&quot;/user/account/register/&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">register</span><span class="params">(<span class="meta">@RequestParam</span> Map &lt;String,String&gt; map)</span>&#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">username</span> <span class="operator">=</span> map.get(<span class="string">&quot;username&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">password</span> <span class="operator">=</span> map.get(<span class="string">&quot;password&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">confirmedPassword</span> <span class="operator">=</span> map.get(<span class="string">&quot;confirmedPassword&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> registerService.register(username,password,confirmedPassword);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>调试如下：</p>
<p>1）失败案例</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728150902475-165918743918572.png" alt="image-20220728150902475"></p>
<p>2）成功案例</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728151143060-165918743918573.png" alt="image-20220728151143060"></p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728151201956-165918743918574.png" alt="image-20220728151201956"></p>
<hr>
<p>到此为止，后端登录和注册模块的API就全部实现。</p>
<h2 id="登录界面"><a href="#登录界面" class="headerlink" title="登录界面"></a>登录界面</h2><h3 id="配置路由"><a href="#配置路由" class="headerlink" title="配置路由"></a>配置路由</h3><p>新增两个页面：</p>
<ul>
<li><code>src\views\user\account\UserAccountLoginView.vue</code></li>
<li><code>src\views\user\account\UserAccountRegisterView.vue</code></li>
</ul>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728152601740-165918743918575.png" alt="image-20220728152601740"></p>
<p>并在<code>src\router\index.js</code>中为其注册路由</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728152816374-165918743918576.png" alt="image-20220728152816374"></p>
<p>验证：</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728153110597-165918743918677.png" alt="image-20220728153110597"></p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728153118764-165918743918678.png" alt="image-20220728153118764"></p>
<h3 id="登录基本样式"><a href="#登录基本样式" class="headerlink" title="登录基本样式"></a>登录基本样式</h3><p>样式改造：</p>
<p>借助<code>bootstrap</code>中的<code>Grid system</code>，一个用户布局的工具。</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728153406815-165918743918679.png" alt="image-20220728153406815"></p>
<p><code>Grid</code>将每行分为 12 个模板列，允许您创建跨越任意数量列的不同元素组合。列类指示要跨越的模板列的数量（例如，<code>col-4</code>跨越四个）我们的登录窗口设置为跨越三个<code>col-3</code>，并设置为居中。</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728153904506-165918743918680.png" alt="image-20220728153904506"></p>
<p>效果如下：</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728193431171-165918743918681.png" alt="image-20220728193431171"></p>
<p>借助<code>bootstrap</code>中的<code>Form controls</code>，负责处理表单样式。</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728153926183-165918743918682.png" alt="image-20220728153926183"></p>
<p>此时还缺少一个登录按钮，用到<code>bootstrap</code>提供的<code>Buttons</code></p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728193905219-165918743918683.png" alt="image-20220728193905219"></p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;template&gt;</span><br><span class="line">    &lt;ContentFieldVue&gt;</span><br><span class="line">        &lt;div class=&quot;row  justify-content-md-center&quot;&gt;</span><br><span class="line">            &lt;div class=&quot;col-3&quot;&gt;</span><br><span class="line">                &lt;form&gt;</span><br><span class="line">                    &lt;div class=&quot;mb-3&quot;&gt;</span><br><span class="line">                        &lt;label for=&quot;username&quot; class=&quot;form-label&quot;&gt;用户名&lt;/label&gt;</span><br><span class="line">                        &lt;input type=&quot;text&quot; class=&quot;form-control&quot; id=&quot;username&quot; placeholder=&quot;请输入用户名&quot;&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                    &lt;div class=&quot;mb-3&quot;&gt;</span><br><span class="line">                        &lt;label for=&quot;password&quot; class=&quot;form-label&quot;&gt;密码&lt;/label&gt;</span><br><span class="line">                        &lt;input type=&quot;password&quot; class=&quot;form-control&quot; id=&quot;password&quot; placeholder=&quot;请输入密码&quot;&gt;</span><br><span class="line">                    &lt;/div&gt;</span><br><span class="line">                    &lt;div class=&quot;error-message&quot;&gt;&lt;/div&gt;</span><br><span class="line">                    &lt;button type=&quot;submit&quot; class=&quot;btn btn-primary&quot;&gt;登录&lt;/button&gt;</span><br><span class="line">                &lt;/form&gt;</span><br><span class="line">            &lt;/div&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/ContentFieldVue&gt;</span><br><span class="line">&lt;/template&gt;</span><br></pre></td></tr></table></figure>

<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728194554177-165918743918684.png" alt="image-20220728194554177"></p>
<h3 id="全局信息vuex"><a href="#全局信息vuex" class="headerlink" title="全局信息vuex"></a>全局信息vuex</h3><p>对于每个页面而言，都需要存储当前登录的用户信息，也就是需要将用户信息设置为全局存储。</p>
<p>需要用到<code>vue</code>的其中一个特性<code>vuex</code></p>
<p>创建<code>src\store\user.js</code></p>
<p>将用户信息<code>（id，username，is_login)</code>以及负责授权用的<code>jwt-token</code>保存在该文件中</p>
<img src="/images/配置MySQL与注册登录模块/image-20220728195310670-165918743918685.png" alt="image-20220728195310670" style="zoom:67%;" />

<p>并导入到全局<code>module</code>中</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728225232906-165918743918686.png" alt="image-20220728225232906"></p>
<p>然后在<code>action</code>中编写辅助函数，现在需要发生<code>login</code>请求并且获取token</p>
<img src="/images/配置MySQL与注册登录模块/image-20220728204314494-165918743918687.png" alt="image-20220728204314494" style="zoom:80%;" />

<h3 id="登录实现"><a href="#登录实现" class="headerlink" title="登录实现"></a>登录实现</h3><p>现在在登录的主页面<code>views\user\account\UserAccountLoginView.vue</code>负责实现登录功能。</p>
<p><code>UserAccountLoginView.vue</code></p>
<p><code>script</code>部分：</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728221012255-165918743918688.png" alt="image-20220728221012255"></p>
<p>其中：</p>
<ul>
<li>借助<code>ref</code>定义变量</li>
<li><code>router.push(&#123;name:&#39;home&#39;&#125;)</code>表示如果登录成功 跳转到name为home的页面中</li>
</ul>
<p><code>template</code>部分</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728221040989-165918743918689.png" alt="image-20220728221040989"></p>
<p>其中</p>
<ul>
<li><p><code>@submit.prevent=&quot;login&quot;</code>表示<code>submit</code>时触发<code>login</code>函数 并阻止默认行为</p>
</li>
<li><p><code>v-model</code>将输入的值，与<code>script</code>部分使用<code>ref</code>定义的变量绑定</p>
</li>
<li><p><code>&#123;&#123; error_message &#125;&#125;</code>表示直接取出变量<code>error_message </code>的值</p>
</li>
</ul>
<p>此时，实现了成功登录</p>
<p>如果输出错误：<img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728221459186-165918743918690.png" alt="image-20220728221459186"></p>
<p>如果输出正确：</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728221623853-165918743918691.png" alt="image-20220728221623853"></p>
<h3 id="动态显示信息"><a href="#动态显示信息" class="headerlink" title="动态显示信息"></a>动态显示信息</h3><p>在登录完成之后，我们希望在前端页面中，动态显示出用户信息（也就是用户名、头像、ID）。因此需要在登录成功之后，再次向后端发送请求来获取当前用户的用户信息。</p>
<p>因此需要在<code>src\store\user.js</code>中增加辅助函数</p>
<img src="/images/配置MySQL与注册登录模块/image-20220728225440474-165918743918692.png" alt="image-20220728225440474" style="zoom:80%;" />

<p>并更新<code>UserAccountLoginView.vue</code>如下：</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728225540736-165918743918693.png" alt="image-20220728225540736"></p>
<p>也就是登录成功之后，进行获取信息，如果获取成功，就在控制台输出相应的用户信息。</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728225643894-165918743918694.png" alt="image-20220728225643894"></p>
<p> 现在如何显示到导航栏上去呢？</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728225808191-165918743918695.png" alt="image-20220728225808191"></p>
<p>需要在<code>components\NavBar.vue</code>中修改下面代码：</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728234304235-165918743918696.png" alt="image-20220728234304235"></p>
<p>此时登录成功：</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728234319299-165918743918697.png" alt="image-20220728234319299"></p>
<blockquote>
<p>这里有一个bug，登录成功之后刷新页面变为未登录。此时的Jwt-token存放在浏览器的内存中，会因刷新而清空，需要将Jwt-token存放在浏览器的local Storage中，即使用户关闭或者刷新浏览器，都不会退出登录状态。</p>
<p>这个后面会给出解决方法，暂时按下不表。</p>
</blockquote>
<p>未登录：</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728234334252-165918743918698.png" alt="image-20220728234334252"></p>
<h3 id="退出logout"><a href="#退出logout" class="headerlink" title="退出logout"></a>退出logout</h3><p>用户登录之后如何退出呢？</p>
<p>对于整个认证机制，Jwt-token完全存在于用户本地。</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220728235323138-165918743918699.png" alt="image-20220728235323138"></p>
<p>Jwt-token中除了存放user Id之外，还存放一个过期时间，服务器验证的时候可以判断是否过期。</p>
<p>所以用户退出的逻辑很简单，那就是用户自己删掉Jwt-token，这件事前端就可以完成。</p>
<p>同样是在<code>src\store\user.js</code>中写入相关辅助函数</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220729000147004-1659187439186100.png" alt="image-20220729000147004"></p>
<p>然后在<code>src\components\NavBar.vue</code>中，添加一个退出的事件。</p>
<img src="/images/配置MySQL与注册登录模块/image-20220729001035097-1659187439186101.png" alt="image-20220729001035097" style="zoom:80%;" />

<p>在点击”退出”时触发<code>logout</code>函数，同时跳转到登录页面即可。</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220729001925441-1659187439186102.png" alt="image-20220729001925441"></p>
<h2 id="前端页面授权"><a href="#前端页面授权" class="headerlink" title="前端页面授权"></a>前端页面授权</h2><p>实现前端页面授权，也就是判断jwt-token不合法的时候，自动退出到登录界面。</p>
<p>可以在<code>src\router\index.js</code>实现</p>
<p>在<code>routes</code>中，为某一个<code>route</code>新增一个判断是否需要授权的信息，<code>true</code>表示需要授权才能访问。</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220729105021822-1659187439186103.png" alt="image-20220729105021822"></p>
<p>引入<code>store</code>，来判断用户是否登录</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> store <span class="keyword">from</span> <span class="string">&quot;../store/index&quot;</span></span><br></pre></td></tr></table></figure>

<p>同时增加<code>beforeEach</code>函数，则进入某个页面之前，执行该函数。</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220729105529808-1659187439186104.png" alt="image-20220729105529808"></p>
<p>这样就可以实现，在未登录时，访问<code>to.meta.requestAuth</code>为<code>true</code>的页面，会自动重定向到登录页面。登录之后，才能正常访问。</p>
<h2 id="注册页面"><a href="#注册页面" class="headerlink" title="注册页面"></a>注册页面</h2><p><code>views\user\account\UserAccountRegisterView.vue</code>，实现的逻辑与登录页面一致。</p>
<img src="/images/配置MySQL与注册登录模块/image-20220729145932746-1659187439186105.png" alt="image-20220729145932746" style="zoom:80%;" />

<img src="/images/配置MySQL与注册登录模块/image-20220729145950110-1659187439186106.png" alt="image-20220729145950110" style="zoom:80%;" />

<p>注意：</p>
<p>注册阶段的<code>ajax</code>请求直接放在了<code>UserAccountRegisterView.vue</code></p>
<p>而登录阶段的<code>ajax</code>请求则是：</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220729150937884-1659187439186107.png" alt="image-20220729150937884"></p>
<p>之所以会将操作放到<code>user.js</code>中，原因是需要修改<code>store.state</code>值</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220729151138473-1659187439186108.png" alt="image-20220729151138473"></p>
<p>区分一个概念：<code>store.state</code>和<code>store.state.user</code></p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220729151958681-1659187439186109.png" alt="image-20220729151958681"></p>
<p>打印<code>store.state</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;user&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zhou&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiIzZDVlM2RmY2FmMWY0ZDJmYmNjZmYyZjc4MTI4ZjhmMSIsInN1YiI6IjciLCJpc3MiOiJzZyIsImlhdCI6MTY1OTA3ODc2NywiZXhwIjoxNjYwMjg4MzY3fQ.3xPS9Ahls8VBNIYb_FhD7Gn_mDCTOWTK7y-8DwKmEXA&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;is_login&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;photo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://cdn.acwing.com/media/user/profile/photo/118942_lg_ff1a85241e.jpg&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>打印<code>store.state.user</code></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="string">&quot;7&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;username&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zhou&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;token&quot;</span><span class="punctuation">:</span> <span class="string">&quot;eyJhbGciOiJIUzI1NiJ9.eyJqdGkiOiIzZDVlM2RmY2FmMWY0ZDJmYmNjZmYyZjc4MTI4ZjhmMSIsInN1YiI6IjciLCJpc3MiOiJzZyIsImlhdCI6MTY1OTA3ODc2NywiZXhwIjoxNjYwMjg4MzY3fQ.3xPS9Ahls8VBNIYb_FhD7Gn_mDCTOWTK7y-8DwKmEXA&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;is_login&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;photo&quot;</span><span class="punctuation">:</span> <span class="string">&quot;https://cdn.acwing.com/media/user/profile/photo/118942_lg_ff1a85241e.jpg&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="登录状态持久化"><a href="#登录状态持久化" class="headerlink" title="登录状态持久化"></a>登录状态持久化</h2><p>对于前面提到的bug，也就是登录成功之后刷新页面变为未登录。此时的Jwt-token存放在浏览器的内存中，具体来说是存储在<code>store.state.user</code>中的<code>token</code>变量中，会因刷新而清空，需要将Jwt-token存放在浏览器的<code>local Storage</code>中，即使用户关闭或者刷新浏览器，都不会退出登录状态。</p>
<p>1、在登录成功时，存储到<code>local Storage</code>中，在退出时，从<code>local Storage</code>中删除</p>
<p><code>store\user.js</code></p>
<img src="/images/配置MySQL与注册登录模块/image-20220729153126905-1659187439186110.png" alt="image-20220729153126905" style="zoom:70%;" />

<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220729153138844-1659187439186111.png" alt="image-20220729153138844"></p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220729153305180-1659187439186112.png" alt="image-20220729153305180"></p>
<p>2、每次刷新页面时，变为未登录状态，经过<code>router\index.js</code>写入的逻辑，会重定向到登录页面</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220729155615022-1659187439186113.png" alt="image-20220729155615022"></p>
<p>然后我们添加相关的判断逻辑，在每次刷新页面时进入到登录页面之后，先判断<code>local Storage</code>是否有<code>jwt-token</code>，如果存在，将<code>jwt-token</code>取出验证是否有效，如果有效，则不需要重新登录，跳转到首页（home）即可</p>
<p><code>views\user\account\UserAccountLoginView.vue</code></p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220729160513255-1659187439186114.png" alt="image-20220729160513255"></p>
<p>此时可以初步实现效果。只不过还有瑕疵。也就是刷新之后：由于经过—–&gt;登录页面—–&gt;首页。因此，登录页面会一闪而过，有一种”白影”效果。可以先让登录页面默认不展示，在判断结束之后再展示。</p>
<p>3、处理“白影”</p>
<p>新增一个变量<code>pulling_info</code>表示当前是否正在从服务器获取信息中，如果正在拉取信息，则不展示登录页面</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220729163532450-1659187439186115.png" alt="image-20220729163532450"></p>
<p><code>pulling_info</code>为<code>ture</code>表示正在拉取信息，为<code>false</code>表示已经拉取完毕</p>
<p>当拉取信息结束之后，再显示对应的页面</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220729163206283-1659187439186116.png" alt="image-20220729163206283"></p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220729163221461-1659187439186117.png" alt="image-20220729163221461"></p>
<p>当判断完<code>jwt-token</code>是否存在和有效后，更新<code>pulling_info</code>为<code>false</code>，表示拉取结束。</p>
<p>注意：当验证有效时，先进行的跳转页面，再进行的更新<code>pulling_info</code>，所以看不到“白影”</p>
<p><img src="/images/%E9%85%8D%E7%BD%AEMySQL%E4%B8%8E%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/image-20220729163707686-1659187439186118.png" alt="image-20220729163707686"></p>
<p>至此，登录和注册模块完成！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2025/01/24/Springboot-%E9%85%8D%E7%BD%AEMySQL%E5%92%8C%E6%B3%A8%E5%86%8C%E7%99%BB%E5%BD%95%E6%A8%A1%E5%9D%97/" data-id="cm8sja97f001x8ktb98j48a9e" data-title="Springboot-配置MySQL和注册登录模块" class="article-share-link"><span class="fa fa-share">分享</span></a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Springboot/" rel="tag">Springboot</a></li></ul>

    </footer>
  </div>
  
</article>



  


  <nav id="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/2/">下一页 &raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">分类</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/JavaScript/">JavaScript</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Shell%E8%84%9A%E6%9C%AC/">Shell脚本</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Unity3D/">Unity3D</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Unreal-Engine/">Unreal Engine</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web/">Web</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%AE%97%E6%B3%95/">算法</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">设计模式</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Docker/" rel="tag">Docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/JavaScript/" rel="tag">JavaScript</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Shell/" rel="tag">Shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Springboot/" rel="tag">Springboot</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unity3D/" rel="tag">Unity3D</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Unreal-Engine/" rel="tag">Unreal Engine</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Vue/" rel="tag">Vue</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Web/" rel="tag">Web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E7%AE%97%E6%B3%95/" rel="tag">算法</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" rel="tag">设计模式</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/Docker/" style="font-size: 16px;">Docker</a> <a href="/tags/JavaScript/" style="font-size: 18px;">JavaScript</a> <a href="/tags/Linux/" style="font-size: 16px;">Linux</a> <a href="/tags/Shell/" style="font-size: 10px;">Shell</a> <a href="/tags/Springboot/" style="font-size: 18px;">Springboot</a> <a href="/tags/Unity3D/" style="font-size: 14px;">Unity3D</a> <a href="/tags/Unreal-Engine/" style="font-size: 12px;">Unreal Engine</a> <a href="/tags/Vue/" style="font-size: 12px;">Vue</a> <a href="/tags/Web/" style="font-size: 14px;">Web</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/%E7%AE%97%E6%B3%95/" style="font-size: 18px;">算法</a> <a href="/tags/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" style="font-size: 20px;">设计模式</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/03/">三月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2025/01/">一月 2025</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2024/12/">十二月 2024</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2025/03/28/WebSocket/">WebSocket</a>
          </li>
        
          <li>
            <a href="/2025/03/15/Docker%E5%AE%89%E8%A3%85/">Docker安装</a>
          </li>
        
          <li>
            <a href="/2025/03/15/Docker%E9%A1%B9%E7%9B%AE%E9%83%A8%E7%BD%B2/">Docker项目部署</a>
          </li>
        
          <li>
            <a href="/2025/03/15/Docker%E5%9F%BA%E7%A1%80/">Docker基础</a>
          </li>
        
          <li>
            <a href="/2025/03/15/Docker%E5%BF%AB%E9%80%9F%E5%85%A5%E9%97%A8/">Docker快速入门</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2025 Lzh<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.6.4.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>